console.time("load"),(()=>{const e=require("@gotoeasy/file"),t=require("@gotoeasy/btf"),o=require("@gotoeasy/bus"),r=(require("@gotoeasy/util"),require("@gotoeasy/err"),require("@gotoeasy/npm"));require("path");o.on("编译环境",function(o){return function(n){if(o)return o;if(!(o=function(o){let n=process.cwd().replace(/\\/g,"/"),s=n;if(o=e.resolve(s,o),!e.exists(o))return;let i={path:{}},a=new t(o),l=a.getMap("path");l.forEach((e,t)=>l.set(t,e.split("//")[0].trim()));let u={};return a.getMap("taglib").forEach((e,t)=>u[t]=e.split("//")[0].trim()),i.imports=u,i.path.cwd=n,i.path.root=s,i.path.src=s+"/src",i.path.build=function(e,t,o,r){return t.get(o)?e+"/"+t.get(o).split("/").filter(e=>!!e).join("/"):e+"/"+r.split("/").filter(e=>!!e).join("/")}(s,l,"build","build"),i.path.build_temp=i.path.build+"/temp",i.path.build_dist=i.path.build+"/dist",i.path.build_dist_images=l.get("build_dist_images")||"images",i.theme=null!=a.getText("theme")&&a.getText("theme").trim()?a.getText("theme").trim():"@gotoeasy/theme",i.prerender=null!=a.getText("prerender")&&a.getText("prerender").trim()?a.getText("prerender").trim():"@gotoeasy/pre-render",function(...t){let o=["@gotoeasy/theme","@gotoeasy/pre-render"],n=[...require("find-node-modules")({cwd:__dirname,relative:!1}),...require("find-node-modules")({cwd:process.cwd(),relative:!1})];for(let s,i=0;s=t[i++];){if(o.includes(s))continue;let t=!1;for(let o,r=0;o=n[r++];)e.isDirectoryExists(e.resolve(o,s))&&(t=!0);!t&&r.install(s)}}(i.theme,i.prerender),i}("rpose.config.btf"))){let e=process.cwd().replace(/\\/g,"/");o={path:{cwd:e,root:e,src:e+"/src",build:e+"/build",build_temp:e+"/build/temp",build_dist:e+"/build/dist"},theme:"@gotoeasy/theme",prerender:"@gotoeasy/pre-render"}}o.clean=!!n.clean,o.release=!!n.release,o.debug=!!n.debug,o.nocache=!!n.nocache,o.build=!!n.build,o.watch=!!n.watch;let s=e.resolve(__dirname,"./package.json");return!e.existsFile(s)&&(s=e.resolve(__dirname,"../package.json")),o.compilerVersion=JSON.parse(e.read(s)).version,o}}())})(),(()=>{const e=require("@gotoeasy/err"),t=require("@gotoeasy/file"),o=require("@gotoeasy/bus");o.on("clean",()=>{try{let r=o.at("编译环境");r.clean&&(t.remove(r.path.build),console.info("clean:",r.path.build)),t.mkdir(r.path.build_dist)}catch(t){throw e.cat(" clean failed",t)}})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/os"),require("@gotoeasy/file");module.exports=e.on("缓存目录",function(){return(e.at("编译环境").path.cwd+"/.cache/"+e.at("编译环境").compilerVersion).replace(/\\/g,"/")})})(),(()=>{const e=require("@gotoeasy/bus");!function(t={}){e.on("组件编译缓存",function(e,o){return o?(t[e]=o,o):void 0===o?t[e]:void delete t[e]})}()})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/os"),require("@gotoeasy/hash")),o=require("@gotoeasy/file");function r(e){let t=o.name(e);if(!/[^a-zA-Z0-9_\-]/.test(t)&&/^[a-zA-Z]/.test(t))return t.toLowerCase()}function n(t,r){let n=e.at("页面目标HTML文件名",t),s=e.at("页面目标CSS文件名",t),i=e.at("页面目标JS文件名",t);o.existsFile(n)&&(o.write(n,function(e=""){return`<!doctype html><html lang="en"><head><meta charset="utf-8"></head><body>Page build failed or src file removed<p/>\n        <pre style="background:#333;color:#ddd;padding:10px;">${e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre>\n    </body>`}(r)),o.remove(s),o.remove(i))}!function(s,i={}){function a(e,r){let n=o.read(e);return{file:e,text:n,hashcode:t(n),tag:r}}function l(t){if(!t)return[];let o=[];for(let r in s){let n=e.at("组件编译缓存",r);if(n){(n.result.allreferences||[]).includes(t)&&o.push(r)}}return o}e.on("标签项目源文件",function(e){let t=i[e];if(t&&t.length)return t[0]}),e.on("源文件对象清单",function(){if(!s){s={};let t=e.at("编译环境");o.files(t.path.src,"**.rpose").forEach(e=>{let t=r(e);if(t){let o=i[t]=i[t]||[];o.push(e),1===o.length&&(s[e]=a(e,t))}else console.error("[src-file-manager]","ignore invalid source file ..........",e)});for(let e in i){let t=i[e];if(t.length>1){console.error("[src-file-manager]","duplicate tag name:",e),console.error(t);for(let e,o=1;e=t[o++];)console.error("  ignore ..........",e)}}}return s}),e.on("源文件添加",function(t){let o=r(t.file);if(!o)return console.error("[src-file-manager]","invalid source file name ..........",t.file);let n=i[o]=i[o]||[];return n.push(t.file),n.length>1?(console.error("[src-file-manager]","duplicate tag name:",o),console.error(n),void console.error("  ignore ..........",t.file)):(s[t.file]=a(t.file,o),e.at("全部编译"))}),e.on("源文件修改",function(t){let o=r(t.file),i=l(o),a=s[t.file];if(o&&a){if(a.hashcode!==t.hashcode)return s[a.file]=Object.assign({},t),i.forEach(t=>{e.at("组件编译缓存",t,!1),n(t,`rebuilding for component [${o}] changed`)}),e.at("组件编译缓存",a.file,!1),e.at("全部编译")}else delete s[t.file]}),e.on("源文件删除",function(t){let o=r(t),u=l(o),c=s[t],p=i[o];if(delete s[t],p){let r=p.indexOf(t);if(r>0)return p.splice(r,1);0===r&&(p.splice(r,1),p.length?(s[p[0]]=a(p[0],o),e.at("组件编译缓存",p[0],!1)):delete i[o])}if(o&&c)return u.forEach(t=>{e.at("组件编译缓存",t,!1),n(t,`rebuilding for component [${o}] removed`)}),e.at("组件编译缓存",c.file,!1),e.at("全部编译")})}()})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/os"),require("@gotoeasy/file")),o=require("@gotoeasy/err"),r=require("@gotoeasy/hash"),n=require("chokidar");async function s(t,r){console.time("build");let n=e.at(t,r);if(n)for(let e,t=0;e=n[t++];)try{await e}catch(e){console.error(o.cat("build failed",e).toString())}console.timeEnd("build")}function i(e){let o=t.name(e);return!(/[^a-zA-Z0-9_\-]/.test(o)||!/^[a-zA-Z]/.test(o))}e.on("文件监视",function(o={}){return function(){let a,l=e.at("编译环境");l.watch&&(e.at("热刷新服务器"),n.watch(l.path.src).on("add",async e=>{if(a&&(e=e.replace(/\\/g,"/"))&&/\.rpose$/i.test(e))if(i(e)){console.info("add ......",e);let n=t.read(e),i={file:e,text:n,hashcode:r(n)};o[e]=i,await s("源文件添加",i)}else console.info("ignored ...... add",e)}).on("change",async e=>{if(a&&(e=e.replace(/\\/g,"/"))&&/\.rpose$/i.test(e))if(i(e)){let n=t.read(e),i=r(n);if(!o[e]||o[e].hashcode!==i){console.info("change ......",e);let t={file:e,text:n,hashcode:i};o[e]=t,await s("源文件修改",t)}}else console.info("ignored ...... change",e)}).on("unlink",async e=>{a&&(e=e.replace(/\\/g,"/"))&&/\.rpose$/i.test(e)&&(i(e)?(console.info("del ......",e),delete o[e],await s("源文件删除",e)):console.info("ignored ...... del",e))}).on("ready",()=>{a=!0}))}}())})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/os"),require("@gotoeasy/file");e.on("全部编译",function(t){let o,r,n=e.at("源文件对象清单"),s=e.at("编译环境"),i=[];for(let t in n){o=(new Date).getTime();let a=e.at("编译组件",n[t]);a.result.browserifyJs&&i.push(a.result.browserifyJs),(r=(new Date).getTime()-o)>100&&console.info("[compile] "+r+"ms -",t.replace(s.path.src+"/",""))}return i})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/file"),o=require("@gotoeasy/hash"),r=require("@gotoeasy/postobject");e.on("编译组件",function(n){let s;if(n.file)s=n;else{let r,i,a;if(r=e.at("标签源文件",n),!t.existsFile(r))throw new Err(`file not found: ${r} (${n})`);s={file:r,text:i=t.read(r),hashcode:a=o(i)}}let i=e.at("编译环境"),a=e.at("组件编译缓存",s.file);if(a&&a.input.hashcode!==s.hashcode&&(a=e.at("组件编译缓存",s.file,!1)),!a){let t=e.on("编译插件");return r(t).process({...s},{log:i.debug})}return a})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/file"),o=require("@gotoeasy/hash"),r=require("fs"),n=require("url"),s=require("path"),i=require("http"),a=require("opn"),l="rebuilding...";e.on("热刷新服务器",function(u){return function(){let c=e.at("编译环境");c.watch&&function(c,p){i.createServer(function(i,a){let p=n.parse(i.url);if(/^\/query$/i.test(p.pathname))return void function(r,n,s){u=!0;let i=e.at("编译环境"),a=s.query.split("&")[0].split("=")[1],c=t.resolve(i.path.src,a.substring(0,a.length-5)+".rpose"),p="";if(t.existsFile(c)){let r=e.at("组件编译缓存",c);if(r&&(p=r.result.hashcode||""),!p){let r=e.at("页面目标HTML文件名",c),n=e.at("页面目标CSS文件名",c),s=e.at("页面目标JS文件名",c);if(t.existsFile(r)){let e=t.read(r);if(e.indexOf("<body>Page build failed or src file removed<p/>")>0)p=l;else{let r=t.existsFile(n)?t.read(n):"",i=t.existsFile(s)?t.read(s):"";p=o(e+r+i)}}}}n.writeHead(200),n.end(p)}(0,a,p);let f=s.join(c,p.pathname).replace(/\\/g,"/");t.existsDir(f)&&(f=t.resolve(f,"index.html")),/\.html$/i.test(f)?t.existsFile(f)?function(r,n,s,i){let a=e.at("编译环境"),u=t.resolve(a.path.src,i.substring(a.path.build_dist.length+1,i.length-5)+".rpose"),c=e.at("组件编译缓存",u),p=c?c.result.hashcode||"":null;if(!p){let r=e.at("页面目标HTML文件名",u),n=e.at("页面目标CSS文件名",u),s=e.at("页面目标JS文件名",u);if(t.existsFile(r)){let e=t.read(r),i=t.existsFile(n)?t.read(n):"",a=t.existsFile(s)?t.read(s):"";p=o(e+i+a)}}let f=`\n        <script>\n            var _times_ = 0;\n            function refresh() {\n                let url = '/query?page=${i.substring(a.path.build_dist.length+1)}&t=' + new Date().getTime();\n                ajaxAsync(url, function(rs){\n                    if ( rs !== '${p}' ) {\n                        if ( rs === '${l}' ) {\n                            _times_++;\n                            _times_ >= 5 ? location.reload() : setTimeout(refresh, 1000);\n                        }else{\n                            location.reload();\n                        }\n                    }else{\n                        _times_ = 0;\n                        setTimeout(refresh, 1000);\n                    }\n                }, function(err){\n                    _times_ = 0;\n                    setTimeout(refresh, 1000);\n                });\n            }\n\n            function ajaxAsync(url, fnCallback, fnError) {\n                var xhr = new XMLHttpRequest();\n                xhr.onreadystatechange = function (xxx, eee) {\n                    if (xhr.readyState === 4 && xhr.status === 200) {\n                        fnCallback(xhr.responseText);\n                    }\n                };\n                xhr.onerror = fnError;\n                xhr.open("GET", url, true);\n                xhr.send();\n            }\n\n            setTimeout(refresh, 3000);\n        <\/script>`,g=t.read(i).replace(/<head>/i,"<head>"+f);n.writeHead(200,{"Content-Type":"text/html;charset=UFT8"}),n.end(g)}(0,a,0,f):(a.writeHead(404),a.end("404 Not Found")):t.existsFile(f)?(/\.css$/i.test(f)?a.writeHead(200,{"Content-Type":"text/css;charset=UFT8"}):a.writeHead(200),r.createReadStream(f).pipe(a)):/favicon\.ico$/i.test(f)?(a.writeHead(200),a.end(null)):(a.writeHead(404),a.end("404 Not Found"))}).listen(p);let f="http://localhost:"+p;console.log("-------------------------------------------"),console.log(` server ready ...... ${f}`),console.log("-------------------------------------------"),setTimeout(()=>{!u&&a(f)},1e3)}(c.path.build_dist,3700)}}())})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("b00p-log",function(e,t){}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("b01p-init-context",function(e,t){t.input={},t.doc={},t.style={},t.script={},t.keyCounter=1,t.result={},e.walk((e,o)=>{t.input.file=o.file,t.input.text=o.text,t.input.hashcode=o.hashcode},{readonly:!0})}))})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/postobject");function t(e){return e.startsWith("[")&&e.indexOf("]")>0}function o(e){return e.startsWith("---------")}function r(e){return e.startsWith("=========")}function n(e){let t,o;for(let r=1;r<e.length;r++)if("\\"!==e.charAt(r-1)&&"]"===e.charAt(r))return o=(t=e.substring(1,r).toLowerCase()).length,{name:t=t.replace(/\\\]/g,"]"),len:o};return o=(t=e.substring(1,e.lastIndexOf("]")).toLowerCase()).length,{name:t=t.replace(/\\\]/g,"]"),len:o}}function s(e,t){let o=0;for(let r=0;r<t;r++)o+=e[r];return o}e.on("项目配置文件解析",function(e,i=!0){let a=e.indexOf("\r\n")>=0?"\r\n":"\n",l=e.split(a),u=l.map(e=>e.length+a.length),c=[];return function(e,i,a,l){let u,c,p,f,g=!1;for(let l=0;l<i.length;l++)if(t(u=i[l])){c={type:"ProjectBtfBlock"},p=n(u),f=u.substring(p.len+2);let t=l+1,o=1,r=s(a,t-1),i={line:t,column:o,pos:r};o=p.len+3,r+=o-1,end={line:t,column:o,pos:r},c.name={type:"ProjectBtfBlockName",value:p.name,loc:{start:i,end}},f&&(o=p.len+3,i={line:t,column:o,pos:r},o=u.length+1,r=s(a,t-1)+o-1,end={line:t,column:o,pos:r},c.comment={type:"ProjectBtfBlockComment",value:f,loc:{start:i,end}}),c.buf=[],e.push(c),g=!0}else if(o(u))g=!1;else{if(r(u))return;if(g){let t=e[e.length-1].buf;"\\"===u.charAt(0)&&(/^\\+\[.*\]/.test(u)||/^\\+\---------/.test(u)||/^\\+\=========/.test(u))?t.push(u.substring(1)):t.push(u)}}}(c,l,u),c.forEach(e=>{if(e.buf.length){let t="ProjectBtfBlockText",o=e.buf.join(a),r=e.name.loc.start.line+1,n=1,i=s(u,r-1),l={line:r,column:n,pos:i};r=e.name.loc.start.line+e.buf.length,n=e.buf[e.buf.length-1].length+1,i=s(u,r-1)+n,1===n&&e.buf.length>1&&(r--,n=e.buf[e.buf.length-2].length+1),end={line:r,column:n,pos:i},e.text={type:t,value:o,loc:{start:l,end}}}delete e.buf,!1===i&&(delete e.name.loc,void 0!==e.comment&&delete e.comment.loc,void 0!==e.text&&delete e.text.loc)}),{nodes:c}})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/err"),require("@gotoeasy/file")),o=require("csslibify");e.on("样式库",function(r={}){return function(n="",s=""){let i,a=n.split("=");if(a.length>1&&!s?(s=a[1],n=a[0].trim()):n.indexOf(":")>0&&(s=n,n=""),!s){let e=r[n]||o(n);return e.name=n,e}let l,u=[];(i=s.match(/^.*?=(.*?):(.*)$/))?(l=i[1].trim(),cssfilter=i[2],cssfilter.replace(/;/g,",").split(",").forEach(e=>{(e=e.trim())&&u.push(e)})):(i=s.match(/^.*?=(.*)$/))?(l=i[1].trim(),u.push("**.min.css")):(i=s.match(/^(.*?):(.*)$/))?(l=i[1].trim(),cssfilter=i[2],cssfilter.replace(/;/g,",").split(",").forEach(e=>{(e=e.trim())&&u.push(e)})):(l=s.trim(),u.push("**.min.css")),l.lastIndexOf("@")>1&&(l=l.substring(0,l.lastIndexOf("@")));let c=function(o){e.at("自动安装",o);let r=[...require("find-node-modules")({cwd:process.cwd(),relative:!1}),...require("find-node-modules")({cwd:__dirname,relative:!1})];for(let e,n,s=0;e=r[s++];)if(n=t.resolve(e,o),t.existsDir(n))return n;throw new Error("path not found of npm package: "+o)}(l),p=t.files(c,...u),f=r[n]||o(n);return p.forEach(e=>f.imp(e)),n&&(r[n]=f),f.name=n,f}}()),e.on("样式库引用",function(t,...o){return e.at("样式库",t).get(...o)})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/postobject"),require("@gotoeasy/err"));e.on("解析[csslib]",function(e,o,r){let n={},s=(null==e?"":e.trim()).split("\n");for(let e,i=0;i<s.length;i++){let a,l,u=(e=s[i]).indexOf("=");if(!(u<0)){if(a=e.substring(0,u).trim(),(u=(l=e.substring(u+1).trim()).lastIndexOf("//"))>=0&&(l=l.substring(0,u).trim()),!a)throw new t("use * as empty csslib name. etc. * = "+l,{file:o.input.file,text:o.input.text,line:r.start.line+i,column:1});if(n[a])throw new t("duplicate csslib name: "+a,{file:o.input.file,text:o.input.text,line:r.start.line+i,column:1});n[a]=l}}return n})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/err"),require("@gotoeasy/file")),o=require("@gotoeasy/btf");require("csslibify");e.on("标签库定义",function(r={},n={}){let s=[];return e.on("标签库引用",function(t,o){let n,s=e.at("文件所在模块",o),i=t.indexOf("="),a=t.indexOf(":");return n=i<0&&a<0?t.trim():a>0?t.substring(a+1).trim():t.substring(0,i).trim(),r[s+":"+n]}),function(i,a){let l=e.at("normalize-taglib",i);!function(o){if(!n[o]){let s=e.at("模块组件信息",o);for(let e,o=0;e=s.files[o++];)r[s.name+":"+t.name(e)]=e;n[o]=!0}}(l.pkg);let u,c,p,f=e.at("文件所在模块",a);if(u=f+":"+l.astag,c=l.pkg+":"+l.tag,r[c])return r[u]=r[c],s=[],r;s.push(`[${f}] ${l.taglib}`);try{p=require.resolve(l.pkg+"/package.json",{paths:[e.at("编译环境").path.root,__dirname]})}catch(e){s.unshift(e.message);let t=s.join("\n => ");throw s=[],new Error(t)}let g=t.path(p)+"/rpose.config.btf";if(!t.existsFile(g)){s.unshift(`tag [${l.tag}] not found in package [${l.pkg}]`);let e=s.join("\n => ");throw s=[],new Error(e)}let d,h=new o(g).getText("taglib");try{d=e.at("解析[taglib]",h,{input:{file:g}})}catch(e){s.push(`[${l.pkg}] ${l.pkg}:${l.tag}`),s.push(g),s.unshift(e.message);let t=s.join("\n => ");throw s=[],new Error(t)}let b=d[l.tag];if(!b){s.push(g),s.unshift(`tag [${l.tag}] not found in package [${l.pkg}]`);let e=s.join("\n => ");throw s=[],new Error(e)}return e.at("自动安装",b.pkg),e.at("标签库定义",b.taglib,g)}}())})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/postobject"),require("@gotoeasy/err");e.on("normalize-taglib",function(e,t=0){let o,r,n,s;if(s=e.match(/^\s*([\S]+)\s*=\s*([\S]+)\s*:\s*([\S]+)\s*$/))o=s[1],r=s[2],n=s[3];else if(s=e.match(/^\s*([\S]+)\s*=\s*([\S]+)\s*$/))o=s[1],r=s[2],n=s[1];else{if(!(s=e.match(/^\s*([\S]+)\s*:\s*([\S]+)\s*$/)))return null;o=s[2],r=s[1],n=s[2]}return{line:t,astag:o,pkg:r,tag:n,taglib:o+"="+r+":"+n}})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/postobject"),require("@gotoeasy/err"));e.on("解析[taglib]",function(o,r,n){let s={},i=(null==o?"":o.trim()).split("\n");for(let o,a,l=0;l<i.length;l++)if(o=i[l].split("//")[0].trim()){if(!(a=e.at("normalize-taglib",o,l))){if(n)throw new t("invalid taglib: "+a.taglib,{file:r.input.file,text:r.input.text,line:n.start.line+l,column:1});throw new t(`invalid taglib: ${o}`)}if(/^(if|for)$/i.test(a.astag)){if(n)throw new t("can not use buildin tag name: "+a.astag,{file:r.input.file,text:r.input.text,line:n.start.line+l,column:1});throw new t("can not use buildin tag name: "+a.astag)}if(s[a.astag]){if(n)throw new t("duplicate tag name: "+a.astag,{file:r.input.file,text:r.input.text,line:n.start.line+l,column:1});throw new t("duplicate tag name: "+a.astag)}s[a.astag]=a}return s})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/file"),r=require("@gotoeasy/err");e.on("编译插件",t.plugin("b95p-init-project-config",function(t,o){o.project=e.at("项目配置处理",o.input.file)})),e.on("项目配置处理",function(r={}){return function(n){let s=n.endsWith("/rpose.config.btf")?n:e.at("文件所在项目配置文件",n);if(r[s])return r[s];if(!o.existsFile(s))return{};let i=e.on("项目配置处理插件"),a=t(i).process({file:s});return r[s]=a.result,r[s]}}()),e.on("项目配置处理插件",t.plugin("process-project-config-101",function(t,r){r.input={},r.result={},t.walk((t,n)=>{r.input.file=n.file,r.input.text=o.read(n.file);let s=e.at("项目配置文件解析",r.input.text),i=this.createNode(s);t.replaceWith(...i.nodes)}),t.walk((e,t)=>{if(!t.text||!t.text.value||!t.text.value.trim())return e.remove();let o=t.name.value,r=t.text.value,n=t.text.loc,s=this.createNode({type:o,value:r,loc:n});e.replaceWith(s)})})),e.on("项目配置处理插件",t.plugin("process-project-config-102",function(t,o){let r;if(e.on("哈希样式类名")[0],t.walk("csslib",(t,n)=>{r=e.at("解析[csslib]",n.value,o,n.loc),t.remove()}),!r)return;let n=o.result.oCsslib={};for(let t in r)n[t]=e.at("样式库",t,r[t])})),e.on("项目配置处理插件",function(o){return t.plugin("process-project-config-103",function(t,r){if(!o){let t="@rpose/buildin";if(!e.at("自动安装",t))throw new Error("package install failed: "+t);e.at("标签库定义","@rpose/buildin:```",""),e.at("标签库定义","@rpose/buildin:router",""),e.at("标签库定义","@rpose/buildin:router-link",""),o=!0}})}()),e.on("项目配置处理插件",function(o){return t.plugin("process-project-config-105",function(t,n){let s,i;if(t.walk("taglib",(t,o)=>{s=e.at("解析[taglib]",o.value,n,o.loc),i=o.loc.start.line,t.remove()}),n.result.oTaglib=s||{},!s)return;let a=new Map;for(let e in s)a.set(s[e].pkg,s[e]);a.forEach((t,o)=>{if(!e.at("自动安装",o))throw new r("package install failed: "+o,{file:n.input.file,text:n.input.text,line:i+t.line,column:1})});for(let t in s)try{e.at("标签库定义",s[t].taglib,n.input.file)}catch(e){throw new r.cat(e,{file:n.input.file,text:n.input.text,line:i+s[t].line,column:1})}if(!o){if(pkg="@rpose/buildin",!e.at("自动安装",pkg))throw new Error("package install failed: "+pkg);e.at("标签库定义","@rpose/buildin:```",""),e.at("标签库定义","@rpose/buildin:router",""),e.at("标签库定义","@rpose/buildin:router-link",""),o=!0}})}())})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/postobject");function t(e){return e.startsWith("[")&&e.indexOf("]")>0}function o(e){return e.startsWith("---------")}function r(e){return e.startsWith("=========")}function n(e){let t,o;for(let r=1;r<e.length;r++)if("\\"!==e.charAt(r-1)&&"]"===e.charAt(r))return o=(t=e.substring(1,r).toLowerCase()).length,{name:t=t.replace(/\\\]/g,"]"),len:o};return o=(t=e.substring(1,e.lastIndexOf("]")).toLowerCase()).length,{name:t=t.replace(/\\\]/g,"]"),len:o}}function s(e,t){let o=0;for(let r=0;r<t;r++)o+=e[r];return o}e.on("RPOSE源文件解析",function(e,i=!0){let a=e.indexOf("\r\n")>=0?"\r\n":"\n",l=e.split(a),u=l.map(e=>e.length+a.length),c=[];return function(e,i,a,l){let u,c,p,f,g=!1;for(let l=0;l<i.length;l++)if(t(u=i[l])){c={type:"RposeBlock"},p=n(u),f=u.substring(p.len+2);let t=l+1,o=1,r=s(a,t-1),i={line:t,column:o,pos:r};o=p.len+3,r+=o-1,end={line:t,column:o,pos:r},c.name={type:"RposeBlockName",value:p.name,loc:{start:i,end}},f&&(o=p.len+3,i={line:t,column:o,pos:r},o=u.length+1,r=s(a,t-1)+o-1,end={line:t,column:o,pos:r},c.comment={type:"RposeBlockComment",value:f,loc:{start:i,end}}),c.buf=[],e.push(c),g=!0}else if(o(u))g=!1;else{if(r(u))return;if(g){let t=e[e.length-1].buf;"\\"===u.charAt(0)&&(/^\\+\[.*\]/.test(u)||/^\\+\---------/.test(u)||/^\\+\=========/.test(u))?t.push(u.substring(1)):t.push(u)}}}(c,l,u),c.forEach(e=>{if(e.buf.length){let t="RposeBlockText",o=e.buf.join(a),r=e.name.loc.start.line+1,n=1,i=s(u,r-1),l={line:r,column:n,pos:i};r=e.name.loc.start.line+e.buf.length,n=e.buf[e.buf.length-1].length+1,i=s(u,r-1)+n,1===n&&e.buf.length>1&&(r--,n=e.buf[e.buf.length-2].length+1),end={line:r,column:n,pos:i},e.text={type:t,value:o,loc:{start:l,end}}}delete e.buf,!1===i&&(delete e.name.loc,void 0!==e.comment&&delete e.comment.loc,void 0!==e.text&&delete e.text.loc)}),{nodes:c}})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("c15p-parse-rpose-src-to-blocks",function(t,o){let r=o.result;t.walk((t,o)=>{r.tagpkg=e.at("标签全名",o.file);let n=e.at("RPOSE源文件解析",o.text),s=this.createNode(n);return t.replaceWith(...s.nodes),!1})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("c25p-blocks-to-context-doc",function(e,t){let o=t.doc;e.walk("RposeBlock",(e,t)=>{/^(api|options|state|mount)$/.test(t.name.value)&&(o[t.name.value]=t.text?t.text.value:"",e.remove())})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("c35p-normalize-context-doc",function(e,t){let o=t.doc;o.api=function(e){let t={};return(null==e?"":e.trim()).split("\n").forEach(e=>{let o,r,n=e.indexOf("=");n<0&&(n=e.indexOf(":")),n<0||(o=e.substring(0,n).trim(),(n=(r=e.substring(n+1).trim()).lastIndexOf("//"))>=0&&(r=r.substring(0,n).trim()),/^option[\-]?keys$/i.test(o)?(o="optionkeys",r=r.split(/[,;]/).map(e=>e.trim())):/^state[\-]?keys$/i.test(o)?(o="statekeys",r=r.split(/[,;]/).map(e=>e.trim())):/^pre[\-]?render$/i.test(o)&&(o="prerender"),t[o]=r)}),t}(o.api),o.mount&&(o.mount=o.mount.trim())}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("c45p-is-page",function(e,t){t.result.isPage=t.doc.mount&&!/\/components\//i.test(t.input.file)&&!/\/node_modules\//i.test(t.input.file)}))})(),(()=>{const e=require("@gotoeasy/err"),t=require("@gotoeasy/bus"),o=require("@gotoeasy/btf"),r=require("@gotoeasy/file");function n(t){let o=[...require("find-node-modules")({cwd:__dirname,relative:!1}),...require("find-node-modules")({relative:!1})];for(let e,n,s=0;e=o[s++];)if(n=e.replace(/\\/g,"/")+"/"+t+"/theme.btf",r.exists(n))return n;throw new e("theme file not found: "+t+"/theme.btf")}t.on("样式风格",function(i){return function(){let a=t.at("编译环境");try{let l;if(!i){if(a.theme){l=function t(r){if(s.has(r)){let t=[...s].push(r);throw e.cat(t,new e("theme circular extend"))}s.add(r);btf=new o(r);let i=(btf.getText("extend")||"").trim();let a;let l=btf.getMap("theme");i&&(a=t(n(i)),l.forEach((e,t)=>a.set(t,e)),l=a);return l}(function(){let o,s=t.at("编译环境");if(s.theme.endsWith(".btf")){if(r.exists(o))return o;if(o=r.resolve(s.path.root,s.theme),r.exists(o))return o;throw new e("theme file not found: "+o)}return n(s.theme)}())}else l=new Map;i={less:function(e){let t=[];return e.forEach((e,o)=>t.push("@"+o+" : "+e+";")),t.join("\n")+"\n"}(l),scss:function(e){let t=[];return e.forEach((e,o)=>t.push("$"+o+" : "+e+";")),t.join("\n")+"\n"}(l),css:function(e){if(!e.size)return"";let t=[];return t.push(":root{"),e.forEach((e,o)=>t.push("--"+o+" : "+e+";")),t.push("}"),t.join("\n")+"\n"}(l)}}return i}catch(t){throw e.cat("init theme failed: "+a.theme,t)}}}());const s=new Set})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/csjs"),r=require("@gotoeasy/file"),n=require("@gotoeasy/hash");e.on("编译插件",t.plugin("d15p-compile-component-scss",function(t,s){let i=s.style;t.walk("RposeBlock",(t,s)=>{if(/^scss$/.test(s.name.value)){let a=s.text?s.text.value:"";if(a){let t=e.at("样式风格");i.scss=function(t){let s=e.at("编译环境"),i=n(t),a=`${e.at("缓存目录")}/scss-to-css/${i}.css`;if(!s.nocache&&r.existsFile(a))return r.read(a);let l=o.scssToCss(t);return r.write(a,l),l}(t.scss+a)}return t.remove(),!1}})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/csjs"),r=require("@gotoeasy/file"),n=require("@gotoeasy/hash");e.on("编译插件",t.plugin("d25p-compile-component-less",function(t,s){let i=s.style;t.walk("RposeBlock",(t,s)=>{if(/^less$/.test(s.name.value)){let a=s.text?s.text.value:"";if(a){let t=e.at("样式风格");i.less=function(t){let s=e.at("编译环境"),i=n(t),a=`${e.at("缓存目录")}/less-to-css/${i}.css`;if(!s.nocache&&r.existsFile(a))return r.read(a);let l=o.lessToCss(t);return r.write(a,l),l}(t.less+a)}return t.remove(),!1}})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/file"),o=require("@gotoeasy/hash"),r=require("postcss");module.exports=e.on("样式统一化整理",(n,s,i,a)=>{let l=e.at("编译环境"),u=o(JSON.stringify([n,s,i,a])),c=`${e.at("缓存目录")}/normalize-css/${u}.css`;if(!l.nocache&&t.existsFile(c))return t.read(c);let p=s+"/from.css",f=i+"/to.css",g={url:"copy",from:p,to:f,basePath:s,assetsPath:a,useHash:!0,hashOptions:{method:e=>o({contents:e})}},d=[];d.push(require("postcss-import-sync")({from:p})),d.push(require("postcss-unprefix")()),d.push(require("postcss-url")(g)),d.push(require("postcss-nested")()),d.push(require("postcss-css-variables")()),d.push(require("postcss-discard-comments")({remove:e=>1})),d.push(require("postcss-minify-selectors")),d.push(require("postcss-minify-params")),d.push(require("postcss-normalize-string")),d.push(require("postcss-normalize-display-values")),d.push(require("postcss-normalize-positions")),d.push(require("postcss-normalize-repeat-style")),d.push(require("postcss-minify-font-values")),d.push(require("postcss-minify-gradients")),d.push(require("postcss-color-hex-alpha")),d.push(require("postcss-merge-longhand"));let h=r(d).process(n,{from:p,to:f}).sync().root.toResult();return t.write(c,h.css),h.css})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=(require("@gotoeasy/csjs"),require("@gotoeasy/file"));e.on("编译插件",t.plugin("d35p-normalize-component-css",function(t,r){let n=r.style;if(t.walk("RposeBlock",(t,o)=>{if(/^css$/.test(o.name.value)){let r=o.text?o.text.value:"";if(r){let t=e.at("样式风格");n.css=t.css+r}return t.remove(),!1}}),!n.css)return;e.at("编译环境");let s=o.path(r.input.file),i=e.at("缓存目录")+"/resources";n.css=e.at("样式统一化整理",n.css,s,i,".")}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=(require("@gotoeasy/csjs"),require("@gotoeasy/file")),r=require("@gotoeasy/hash"),n=require("@gotoeasy/err"),s=require("acorn"),i=require("astring");e.on("编译插件",t.plugin("d45p-normalize-component-actions",function(t,a){let l=a.script;t.walk("RposeBlock",(t,a)=>{if(!/^actions$/.test(a.name.value))return;let u=a.text?a.text.value.trim():"";if(u){let t=function(t,a){let l,u=r(t),c=`${e.at("缓存目录")}/normalize-actions/${u}.js`;return o.existsFile(c)?JSON.parse(o.read(c)):(l=t.startsWith("{")?function(e,t){let o,r=`this.$actions     = ${e}`;try{o=s.parse(r,{ecmaVersion:10,sourceType:"module",locations:!0})}catch(e){throw new n("syntax error in [actions]",e)}let a=[],l=o.body[0].expression.right.properties;l&&l.forEach(e=>{if("ArrowFunctionExpression"==e.value.type)a.push(e.key.name);else if("FunctionExpression"==e.value.type){let t=e.value;t.type="ArrowFunctionExpression",a.push(e.key.name)}});let u={src:"",names:a};return a.length&&(a.sort(),u.src=i.generate(o)),u}(t):function(e,t){let o;try{o=s.parse(e,{ecmaVersion:10,sourceType:"module",locations:!0})}catch(e){throw new n("syntax error in [actions]",e)}let r=new Map;o.body.forEach(e=>{let t;"FunctionDeclaration"==e.type?(e.type="ArrowFunctionExpression",r.set(e.id.name,i.generate(e))):"VariableDeclaration"==e.type?"FunctionDeclaration"!=(t=e.declarations[0].init).type&&"ArrowFunctionExpression"!=t.type||(t.type="ArrowFunctionExpression",r.set(e.declarations[0].id.name,i.generate(t))):"ExpressionStatement"==e.type&&("FunctionDeclaration"!=(t=e.expression.right).type&&"ArrowFunctionExpression"!=t.type||(t.type="ArrowFunctionExpression",r.set(e.expression.left.name,i.generate(t))))});let a=[...r.keys()],l={src:"",names:a};if(a.length){let e=[];e.push("this.$actions = {"),a.forEach(t=>{e.push('"'+t+'": '+r.get(t)+",")}),e.push("}"),l.src=e.join("\n")}return l}(t),o.write(c,JSON.stringify(l)),l)}(u,a.text.loc);l.actions=t.src,l.$actionkeys=t.names}return t.remove(),!1})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=(require("@gotoeasy/csjs"),require("@gotoeasy/file")),r=require("@gotoeasy/hash"),n=require("acorn"),s=require("astring");e.on("编译插件",t.plugin("d55p-normalize-component-methods",function(t,i){let a=i.script;t.walk("RposeBlock",(t,i)=>{if(!/^methods$/.test(i.name.value))return;let l=i.text?i.text.value.trim():"";if(l){let t=function(t,i){let a=r(t),l=`${e.at("缓存目录")}/normalize-methods/${a}.js`;if(o.existsFile(l))return JSON.parse(o.read(l));let u,c=`oFn               = ${t}`;try{u=n.parse(c,{ecmaVersion:10,sourceType:"module",locations:!0})}catch(e){throw new Err("syntax error in [methods]",e)}let p=new Map,f=u.body[0].expression.right.properties;f&&f.forEach(e=>{if("ArrowFunctionExpression"==e.value.type)p.set(e.key.name,"this."+e.key.name+"="+s.generate(e.value));else if("FunctionExpression"==e.value.type){let t=e.value;t.type="ArrowFunctionExpression",p.set(e.key.name,"this."+e.key.name+"="+s.generate(t))}});let g=[...p.keys()];g.sort();let d={src:"",names:g};return g.forEach(e=>d.src+=p.get(e)+"\n"),o.write(l,JSON.stringify(d)),d}(l,i.text.loc);a.methods=t.src}return t.remove(),!1})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=(require("@gotoeasy/csjs"),require("@gotoeasy/file"),require("@gotoeasy/hash"),require("acorn")),r=require("acorn-walk"),n=require("astring"),s=require("css-selector-tokenizer");function i(t,i){let a,l;try{a=o.parse(t,{ecmaVersion:10,sourceType:"module",locations:!1})}catch(e){throw new Err("syntax error",e)}return r.simple(a,{CallExpression(t){if(!t.arguments||"Literal"!==t.arguments[0].type)return;let o=t.callee.name||t.callee.property.name;/^(getElementsByClassName|querySelector|querySelectorAll|\$\$)$/.test(o)&&(t.arguments[0].value="getElementsByClassName"===o?e.at("哈希样式类名",i,t.arguments[0].value):function(t,o){let r=s.parse(t);return(r.nodes||[]).forEach(t=>{"selector"===t.type&&(t.nodes||[]).forEach(t=>{"class"===t.type&&(t.name=e.at("哈希样式类名",o,t.name))})}),s.stringify(r)}(t.arguments[0].value,i),t.arguments[0].raw=`'${t.arguments[0].value}'`,l=!0)}}),l?n.generate(a):t}e.on("编译插件",t.plugin("d65p-transform-component-script-selector",function(e,t){let o=t.script,r=/(\.getElementsByClassName\s*\(|\.querySelector\s*\(|\.querySelectorAll\s*\(|\$\$\s*\()/;o.actions&&r.test(o.actions)&&(o.actions=i(o.actions,t.input.file)),o.methods&&r.test(o.methods)&&(o.methods=i(o.methods,t.input.file))}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("d75p-init-component-[csslib]",function(t,r){let n=e.at("项目配置处理",r.input.file),s=r.result.oCsslib=Object.assign({},n.oCsslib||{});t.walk("RposeBlock",(t,n)=>{if("csslib"!==n.name.value)return;if(!n.text||!n.text.value||!n.text.value.trim())return;let i=e.at("解析[csslib]",n.text.value,r,n.text.loc);for(let t in i){if(s[t])throw new o("duplicate csslib name: "+t,{file:r.input.file,text:r.input.text,line:n.text.loc.start.line,column:1});s[t]=e.at("样式库",t,i[t])}return t.remove(),!1})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("d85p-init-component-[taglib]",function(t,r){let n=e.at("项目配置处理",r.input.file),s=r.result.oTaglib=Object.assign({},n.oTaglib||{});t.walk("RposeBlock",(t,n)=>{if("taglib"!==n.name.value)return;if(!n.text||!n.text.value||!n.text.value.trim())return;let i=e.at("解析[taglib]",n.text.value,r,n.text.loc);for(let e in i)if(s[e])throw new o("duplicate taglib name: "+e,{file:r.input.file,text:r.input.text,line:n.text.loc.start.line+s[e].line,column:1});let a=new Map;for(let e in i)a.set(i[e].pkg,i[e]);a.forEach((t,s)=>{if(!e.at("自动安装",s))throw new o("package install failed: "+s,{file:r.input.file,text:r.input.text,line:n.text.loc.start.line+t.line,column:1})});for(let t in i)try{e.at("标签库定义",i[t].taglib,r.input.file)}catch(e){throw new o.cat(e,{file:r.input.file,text:r.input.text,line:n.text.loc.start.line+i[t].line,column:1})}return t.remove(),!1})}))})(),(()=>{const e=require("@gotoeasy/bus");module.exports=e.on("视图编译选项",function(e={},t){return e.CodeBlockStart="{%",e.CodeBlockEnd="%}",e.ExpressionStart="{",e.ExpressionEnd="}",e.TypeHtmlComment="HtmlComment",e.TypeCodeBlock="JsCode",e.TypeExpression="Expression",e.TypeTagOpen="TagOpen",e.TypeTagClose="TagClose",e.TypeTagSelfClose="TagSelfClose",e.TypeAttributeName="AttributeName",e.TypeAttributeValue="AttributeValue",e.TypeEqual="=",e.TypeText="Text",function(o){return!t&&o&&(t=!0,e.CodeBlockStart=o.CodeBlockStart||e.CodeBlockStart,e.CodeBlockEnd=o.CodeBlockEnd||e.CodeBlockEnd,e.ExpressionStart=o.ExpressionStart||e.ExpressionStart,e.ExpressionEnd=o.ExpressionEnd||e.ExpressionEnd,e.TypeHtmlComment=o.TypeHtmlComment||e.TypeHtmlComment,e.TypeCodeBlock=o.TypeCodeBlock||e.TypeCodeBlock,e.TypeExpression=o.TypeExpression||e.TypeExpression,e.TypeTagOpen=o.TypeTagOpen||e.TypeTagOpen,e.TypeTagClose=o.TypeTagClose||e.TypeTagClose,e.TypeTagSelfClose=o.TypeTagSelfClose||e.TypeTagSelfClose,e.TypeAttributeName=o.TypeAttributeName||e.TypeAttributeName,e.TypeAttributeValue=o.TypeAttributeValue||e.TypeAttributeValue,e.TypeEqual=o.TypeEqual||e.TypeEqual,e.TypeText=o.TypeText||e.TypeText),e}}())})(),(()=>{const e=require("@gotoeasy/bus");e.on("是否表达式",function(){e.at("视图编译选项");return function(e){if(!e)return!1;let t=e.replace(/\\\{/g,"").replace(/\\\}/g,"");return/\{.*\}/.test(t)}}())})(),(()=>{const e=require("@gotoeasy/bus"),t="\0",o="￿";module.exports=e.on("字符阅读器",function(e){return new class{constructor(e){this.ary=e.split(""),this.maxLength=this.ary.length,this.pos=0}skip(e){return e>0&&(this.pos=this.pos+e,this.pos>this.maxLength&&(this.pos=this.maxLength)),this.pos}skipBlank(){let e="";for(;/\s/.test(this.getCurrentChar())&&!this.eof();)e+=this.readChar();return e}getPos(){return this.pos}eof(){return this.pos>=this.maxLength}readChar(){let e=this.getCurrentChar();return this.pos<this.maxLength&&(this.pos+=1),e}getPrevChar(){return 0==this.pos?t:this.ary[this.pos-1]}getCurrentChar(){return this.pos>=this.maxLength?o:this.ary[this.pos]}getNextChar(e=1){let t=e<1?1:e;return this.pos+t>=this.maxLength?o:this.ary[this.pos+t]}getChar(e=0){return e<0?t:e>=this.maxLength?o:this.ary[e]}getPrevString(e){return this.getString(this.pos-e,this.pos)}getString(e,t){let o=e<0?0:e>=this.maxLength?this.maxLength-1:e,r=t<0?0:t>this.maxLength?this.maxLength:t,n="";for(let e=o;e<r;e++)n+=this.ary[e];return n}getNextString(e){return this.getString(this.pos,this.pos+e)}}(e)})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/file"),require("@gotoeasy/err")),o="br,hr,input,img,meta,link,area,base,col,command,embed,keygen,param,srouce,trace,wbr".split(",");function r(e){return null==e?null:e.replace(/\\{/g,"\0").replace(/\\}/g,"￾￿")}function n(e){return null==e?null:e.replace(/\u0000\u0001/g,"{").replace(/\ufffe\uffff/g,"}")}function s(s,i,a,l){let u=r(i),c=e.at("视图编译选项"),p=e.at("字符阅读器",u),f=[];function g(){let e=p.getPos();if("<"!==p.getCurrentChar()||p.eof()||"\x3c!--"===p.getNextString(4)||"<![CDATA["===p.getNextString(9)||u.indexOf(c.CodeBlockStart,e)==e||u.indexOf(c.ExpressionStart,e)==e)return 0;let r,i,g="";if("</"===p.getNextString(2)){if(u.indexOf(">",e+3)<0)return 0;for((i={}).start=p.getPos(),p.skip(2);">"!==p.getCurrentChar()&&!p.eof();)g+=p.readChar();return p.skip(1),i.end=p.getPos(),r={type:c.TypeTagClose,value:g.trim(),pos:i},f.push(r),1}if("<"===p.getCurrentChar()&&u.indexOf(">",e+2)<0)return 0;if(!/[a-z]/i.test(p.getNextChar()))return 0;for((i={}).start=p.getPos(),p.skip(1);/[^\s\/>]/.test(p.getCurrentChar());)g+=p.readChar();let h={type:"",value:n(g).trim(),pos:i};for(f.push(h);d(););if(p.skipBlank(),"/>"===p.getNextString(2))return h.type=c.TypeTagSelfClose,p.skip(2),i.end=p.getPos(),1;if(">"===p.getCurrentChar())return o.includes(g.toLowerCase())?h.type=c.TypeTagSelfClose:h.type=c.TypeTagOpen,p.skip(1),i.end=p.getPos(),1;throw new t('tag missing ">"',"file="+a,{text:s,start:i.start+l})}function d(){if(p.eof())return 0;p.skipBlank();let e={};e.start=p.getPos();let o="",r="";if("{"===p.getCurrentChar()){let e=[];for(o+=p.readChar();!p.eof();){if("{"===p.getCurrentChar()&&"\\"!==p.getPrevChar()&&e.push("{"),"}"===p.getCurrentChar()&&"\\"!==p.getPrevChar()){if(!e.length){o+=p.readChar();break}e.pop()}o+=p.readChar()}if(!o)return 0}else{for(;/[^\s=\/>]/.test(p.getCurrentChar());)o+=p.readChar();if(!o)return 0}e.end=p.getPos();let i={type:c.TypeAttributeName,value:n(o),pos:e};if(f.push(i),p.skipBlank(),(e={}).start=p.getPos(),"="===p.getCurrentChar()){e.end=p.getPos()+1,i={type:c.TypeEqual,value:"=",pos:e},f.push(i);let o=p.getPos()+l+1;if(p.skip(1),p.skipBlank(),(e={}).start=p.getPos(),'"'===p.getCurrentChar()){p.skip(1);let u=p.getPos();for(;!p.eof()&&'"'!==p.getCurrentChar();){let e=p.readChar();"\r"!==e&&"\n"!==e&&(r+=e)}if(p.eof()||'"'!==p.getCurrentChar())throw new t('invalid attribute value format (missing ")',"file="+a,{text:s,start:o,end:u+l});p.skip(1),e.end=p.getPos(),i={type:c.TypeAttributeValue,value:n(r),pos:e},f.push(i)}else if("'"===p.getCurrentChar()){p.skip(1);let u=p.getPos();for(;!p.eof()&&"'"!==p.getCurrentChar();){let e=p.readChar();"\r"!=e&&"\n"!=e&&(r+=e)}if(p.eof()||"'"!==p.getCurrentChar())throw new t("invalid attribute value format (missing ')","file="+a,{text:s,start:o,end:u+l});p.skip(1),e.end=p.getPos(),i={type:c.TypeAttributeValue,value:n(r),pos:e},f.push(i)}else if("{"===p.getCurrentChar()){let u=[],g=p.getPos()+1;for(;!p.eof();){if("{"===p.getCurrentChar())u.push("{");else if("}"===p.getCurrentChar()){if(!u.length)break;if(1===u.length){r+=p.readChar();break}u.pop()}r+=p.readChar()}if(p.eof())throw new t("invalid attribute value format (missing })","file="+a,{text:s,start:o,end:g+l});e.end=p.getPos(),i={type:c.TypeAttributeValue,value:n(r),pos:e},f.push(i)}else{for(;/[^\s\/>]/.test(p.getCurrentChar());)r+=p.readChar();if(!r)throw new t("missing attribute value","file="+a,{text:s,start:o,end:o+1});if(!/^(\d+|\d+\.?\d+)$/.test(r))throw new t("invalid attribute value","file="+a,{text:s,start:o,end:p.getPos()+l});e.end=p.getPos(),i={type:c.TypeAttributeValue,value:r-0,pos:e},f.push(i)}}return 1}function h(){let e,t=p.getPos(),o=u.indexOf("\x3c!--",t),r=u.indexOf("--\x3e",t+4);if(o===t&&r>t){let s={};return s.start=o,s.end=r+3,e={type:c.TypeHtmlComment,value:n(u.substring(t+4,r)),pos:s},p.skip(r+3-t),f.push(e),1}return 0}function b(){let e,t=p.getPos(),o=u.indexOf("<![CDATA[",t),s=u.indexOf("]]>",t+9);if(o===t&&s>t){let i={};i.start=o,i.end=s+3;let a=r(u.substring(t+9,s));if(p.skip(s+3-t),/\{.*?}/.test(a)){let t,r,s,i,l=o+9;for(;(t=a.indexOf("{"))>=0&&(r=a.indexOf("}",t))>0;)t>0&&(l=(i={start:l,end:l+(s=n(a.substring(0,t))).length}).end,e={type:c.TypeText,value:s,pos:i},f.push(e)),l=(i={start:l,end:l+(s=n(a.substring(t,r+1))).length}).end,e={type:c.TypeExpression,value:s,pos:i},f.push(e),a=a.substring(r+1);a&&(l=(i={start:l,end:l+(s=n(a)).length}).end,e={type:c.TypeText,value:s,pos:i},f.push(e))}else e={type:c.TypeText,value:a,pos:i},f.push(e);return 1}return 0}function y(){let e,t,o=p.getPos();if(0!==o&&"\n"!==p.getPrevChar()||u.indexOf("```",o)!==o||!(u.indexOf("\n```",o+3)>0))return 0;let r,n=u.substring(o),s=/(^```[\s\S]*?\r?\n)([\s\S]*?)\r?\n```[\s\S]*?\r?(\n|$)/.exec(n),i=s[0].length;e=o,t=o+i,r={type:c.TypeTagSelfClose,value:"```",pos:{start:e,end:t}},f.push(r);let a,l=s[1].match(/\b\w*\b/),g=l?l[0].toLowerCase():"";g&&(t=(e=o+l.index)+g.length,r={type:c.TypeAttributeName,value:"lang",pos:{start:e,end:t}},f.push(r),r={type:c.TypeEqual,value:"=",pos:{start:e,end:t}},f.push(r),r={type:c.TypeAttributeValue,value:g,pos:{start:e,end:t}},f.push(r)),(l=s[1].match(/\b\d+(\%|px)/i))?a=l[0]:(l=s[1].match(/\b\d+/i))&&(a=l[0]),a&&(t=(e=o+l.index)+a.length,r={type:c.TypeAttributeName,value:"height",pos:{start:e,end:t}},f.push(r),r={type:c.TypeEqual,value:"=",pos:{start:e,end:t}},f.push(r),a=/^\d+$/.test(a)?a+"px":a,r={type:c.TypeAttributeValue,value:a,pos:{start:e,end:t}},f.push(r));let d=(l=s[1].match(/\bref\s?=\s?"(.*?)"/i))&&l[0]?l[0]:"";d&&(r={type:c.TypeAttributeName,value:"ref",pos:{start:e,end:t}},f.push(r),r={type:c.TypeEqual,value:"=",pos:{start:e,end:t}},f.push(r),r={type:c.TypeAttributeValue,value:d,pos:{start:e,end:t}},f.push(r));let h=s[2].replace(/\u0000\u0001/g,"\\{").replace(/\ufffe\uffff/g,"\\}");return h=h.replace(/\n\\+```/g,e=>"\n"+e.substring(2)),/^\\+```/.test(h)&&(h=h.substring(1)),h=h.replace(/\{/g,"\\{").replace(/\}/g,"\\}"),t=(e=o+s[1].length)+s[2].length,r={type:c.TypeAttributeName,value:"$CODE",pos:{start:e,end:t}},f.push(r),r={type:c.TypeEqual,value:"=",pos:{start:e,end:t}},f.push(r),r={type:c.TypeAttributeValue,value:h,pos:{start:e,end:t}},f.push(r),p.skip(i),1}function m(){let e,t=p.getPos(),o=u.indexOf(c.CodeBlockStart,t),r=u.indexOf(c.CodeBlockEnd,t+c.CodeBlockStart.length);if(o===t&&r>0){let s={};return s.start=o,s.end=r+c.CodeBlockEnd.length,e={type:c.TypeCodeBlock,value:n(u.substring(t+c.CodeBlockStart.length,r)),pos:s},p.skip(r+c.CodeBlockEnd.length-t),f.push(e),1}return 0}function x(){if(p.eof())return 0;let e={};e.start=p.getPos();let t,o,r="";for(;!p.eof()&&(r+=p.readChar(),o=p.getPos(),"<"!==p.getCurrentChar()&&"```"!==p.getNextString(3)&&u.indexOf(c.CodeBlockStart,o)!==o&&u.indexOf(c.ExpressionStart,o)!==o););return r?(e.end=p.getPos(),t={type:c.TypeText,value:n(r),pos:e},f.push(t),1):0}function w(){if(p.eof())return 0;let e,t={};return t.start=p.getPos(),(e=function(){let e=p.getPos(),t=u.indexOf(c.ExpressionStart,e),o=u.indexOf(c.ExpressionEnd,e+c.ExpressionStart.length);if(t===e&&o>0){let t={type:c.TypeExpression,value:n(u.substring(e,o+c.ExpressionEnd.length))};return p.skip(o+c.ExpressionEnd.length-e),t}return null}())?(t.end=p.getPos(),e.pos=t,f.push(e),1):0}this.parse=function(){for(;g()||h()||b()||m()||w()||y()||x(););return f.forEach(e=>{e.loc=function(e,t,o,r){let n,s,i={},a={};return n=e.substring(0,t+r).split("\n"),i.line=n.length,s=n.pop(),i.column=s.length+1,i.pos=r+t,n=e.substring(0,o+r).split("\n"),a.line=n.length,s=n.pop(),a.column=s.length,a.pos=r+o,s.length||(a.line--,a.column=n.pop().length+1),{start:i,end:a}}(s,e.pos.start,e.pos.end,l),delete e.pos}),f}}e.on("视图TOKEN解析器",function(e,t,o,r){return new s(e,t,o,r)})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("e15p-parse-view-tokens-to-ast",function(t,o){t.walk("RposeBlock",(t,r)=>{if(!/^view$/.test(r.name.value))return;let n=r.text?r.text.value:"";if(!n)return t.remove();let s=e.at("视图TOKEN解析器",o.input.text,n,o.input.file,r.text.loc.start.pos),i={type:"View",src:n,loc:r.text.loc,nodes:s.parse()},a=this.createNode(i);t.replaceWith(a)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("f15p-astedit-normalize-group-attribute",function(t,r){const n=e.at("视图编译选项");t.walk(n.TypeAttributeName,(t,s)=>{let i=t.after();if(i&&i.type===n.TypeEqual){let a=i.after();if(!a||!a.type===n.TypeAttributeValue)throw new o("missing attribute value");if(e.at("是否表达式",s.value))throw new o("unsupport expression on attribute name",{file:r.input.file,text:r.input.text,start:s.loc.start.pos,end:s.loc.end.pos});if(/^\s*\{\s*\}\s*$/.test(a.object.value))throw new o("invalid empty expression",{file:r.input.file,text:r.input.text,start:a.object.loc.start.pos,end:a.object.loc.end.pos});let l={type:"Attribute",name:s.value,value:a.object.value,isExpression:e.at("是否表达式",a.object.value),loc:{start:s.loc.start,end:a.object.loc.end}},u=this.createNode(l);t.replaceWith(u),i.remove(),a.remove()}else{let o={type:"Attribute",name:s.value,value:!0,isExpression:!1,loc:s.loc};e.at("是否表达式",s.value)&&(o.isExpression=!0,o.isObjectExpression=!0,delete o.value);let r=this.createNode(o);t.replaceWith(r)}}),t.walk("Attribute",(e,t)=>{if(!e.parent)return;let o=[e],r=e.after();for(;r&&"Attribute"===r.type;)o.push(r),r=r.after();let n=this.createNode({type:"Attributes"});e.before(n),o.forEach(e=>{n.addChild(e.clone()),e.remove()})})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("f25p-astedit-normolize-tag-of-self-close",function(t,o){const r=e.at("视图编译选项");t.walk(r.TypeTagSelfClose,(e,t)=>{let o=t.value,r=t.loc,n=this.createNode({type:"Tag",value:o,loc:r}),s=e.after();s&&"Attributes"===s.type&&(n.addChild(s.clone()),s.remove()),e.replaceWith(n)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("f35p-astedit-normolize-tag-of-open-close",function(t,r){const n=e.at("视图编译选项");let s=(e,t)=>{let i=t.after();for(;i&&i.type!==n.TypeTagClose;){if(i.type===n.TypeTagOpen){let t="Tag",o=i.object.value,r=i.object.loc,n=this.createNode({type:t,value:o,loc:r});s(n,i),e.addChild(n)}else e.addChild(i.clone());i.remove(),i=t.after()}if(!i)throw new o("missing close tag","file="+r.input.file,{text:r.input.text,start:e.object.loc.start.pos});if(i.type===n.TypeTagClose){if(t.object.value!==i.object.value)throw new o(`unmatch close tag: ${t.object.value}/${i.object.value}`,"file="+r.input.file,{text:r.input.text,start:e.object.loc.start.pos,end:i.object.loc.end.pos});return e.object.loc.end=i.object.loc.end,i.remove(),e}throw new Error("todo unhandle type")};t.walk(n.TypeTagOpen,(e,t)=>{if(!e.parent)return;let o=t.value,r=t.loc,n=this.createNode({type:"Tag",value:o,loc:r});s(n,e),e.replaceWith(n)})}))})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/postobject");function t(e){return e.startsWith("[")&&e.indexOf("]")>0}function o(e){return e.startsWith("---------")}function r(e){return e.startsWith("=========")}function n(e){let t,o;for(let r=1;r<e.length;r++)if("\\"!==e.charAt(r-1)&&"]"===e.charAt(r))return{name:t=e.substring(1,r).toLowerCase(),len:o=t.length};return{name:t=e.substring(1,e.lastIndexOf("]")).toLowerCase(),len:o=t.length}}e.on("BTF内容解析",function(e){let s=e.indexOf("\r\n")>=0?"\r\n":"\n",i=[];return function(e,s){let i,a,l,u=!1;for(let c=0;c<s.length;c++)if(t(i=s[c]))a=n(i),l=i.substring(a.len+2),e.push({type:"BlockName",name:a.name,comment:l}),u=!0;else if(o(i))e.push({type:"Comment",value:i}),u=!1;else if(r(i))e.push({type:"Comment",value:i}),u=!1;else if(u){"BlockText"!==e[e.length-1].type&&e.push({type:"BlockText",name:e[e.length-1].name,value:[]});let t=e[e.length-1];t.value.push(i)}else e.push({type:"Comment",value:i})}(i,e.split(s)),i.forEach(e=>{"BlockText"===e.type&&(e.value=e.value.join(s))}),i})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("refractor"),o=require("rehype");function r(e){e.languages.inilike={constant:/^[ \t]*[^\s=:]+?(?=[ \t]*[=:])/m,"attr-value":{pattern:/(=|:).*/,inside:{punctuation:/^(=|:)/}}}}r.displayName="inilike",r.aliases=[],t.register(r),e.on("语法高亮转换",function(r="@rpose/buildin:```",n){return function(o="",a="clike"){if(n||((n={}).token=e.at("哈希样式类名",r,"token"),n.comment=e.at("哈希样式类名",r,"comment"),n.selector=e.at("哈希样式类名",r,"selector")),/^(btf|rpose)$/i.test(a)){return"<ol><li>"+function(o){let r=[];return e.at("BTF内容解析",o).forEach(e=>{if("BlockName"===e.type)r.push(function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/(.*)/g,`<span class="${n.token} ${n.selector}">$1</span>`)}("["+e.name+"]")+s(e.comment));else if("BlockText"===e.type){let o=e.name;t.registered(o)||(o=/^(actions|methods|options|state)$/i.test(o)?"js":/^view$/i.test(o)?"markup":"inilike"),r.push(i(e.value,o))}else{if("Comment"!==e.type)throw new Error("unknow type");r.push(s(e.value))}}),r.join("\n")}(o).split(/\r?\n/).join("</li><li>")+"</li></ol>"}return!t.registered(a)&&(a="clike"),"<ol><li>"+i(o,a).split(/\r?\n/).join("</li><li>")+"</li></ol>"};function s(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/(\S+.*)/g,`<span class="${n.token} ${n.comment}">$1</span>`)}function i(s,i){let a=t.highlight(s,i);return function t(o){o&&o.forEach(o=>{if(o.properties&&o.properties.className){let t=[];o.properties.className.forEach(o=>{!n[o]&&(n[o]=e.at("哈希样式类名",r,o)),t.push(n[o])}),o.properties.className=t}t(o.children)})}(a),o().stringify({type:"root",children:a}).toString()}}())})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",t.plugin("f45p-astedit-transform-tag-```",function(t,o){t.walk("Tag",(t,o)=>{if("```"!==o.value)return;let r,n,s;for(let e,o=0;e=t.nodes[o++];)if("Attributes"===e.type){r=e;break}for(let e,t=0;e=r.nodes[t++];)"$CODE"===e.object.name?(n=e,e.object.value=e.object.value.replace(/\\\{/g,"{").replace(/\\\}/g,"}")):"lang"===e.object.name&&(s=e.object.value);n.object.value=e.at("语法高亮转换",n.object.value,s);let i=this.createNode({type:"Attribute"});i.object.name="@taglib",i.object.value="@rpose/buildin:```";let a=Object.assign({},o.loc);a.end.line=a.start.line,a.end.column=3,a.end.pos=a.start.pos+3,i.object.loc=a,r.addChild(i)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("f55p-astedit-normolize-flag-is-svg-tag",function(e,t){e.walk("Tag",(e,t)=>{/^svg$/i.test(t.value)&&(t.svg=!0,e.walk("Tag",(e,t)=>{t.svg=!0},{readonly:!0}))},{readonly:!0})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=/^(html|link|meta|style|title|address|article|aside|footer|header|h1|h2|h3|h4|h5|h6|hgroup|main|nav|section|blockquote|dd|dir|div|dl|dt|figcaption|figure|hr|li|ol|p|pre|ul|a|abbr|b|bdi|bdo|br|cite|code|data|dfn|em|i|kbd|mark|q|rb|rp|rt|rtc|ruby|s|samp|small|span|strong|sub|sup|time|tt|u|var|wbr|area|audio|img|map|track|video|applet|embed|iframe|noembed|object|param|picture|source|canvas|noscript|script|del|ins|caption|col|colgroup|table|tbody|td|tfoot|th|thead|tr|button|datalist|fieldset|form|input|label|legend|meter|optgroup|option|output|progress|select|textarea|details|dialog|menu|menuitem|summary|content|element|shadow|slot|template|acronym|basefont|bgsound|big|blink|center|command|font|frame|frameset|image|isindex|keygen|listing|marquee|multicol|nextid|nobr|noframes|plaintext|spacer|strike|xmp|head|base|body|math|svg)$/i;e.on("编译插件",t.plugin("f65p-astedit-normolize-flag-is-standard-tag",function(e,t){e.walk("Tag",(e,t)=>{t.standard=!!t.svg||o.test(t.value)},{readonly:!0})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("g15p-astedit-group-attribtue-{prop}",function(e,t){e.walk("Tag",(e,t)=>{if(!e.nodes||!e.nodes.length)return;let o;for(let t,r=0;t=e.nodes[r++];)if("Attributes"===t.type){o=t;break}if(!o||!o.nodes||!o.nodes.length)return;let r=[];if(o.nodes.forEach(e=>{e.object.isObjectExpression&&r.push(e)}),!r.length)return;let n=this.createNode({type:"ObjectExpressionAttributes"});r.forEach(e=>{let t=e.clone();t.type="ObjectExpressionAttribute",t.object.type="ObjectExpressionAttribute",n.addChild(t),e.remove()}),e.addChild(n)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=/^(onclick|onchange|onabort|onafterprint|onbeforeprint|onbeforeunload|onblur|oncanplay|oncanplaythrough|oncontextmenu|oncopy|oncut|ondblclick|ondrag|ondragend|ondragenter|ondragleave|ondragover|ondragstart|ondrop|ondurationchange|onemptied|onended|onerror|onfocus|onfocusin|onfocusout|onformchange|onforminput|onhashchange|oninput|oninvalid|onkeydown|onkeypress|onkeyup|onload|onloadeddata|onloadedmetadata|onloadstart|onmousedown|onmouseenter|onmouseleave|onmousemove|onmouseout|onmouseover|onmouseup|onmousewheel|onoffline|ononline|onpagehide|onpageshow|onpaste|onpause|onplay|onplaying|onprogress|onratechange|onreadystatechange|onreset|onresize|onscroll|onsearch|onseeked|onseeking|onselect|onshow|onstalled|onsubmit|onsuspend|ontimeupdate|ontoggle|onunload|onunload|onvolumechange|onwaiting|onwheel)$/i;e.on("编译插件",t.plugin("g25p-astedit-group-attribtue-events",function(e,t){e.walk("Tag",(e,t)=>{if(!e.object.standard)return;if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let n=[];if(r.nodes.forEach(e=>{o.test(e.object.name)&&n.push(e)}),!n.length)return;let s=this.createNode({type:"Events"});n.forEach(e=>{let t=e.clone();t.type="Event",t.object.type="Event",s.addChild(t),e.remove()}),e.addChild(s)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("g35p-astedit-process-attribtue-style",function(e,t){e.walk("Tag",(e,r)=>{if(!e.nodes||!e.nodes.length)return;let n;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){n=t;break}if(!n||!n.nodes||!n.nodes.length)return;let s=[];if(n.nodes.forEach(e=>{/^style$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of style",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});let i=s[0].clone();i.type="Style",i.object.type="Style",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("g45p-astedit-process-attribtue-class",function(e,t){e.walk("Tag",(e,r)=>{if(!e.nodes||!e.nodes.length)return;let n;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){n=t;break}if(!n||!n.nodes||!n.nodes.length)return;let s=[];if(n.nodes.forEach(e=>{/^class$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of class",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});let i=s[0].clone();i.type="Class",i.object.type="Class",i.object.classes=function(e){let t=[],o=(e=e.replace(/\{.*?\}/g,function(e){let o,r,n,s=e.substring(1,e.length-1);for(;s.indexOf(":")>0;){o=s.indexOf(":"),r=s.substring(0,o).replace(/['"]/g,"").trim();let e=(n=s.substring(o+1)).indexOf(":");e>0?(n=(n=n.substring(0,e)).substring(0,n.lastIndexOf(",")),s=s.substring(o+1+n.length+1)):s="",r&&t.push(r)}return""})).split(/\s+/);for(let e=0;e<o.length;e++)o[e].trim()&&t.push(o[e].trim());return t}(i.object.value),e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h15p-astedit-process-attribtue-@ref",function(e,t){e.walk("Tag",(e,r)=>{if(!e.nodes||!e.nodes.length)return;let n;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){n=t;break}if(!n||!n.nodes||!n.nodes.length)return;let s=[];if(n.nodes.forEach(e=>{/^@ref$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of @ref",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});if(/^(if|for)$/.test(r.value))throw new o(`unsupport attribute @ref on tag <${r.value}>`,{file:t.input.file,text:t.input.text,start:s[0].object.loc.start.pos,end:s[0].object.loc.end.pos});let i=s[0].clone();i.type="@ref",i.object.type="@ref",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h25p-astedit-process-attribtue-@if",function(e,t){e.walk("Tag",(e,r)=>{if(!e.nodes||!e.nodes.length)return;let n;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){n=t;break}if(!n||!n.nodes||!n.nodes.length)return;let s=[];if(n.nodes.forEach(e=>{/^@if$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of @if",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});let i=s[0].clone();i.type="@if",i.object.type="@if",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h35p-astedit-process-attribtue-@show",function(e,t){e.walk("Tag",(e,r)=>{if(!e.nodes||!e.nodes.length)return;let n;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){n=t;break}if(!n||!n.nodes||!n.nodes.length)return;let s=[];if(n.nodes.forEach(e=>{/^@show$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of @show",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});if(/^(if|for)$/.test(r.value))throw new o(`unsupport attribute @show on tag <${r.value}>`,{file:t.input.file,text:t.input.text,start:s[0].object.loc.start.pos,end:s[0].object.loc.end.pos});let i=s[0].clone();i.type="@show",i.object.type="@show",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h45p-astedit-process-attribtue-@for",function(e,t){e.walk("Tag",(e,r)=>{if(!e.nodes||!e.nodes.length)return;let n;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){n=t;break}if(!n||!n.nodes||!n.nodes.length)return;let s=[];if(n.nodes.forEach(e=>{/^@for$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of @for",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});let i=s[0].clone();i.type="@for",i.object.type="@for",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h55p-astedit-process-attribtue-@csslib",function(e,t){e.walk("Tag",(e,r)=>{if(!e.nodes||!e.nodes.length)return;let n;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){n=t;break}if(!n||!n.nodes||!n.nodes.length)return;let s=[];if(n.nodes.forEach(e=>{/^@csslib$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of @csslib",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});if(/^(if|for)$/.test(r.value))throw new o(`unsupport attribute @csslib on tag <${r.value}>`,{file:t.input.file,text:t.input.text,start:s[0].object.loc.start.pos,end:s[0].object.loc.end.pos});let i=s[0].clone();i.type="@csslib",i.object.type="@csslib",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h65p-astedit-process-attribtue-@taglib",function(e,t){e.walk("Tag",(e,r)=>{if(!e.nodes||!e.nodes.length)return;let n;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){n=t;break}if(!n||!n.nodes||!n.nodes.length)return;let s=[];if(n.nodes.forEach(e=>{/^@taglib$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of @taglib",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});if(/^(if|for)$/.test(r.value))throw new o(`unsupport @taglib on tag <${r.value}>`,{file:t.input.file,text:t.input.text,start:s[0].object.loc.start.pos,end:s[0].object.loc.end.pos});let i=s[0].clone();i.type="@taglib",i.object.type="@taglib",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/hash"),o=require("@gotoeasy/file"),r=require("@gotoeasy/err"),n=require("@gotoeasy/postobject"),s=require("fs");e.on("编译插件",n.plugin("j15p-astedit-process-tag-img",function(n,i){n.walk("Tag",(n,a)=>{if(!/^img$/i.test(a.value))return;let l,u;i.result.hasImg=!0;for(let e,t=0;e=n.nodes[t++];)if("Attributes"===e.type){l=e;break}if(!l||!l.nodes||!l.nodes.length)return;for(let e,t=0;e=l.nodes[t++];)if(/^src$/i.test(e.object.name)){u=e;break}if(!u)return;let c=function(r,n){let i;if(o.exists(n))i=n;else if(i=o.resolve(r,n),!o.exists(i))return!1;let a=t({file:i})+o.extname(i),l=e.at("缓存目录")+"/resources",u=l+"/"+a;return o.exists(u)||(!o.existsDir(l)&&o.mkdir(l),s.createReadStream(i).pipe(s.createWriteStream(u))),a}(i.input.file,u.object.value);if(!c)throw new r("image file not found",{file:i.input.file,text:i.input.text,start:u.object.loc.start.pos,end:u.object.loc.end.pos});u.object.value="%imagepath%"+c},{readonly:!0})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("k15p-astedit-transform-attribtue-@ref",function(t,r){t.walk("@ref",(t,n)=>{let s,i=t.parent;if(e.at("是否表达式",n.value))throw new o("@ref unsupport the expression",{file:r.input.file,text:r.input.text,start:n.loc.start.pos,end:n.loc.end.pos});for(let e,t=0;e=i.nodes[t++];)if("Attributes"===e.type){s=e;break}let a=t.clone();a.type="Attribute",a.object.type="Attribute",a.object.name="ref";let l=t.clone();l.type="Attribute",l.object.type="Attribute",l.object.name="$context",l.object.value="{$this}",l.object.isExpression=!0,s||(s=this.createNode({type:"Attributes"}),i.addChild(s)),s.addChild(a),s.addChild(l),t.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",t.plugin("k25p-astedit-transform-attribtue-@if",function(t,o){const r=e.at("视图编译选项");t.walk("@if",(e,t)=>{let o=e.parent;/^if$/i.test(o.object.value)&&(o.ok=!0);let n=r.TypeCodeBlock,s="if ("+t.value.replace(/^\s*\{=?/,"").replace(/\}\s*$/,"")+") {",i=this.createNode({type:n,value:s});o.before(i),s="}",i=this.createNode({type:n,value:s}),o.after(i),e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",t.plugin("k35p-astedit-transform-attribtue-@show",function(t,o){const r=e.at("视图编译选项");t.walk("@show",(e,t)=>{let o,n=e.parent;for(let e,t=0;e=n.nodes[t++];)if("Style"===e.type){o=e;break}let s=r.ExpressionStart+"("+t.value.replace(/^\{/,"").replace(/\}$/,"")+') ? "display:block;" : "display:none;"'+r.ExpressionEnd;o?o.object.value.endsWith(";")?o.object.value+=s:o.object.value+=";"+s:(o=this.createNode({type:"Style",value:s}),n.addChild(o)),o.object.isExpression=!0,e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");function r(e,t,r="invalid format of @for"){return new o(r,{file:e.input.file,text:e.input.text,start:t.loc.start.pos,end:t.loc.end.pos})}e.on("编译插件",t.plugin("k45p-astedit-transform-attribtue-@for",function(t,o){const n=e.at("视图编译选项");t.walk("@for",(e,t)=>{let s=e.parent;/^for$/i.test(s.object.value)&&(s.ok=!0);let i=n.TypeCodeBlock,a=function(e,t){if(!t.value)throw r(e,t);let o,n,s,i,a,l;if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s+from\s+(\w+)\s+max\s+(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],n=l[2],s=l[3],i=l[4],a=l[5],/^\d+/.test(o))throw r(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(n))throw r(e,t,`invalid index name: [${n}]`);if(/^\d+/.test(a))throw r(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${n}=${s},ARY_=(${a}),MAX_=Math.min(${i},ARY_.length),${o}; ${n}<MAX_; ${n}++) {\n                        ${o} = ARY_[${n}]; `:` for ( let ${n}=${s},MAX_=Math.min(${i},${a}.length),${o}; ${n}<MAX_; ${n}++) {\n                    ${o} = ${a}[${n}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s+max\s+(\w+)\s+from\s+(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],n=l[2],s=l[4],i=l[3],a=l[5],/^\d+/.test(o))throw r(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(n))throw r(e,t,`invalid index name: [${n}]`);if(/^\d+/.test(a))throw r(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${n}=${s},ARY_=(${a}),MAX_=Math.min(${i},ARY_.length),${o}; ${n}<MAX_; ${n}++) {\n                        ${o} = ARY_[${n}]; `:` for ( let ${n}=${s},MAX_=Math.min(${i},${a}.length),${o}; ${n}<MAX_; ${n}++) {\n                    ${o} = ${a}[${n}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s+from\s+(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],n=l[2],s=l[3],a=l[4],/^\d+/.test(o))throw r(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(n))throw r(e,t,`invalid index name: [${n}]`);if(/^\d+/.test(a))throw r(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${n}=${s},ARY_=(${a}),MAX_=ARY_.length,${o}; ${n}<MAX_; ${n}++) {\n                        ${o} = ARY_[${n}]; `:` for ( let ${n}=${s},MAX_=${a}.length,${o}; ${n}<MAX_; ${n}++) {\n                    ${o} = ${a}[${n}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s+max\s+(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],n=l[2],i=l[3],a=l[4],/^\d+/.test(o))throw r(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(n))throw r(e,t,`invalid index name: [${n}]`);if(/^\d+/.test(a))throw r(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${n}=0,ARY_=(${a}),MAX_=Math.min(${i},ARY_.length),${o}; ${n}<MAX_; ${n}++) {\n                        ${o} = ARY_[${n}]; `:` for ( let ${n}=0,MAX_=Math.min(${i},${a}.length),${o}; ${n}<MAX_; ${n}++) {\n                    ${o} = ${a}[${n}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],n=l[2],a=l[3],/^\d+/.test(o))throw r(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(n))throw r(e,t,`invalid index name: [${n}]`);if(/^\d+/.test(a))throw r(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${n}=0,ARY_=(${a}),MAX_=ARY_.length,${o}; ${n}<MAX_; ${n}++) {\n                        ${o} = ARY_[${n}]; `:` for ( let ${n}=0,MAX_=${a}.length,${o}; ${n}<MAX_; ${n}++) {\n                    ${o} = ${a}[${n}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],n="J_",a=l[2],/^\d+/.test(o))throw r(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(n))throw r(e,t,`invalid index name: [${n}]`);if(/^\d+/.test(a))throw r(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${n}=0,ARY_=(${a}),MAX_=ARY_.length,${o}; ${n}<MAX_; ${n}++) {\n                        ${o} = ARY_[${n}]; `:` for ( let ${n}=0,MAX_=${a}.length,${o}; ${n}<MAX_; ${n}++) {\n                    ${o} = ${a}[${n}]; `}if(l=t.value.match(/^\s*\{*\s*(\w+)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],n="J_",a=l[2],/^\d+/.test(o))throw r(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(a))throw r(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${n}=0,ARY_=(${a}),MAX_=ARY_.length,${o}; ${n}<MAX_; ${n}++) {\n                        ${o} = ARY_[${n}]; `:` for ( let ${n}=0,MAX_=${a}.length,${o}; ${n}<MAX_; ${n}++) {\n                    ${o} = ${a}[${n}]; `}throw r(e,t)}(o,t),l=t.loc,u=this.createNode({type:i,value:a,loc:l});s.before(u),a="}",u=this.createNode({type:i,value:a,loc:l}),s.after(u),e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("k55p-astedit-transform-tag-name-by-@taglib",function(t,r){t.walk("@taglib",(t,n)=>{let s=t.parent;if(s.object.standard)throw new o("unsupport @taglib on standard tag",{file:r.input.file,text:r.input.text,start:n.loc.start.pos,end:n.loc.end.pos});let i=e.at("标签项目源文件",s.object.value);if(i)throw new o(`unsupport @taglib on existed component: ${s.object.value}(${i})`,{file:r.input.file,text:r.input.text,start:n.loc.start.pos,end:n.loc.end.pos});let a,l,u,c=n.value;if(u=c.match(/^\s*.+?\s*=\s*(.+?)\s*:\s*(.+?)\s*$/))a=u[1],l=u[2];else if(u=c.match(/^\s*.+?\s*=\s*(.+?)\s*$/))a=u[1],l=s.object.value;else{if(c.indexOf("=")>=0)throw new o("invalid attribute value of @taglib",{file:r.input.file,text:r.input.text,start:n.loc.start.pos,end:n.loc.end.pos});if(u=c.match(/^\s*(.+?)\s*:\s*(.+?)\s*$/))a=u[1],l=u[2];else{if(!(u=c.match(/^\s*(.+?)\s*$/)))throw new o("invalid attribute value of @taglib",{file:r.input.file,text:r.input.text,start:n.loc.start.pos,end:n.loc.end.pos});a=u[1],l=s.object.value}}if(!e.at("自动安装",a))throw new o("package install failed: "+a,{file:r.input.file,text:r.input.text,start:n.loc.start.pos,end:n.loc.end.pos});let p=e.at("模块组件信息",a),f=e.at("标签库引用",`${a}:${l}`,p.config);if(!f)throw new o("component not found: "+n.value,{file:r.input.file,text:r.input.text,start:n.loc.start.pos,end:n.loc.end.pos});let g=e.at("标签全名",f);s.object.value=g,t.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("k65p-astedit-transform-tag-name-by-[taglib]",function(t,r){let n=Object.assign({},r.result.oTaglib);t.walk("Tag",(t,s)=>{if(s.standard)return;let i=n[s.value];if(!i)return;let a,l,u=i.split(":");if(u.length>1?(a=u[0].trim(),l=u[1].trim()):(a=i.trim(),l=s.value),!e.at("自动安装",a))throw new o("package install failed: "+a,{file:r.input.file,text:r.input.text,start:s.loc.start.pos,end:s.loc.end.pos});let c=e.at("模块组件信息",a),p=e.at("标签库引用",`${a}:${l}`,c.config);if(!p)throw new o("component not found: "+s.value,{file:r.input.file,text:r.input.text,start:s.loc.start.pos,end:s.loc.end.pos});let f=e.at("标签全名",p);s.value=f})},{readonly:!0}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("k75p-astedit-transform-tag-if-for",function(e,t){e.walk("Tag",(e,r)=>{if(/^(if|for)$/i.test(r.value)){if(!e.ok)throw new o(`missing attribute @${r.value} of tag <${r.value}>`,{file:t.input.file,text:t.input.text,start:r.loc.start.pos});e.nodes.forEach(t=>{"Attributes"!==t.type&&e.before(t.clone())}),e.remove()}})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err"),r=require("@gotoeasy/hash");e.on("编译插件",t.plugin("k85p-astedit-transform-tag-slot",function(t,n){let s=[],i=e.at("视图编译选项");t.walk("Tag",(t,r)=>{if(!/^slot$/i.test(r.value))return;let i,a=n.result.slots=n.result.slots||[];if(t.nodes)for(let e,o=0;e=t.nodes[o++];)if("Attributes"===e.type){i=e;break}if(!i||!i.nodes||!i.nodes.length){if(a.length)throw new o("missing attribute 'name' of tag <slot>",{file:n.input.file,text:n.input.text,start:r.loc.start.pos,end:r.loc.end.pos});return a.push(""),s.push(t),void(t.slotName="")}let l=[];if(i.nodes&&i.nodes.forEach(e=>{/^name$/i.test(e.object.name)&&l.push(e)}),0===l.length){if(a.length)throw new o("missing attribute 'name' of tag <slot>",{file:n.input.file,text:n.input.text,start:r.loc.start.pos,end:r.loc.end.pos});return a.push(""),s.push(t),void(t.slotName="")}if(l.length>1)throw new o("duplicate attribute of name",{file:n.input.file,text:n.input.text,start:l[1].object.loc.start.pos,end:l[1].object.loc.end.pos});if(e.at("是否表达式",l[0].object.value))throw new o("slot name unsupport the expression",{file:n.input.file,text:n.input.text,start:l[0].object.loc.start.pos,end:l[0].object.loc.end.pos});let u=l[0].object.value+"";if(a.includes(u))throw new o("duplicate slot name: "+u,{file:n.input.file,text:n.input.text,start:l[0].object.loc.start.pos,end:l[0].object.loc.end.pos});a.push(u),!u&&s.push(t),t.slotName=u});let a=n.result.slots=n.result.slots||[];if(a.length>1&&s.length)throw new o("missing slot name on tag <slot>",{file:n.input.file,text:n.input.text,start:s[0].object.loc.start.pos,end:s[0].object.loc.end.pos});if(n.result.slots){let e=n.doc.api.statekeys=n.doc.api.statekeys||[];!e.includes("$SLOT")&&e.push("$SLOT")}if(a.length){t.walk("Tag",(e,t)=>{if(!/^slot$/i.test(t.value))return;let o=i.TypeCodeBlock,n=`_Ary.push( ...slotVnodes_${r(e.slotName)} );`;e.object.loc,e.replaceWith(this.createNode({type:o,value:n}))});let e=[],o=1===a.length&&""===a[0],n=[];o&&n.push(" _hasDefinedSlotTemplate "),a.forEach(e=>{n.push(` slotVnodes_${r(e)} = [] `)}),e.push("let "+n.join(",")+";"),e.push(" ($state.$SLOT || []).forEach(vn => { "),e.push("     if (vn.a) { "),o&&e.push("     vn.a.slot !== undefined && (_hasDefinedSlotTemplate = 1); "),a.forEach(t=>{e.push(`     vn.a.slot === '${t}' && (slotVnodes_${r(t)} = vn.c || []); `)}),e.push("     } "),e.push(" }); "),o&&e.push(` !_hasDefinedSlotTemplate && !slotVnodes_${r("")}.length && (slotVnodes_${r("")} = $state.$SLOT || []); `),t.walk("View",(t,o)=>{let r=i.TypeCodeBlock,n=e.join("\n");return t.addChild(this.createNode({type:r,value:n}),0),!1})}}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("m15p-csslibify-check-@csslib",function(t,r){let n=r.result.oCsslib,s=new Set;t.walk("@csslib",(t,i)=>{if(e.at("是否表达式",i.value))throw new o("@csslib unsupport the expression",{file:r.input.file,text:r.input.text,start:i.loc.start.pos,end:i.loc.end.pos});let a=i.value.split("="),l=a.length>1?a[0].trim():"*";if(!l)throw new o("use * as empty csslib name. etc. * = "+a[1],{file:r.input.file,text:r.input.text,start:i.loc.start.pos,end:i.loc.end.pos});if(n[l])throw new o("duplicate csslib name: "+l,{file:r.input.file,text:r.input.text,start:i.loc.start.pos,end:i.loc.end.pos});if(s.has(l))throw new o("duplicate csslib name: "+l,{file:r.input.file,text:r.input.text,start:i.loc.start.pos,end:i.loc.end.pos});s.add(l)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("m17p-csslibify-gen-css-@csslib",function(t,r){let n,s,i,a,l=r.style,u=l.csslibset=l.csslibset||new Set,c=Object.assign({},r.result.oCsslib),p=e.on("哈希样式类名")[0],f={rename:(e,t)=>p(r.input.file,"*"!==e?t+"@"+e:t)};t.walk("Class",(t,l)=>{let p;for(let e,o=0;e=t.parent.nodes[o++];)if("@csslib"===e.type){p=e;break}if(p){let t=l.value.split("="),o=t.length>1?t[0].trim():"*",r=e.at("样式库",o,p.object.value);c[o]=r}let g=c["*"];l.classes.forEach(e=>{if(n=e.split("@"),s="."+e,n.length<2)return g&&u.add(g.get(s,f));if(!(i=c[n[1]]))throw new o("csslib not found: "+n[1],{file:r.input.file,text:r.input.text,start:l.loc.start.pos,end:l.loc.end.pos});if(s="."+n[0],!(a=i.get(s,f)))throw new o("css class not found: "+e,{file:r.input.file,text:r.input.text,start:l.loc.start.pos,end:l.loc.end.pos});u.add(a)})})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("n15p-astedit-remove-blank-text",function(t,o){const r=e.at("视图编译选项");t.walk(r.TypeText,(e,t)=>{if(!/^\s*$/.test(t.value)||"pre"===e.parent.object.name)return;let o=e.before(),n=e.after();o&&n&&"Tag"!==o.type&&"Tag"!==n.type&&o.type!==r.TypeHtmlComment&&n.type!==r.TypeHtmlComment&&o.type!==r.TypeCodeBlock&&n.type!==r.TypeCodeBlock||e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("n25p-astedit-remove-html-comment",function(t,o){const r=e.at("视图编译选项");t.walk(r.TypeHtmlComment,(e,t)=>{e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("n35p-astedit-join-text-node",function(t,o){const r=e.at("视图编译选项");var n;t.walk(/^(Text|Expression)$/,(e,t)=>{let o=[e],s=e.after();for(;s&&(s.type===r.TypeText||s.type===r.TypeExpression);)o.push(s),s=s.after();if(o.length<2)return;let i=[];o.forEach(e=>{e.type===r.TypeText?i.push('"'+function(e,t='"'){if(null==e)return e;let o=e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n");return'"'==t?o=o.replace(/"/g,'\\"'):"'"==t&&(o=o.replace(/'/g,"\\'")),o}(e.object.value)+'"'):((n=(n=e.object.value).trim()).startsWith("{")&&n.endsWith("}")&&(n=n.substring(1,n.length-1).trim()),!n||/^\/\/.*$/.test(n)&&n.indexOf("\n")<0||n.startsWith("/*")&&n.endsWith("*/")&&n.indexOf("*/")===n.length-2||i.push(e.object.value.replace(/^\s*\{/,"(").replace(/\}\s*$/,")")))});let a=r.ExpressionStart+i.join(" + ")+r.ExpressionEnd,l={start:o[0].object.loc.start,end:o[o.length-1].object.loc.end},u=this.createNode({type:r.TypeExpression,value:a,loc:l});e.before(u),o.forEach(e=>e.remove())})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("n45p-astedit-remove-jscode-blank-comment",function(t,o){const r=e.at("视图编译选项");var n;t.walk(r.TypeCodeBlock,(e,t)=>{(!(n=(n=t.value).trim())||/^\/\/.*$/.test(n)&&n.indexOf("\n")<0||n.startsWith("/*")&&n.endsWith("*/")&&n.indexOf("*/")===n.length-2)&&e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus");e.on("编译模板JS",function(e){return function(){if(!e){let t=new class{constructor(e="",t){let o=function(e,t,n){let s,i=t.indexOf("<%");i<0?e.push(r(e,t,n)):0==i?t.indexOf("<%=")==i?(i=(t=t.substring(3)).indexOf("%>"),s=t.substring(0,i),e.push(e.pop()+"+"+s),o(e,t.substring(i+2),!1)):(i=(t=t.substring(2)).indexOf("%>"),s=t.substring(0,i),n?e.push(s):e.push(e.pop()+";")&&e.push(s),o(e,t.substring(i+2),!0)):(s=t.substring(0,i),e.push(r(e,s,n)),o(e,t.substring(i),!1))},r=function(e,t,o){let r=t.replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\'/g,"\\'");return o?"s+='"+r+"'":e.pop()+"+'"+r+"'"},n=[];n.push("let s=''"),o(n,e,!0),n.push("return s"),this.toString=t?new Function(t,n.join("\n")):new Function(n.join("\n"))}}("\n\n// ------------------------------------------------------------------------------------------------------\n// 组件 <%= $data['COMPONENT_NAME'] %>\n// 注:应通过rpose.newComponentProxy方法创建组件代理对象后使用，而不是直接调用方法或用new创建\n// ------------------------------------------------------------------------------------------------------\n<% if ( $data['singleton'] ){ %>\n    // 这是个单例组件\n    <%= $data['COMPONENT_NAME'] %>.Singleton = true;\n<% } %>\n\n// 属性接口定义\n<%= $data['COMPONENT_NAME'] %>.prototype.$OPTION_KEYS = <%= JSON.stringify($data['optionkeys']) %>;  // 可通过标签配置的属性，未定义则不支持外部配置\n<%= $data['COMPONENT_NAME'] %>.prototype.$STATE_KEYS = <%= JSON.stringify($data['statekeys']) %>;    // 可更新的state属性，未定义则不支持外部更新state\n\n// 组件函数\nfunction <%= $data['COMPONENT_NAME'] %>(options={}) {\n\n    <% if ( $data['optionkeys'] != null ){ %>\n    // 组件默认选项值\n    this.$options = <%= $data['options'] %>;\n    rpose.extend(this.$options, options, this.$OPTION_KEYS);    // 按属性接口克隆配置选项\n    <% }else{ %>\n    // 组件默认选项值\n    this.$options = <%= $data['options'] %>;\n    <% } %>\n\n    <% if ( $data['statekeys'] != null ){ %>\n    // 组件默认数据状态值\n    this.$state = <%= $data['state'] %>;\n    rpose.extend(this.$state, options, this.$STATE_KEYS);       // 按属性接口克隆数据状态\n    <% }else{ %>\n    // 组件默认数据状态值\n    this.$state = <%= $data['state'] %>;\n    <% } %>\n\n    <% if ( $data['actions'] ){ %>\n    // 事件处理器\n    <%= $data['actions'] %>\n    <% } %>\n\n    <% if ( $data['methods'] ){ %>\n    // 自定义方法\n    <%= $data['methods'] %>;\n    <% } %>\n\n    <% if ( $data['updater'] ){ %>\n    // 组件更新函数\n    this.$updater = <%= $data['updater'] %>;\n    <% } %>\n}\n\n/**\n * 节点模板函数\n */\n<%= $data['COMPONENT_NAME'] %>.prototype.nodeTemplate = <%= $data['vnodeTemplate'] %>\n\n".replace(/\\/g,"\\\\"),"$data");e=t.toString}return e}}())})(),require("@gotoeasy/bus").on("表达式代码转换",function(e){let t=e.trim();return t.startsWith("{")&&t.endsWith("}")&&(t=t.substring(1,t.length-1)),`(${t})`}),(()=>{const e=require("@gotoeasy/bus");e.on("astgen-node-text",function(t,o){const r=e.at("视图编译选项");return t.type===r.TypeText?function(e,t){let o=[],r='"'+function(e,t='"'){if(null==e)return e;let o=e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n");return'"'==t?o=o.replace(/"/g,'\\"'):"'"==t&&(o=o.replace(/'/g,"\\'")),o}(e.object.value)+'"';return o.push("{ "),o.push(`  s: ${r} `),o.push(` ,k: ${t.keyCounter++} `),o.push("}"),o.join("\n")}(t,o):t.type===r.TypeExpression?function(e,t){let o=[],r=e.object.value.replace(/^\s*\{/,"(").replace(/\}\s*$/,")");return o.push("{ "),o.push(`  s: ${r} `),o.push(` ,k: ${t.keyCounter++} `),o.push("}"),o.join("\n")}(t,o):""})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("p15p-reference-components",function(t,r){let n=r.result,s=new Set;t.walk("Tag",(t,n)=>{if(!n.standard&&(s.add(n.value),!e.at("标签源文件",n.value)))throw new o("file not found of tag: "+n.value,{file:r.input.file,text:r.input.text,start:n.loc.start.pos})},{readonly:!0}),n.references=[...s]}))})(),(()=>{const e=require("@gotoeasy/bus"),t=/^(onclick|onchange|onabort|onafterprint|onbeforeprint|onbeforeunload|onblur|oncanplay|oncanplaythrough|oncontextmenu|oncopy|oncut|ondblclick|ondrag|ondragend|ondragenter|ondragleave|ondragover|ondragstart|ondrop|ondurationchange|onemptied|onended|onerror|onfocus|onfocusin|onfocusout|onformchange|onforminput|onhashchange|oninput|oninvalid|onkeydown|onkeypress|onkeyup|onload|onloadeddata|onloadedmetadata|onloadstart|onmousedown|onmouseenter|onmouseleave|onmousemove|onmouseout|onmouseover|onmouseup|onmousewheel|onoffline|ononline|onpagehide|onpageshow|onpaste|onpause|onplay|onplaying|onprogress|onratechange|onreadystatechange|onreset|onresize|onscroll|onsearch|onseeked|onseeking|onselect|onshow|onstalled|onsubmit|onsuspend|ontimeupdate|ontoggle|onunload|onunload|onvolumechange|onwaiting|onwheel)$/i;function o(e,t='"'){if(null==e)return e;let o=e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n");return'"'==t?o=o.replace(/"/g,'\\"'):"'"==t&&(o=o.replace(/'/g,"\\'")),o}e.on("astgen-node-attributes",function(r,n){if(!r.nodes)return"";let s;for(let e,t=0;e=r.nodes[t++];)if("Attributes"===e.type){s=e;break}if(!s||!s.nodes||!s.nodes.length)return"";let i,a,l="",u=[];return u.push("{ "),s.nodes.forEach(s=>{if(i='"'+o(s.object.name)+'"',s.object.isExpression)a=e.at("表达式代码转换",s.object.value);else if("string"==typeof s.object.value)if(!r.object.standard&&t.test(s.object.name)&&!s.object.isExpression&&n.script.$actionkeys){let e=s.object.value.trim(),t=e.startsWith("$actions.")?e.substring(9):e;a=n.script.$actionkeys.includes(t)?`$actions['${t}']`:'"'+o(s.object.value)+'"'}else a='"'+o(s.object.value)+'"';else a=s.object.value;u.push(` ${l} ${i}: ${a} `),!l&&(l=",")}),u.push(" } "),u.join("\n")})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/err");e.on("astgen-node-events",function(o,r){if(!o.nodes)return"";let n;for(let e,t=0;e=o.nodes[t++];)if("Events"===e.type){n=e;break}if(!n||!n.nodes||!n.nodes.length)return"";let s,i,a="",l=[];return l.push("{ "),n.nodes.forEach(o=>{if(s=o.object.name.substring(2),i=o.object.value,o.object.isExpression)i=e.at("表达式代码转换",i);else{let e=(i=i.trim()).startsWith("$actions.")?i.substring(9):i;if(!r.script.$actionkeys||!r.script.$actionkeys.includes(e))throw new t("action not found: "+e,{file:r.input.file,text:r.input.text,start:o.object.loc.start.pos,end:o.object.loc.end.pos});i="$actions."+i}l.push(` ${a} ${s}: ${i} `),!a&&(a=",")}),l.push(" } "),l.join("\n")})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/err");function t(e,t='"'){if(null==e)return e;let o=e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n");return'"'==t?o=o.replace(/"/g,'\\"'):"'"==t&&(o=o.replace(/'/g,"\\'")),o}e.on("astgen-node-style",function(e,o){if(!e.nodes)return"";let r;for(let t,o=0;t=e.nodes[o++];)if("Style"===t.type){r=t;break}if(!r||!r.object.value)return"";if(!r.object.isExpression)return'"'+t(r.object.value)+'"';let n=[];return function e(o,r){if(/^\{\s*\{[\s\S]*?\}\s*\}$/.test(r))return void o.push(r.replace(/^\{/,"").replace(/\}$/,""));let n=r.indexOf("{");if(n<0)return void o.push('"'+t(r)+'"');let s=r.indexOf("}",n);if(s<0)return void o.push('"'+t(r)+'"');n>0&&o.push('"'+t(r.substring(0,n))+'"'),o.push("("+r.substring(n+1,s)+")");let i=r.substring(s+1);i&&e(o,i)}(n,r.object.value),"("+n.join(" + ")+")"})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/err");e.on("astgen-node-class",function(t,o){if(!t.nodes)return"";let r;for(let e,o=0;e=t.nodes[o++];)if("Class"===e.type){r=e;break}return r&&r.object.value?function(t,o){let r={},n=(t=t.replace(/\{.*?\}/g,function(t){let n,s,i,a=t.substring(1,t.length-1);for(;a.indexOf(":")>0;){n=a.indexOf(":"),s=a.substring(0,n).replace(/['"]/g,"");let t=(i=a.substring(n+1)).indexOf(":");t>0?(i=(i=i.substring(0,t)).substring(0,i.lastIndexOf(",")),a=a.substring(n+1+i.length+1)):a="",r[e.at("哈希样式类名",o,s.trim())]="@("+i+")@"}return""})).split(/\s/);for(let t=0;t<n.length;t++)n[t].trim()&&(r[e.at("哈希样式类名",o,n[t].trim())]=1);return JSON.stringify(r).replace(/('@|@'|"@|@")/g,"")}(r.object.value,o.input.file):""})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/err");e.on("astgen-node-{prop}",function(e,t){if(!e.nodes)return"";let o;for(let t,r=0;t=e.nodes[r++];)if("ObjectExpressionAttributes"===t.type){o=t;break}if(!o||!o.nodes||!o.nodes.length)return"";let r,n=[];return o.nodes.forEach(e=>{r=e.object.name.replace(/^\s*\{=?/,"(").replace(/\}\s*$/,")"),n.push(r)}),n.join(",")})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/hash");function t(t,o){if("Tag"!==t.type)return"";let r=t.object,n="View"===t.parent.type,s=!t.object.standard,i=e.at("astgen-node-tag-nodes",t.nodes,o),a=e.at("astgen-node-attributes",t,o),l=e.at("astgen-node-events",t,o),u=t.object.svg,c=e.at("astgen-node-style",t,o);c&&(a=a?a.replace(/\}\s*$/,`,style: ${c}}`):`{style: ${c}}`);let p=e.at("astgen-node-class",t,o);p&&(a=a?a.replace(/\}\s*$/,`,class: ${p}}`):`{class: ${p}}`);let f=e.at("astgen-node-{prop}",t,o);f&&(a=`rpose.assign( ${a}, ${f})`);let g=[];return g.push("{ "),g.push(`  t: '${r.value}' `),n&&g.push(" ,r: 1 "),s&&g.push(" ,m: 1 "),u&&g.push(" ,g: 1 "),g.push(` ,k: ${o.keyCounter++} `),i&&g.push(` ,c: ${i} `),a&&g.push(` ,a: ${a} `),l&&g.push(` ,e: ${l} `),g.push("}"),g.join("\n")}e.on("astgen-node-tag",t)})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/err"),o="_Ary";function r(r=[],n){return r.length?function(e){for(let t,o=0;t=e[o++];)if("JsCode"===t.type)return!0;return!1}(r)?function(r=[],n){let s,i=[];i.push(` ((${o}) => { `);for(let a,l=0;a=r[l++];)if("JsCode"===a.type)i.push(a.object.value);else if(s=e.at("astgen-node-tag",a,n))i.push(` ${o}.push( ${s} ); `);else if(s=e.at("astgen-node-text",a,n))i.push(` ${o}.push( ${s} ); `);else if("Attributes"===a.type||"Events"===a.type||"ObjectExpressionAttributes"===a.type);else if("Class"!==a.type&&"Style"!==a.type)throw new t("unhandle node type: "+a.type);return i.push(` return ${o}; `),i.push(" })([]) "),i.join("\n")}(r,n):function(t=[],o){let r,n=[];return t.forEach(t=>{(r=e.at("astgen-node-tag",t,o))&&n.push(r),(r=e.at("astgen-node-text",t,o))&&n.push(r)}),"["+n.join(",\n")+"]"}(r,n):""}e.on("astgen-node-tag-nodes",r)})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/file"),r=require("@gotoeasy/csjs");require("@gotoeasy/err");e.on("编译插件",t.plugin("s15p-component-ast-jsify-writer",function(e,t){t.writer=new class{constructor(){this.ary=[]}push(e){void 0!==e&&this.ary.push(e)}write(e){void 0!==e&&this.ary.push(e)}out(e){o.write(e,this.toString())}getArray(){return this.ary}toString(){let e=this.ary.join("\n");try{return r.formatJs(e)}catch(t){throw o.write(process.cwd()+"/build/error/format-error.js",e),t}}}}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=(require("@gotoeasy/file"),require("@gotoeasy/csjs"),require("@gotoeasy/err")),r="v_Array";e.on("编译插件",t.plugin("s25p-component-ast-jsify-root",function(t,n){let s=n.writer,i=n.script;t.walk("View",(t,a)=>!t.nodes||t.nodes.length<1?s.write("// 没有节点，无可生成"):(s.write("function nodeTemplate($state, $options, $actions, $this) {"),function(e){for(let t,o=0;t=e[o++];)if("JsCode"===t.type)return!0;return!1}(t.nodes)?s.write(`${function(t=[],n){let s,i=[];i.push(` let ${r} = []; `);for(let a,l=0;a=t[l++];)if("JsCode"===a.type)i.push(a.object.value);else if(s=e.at("astgen-node-tag",a,n))i.push(` ${r}.push( ${s} ); `);else{if(!(s=e.at("astgen-node-text",a,n)))throw new o("unhandle node type");i.push(` ${r}.push( ${s} ); `)}return i.push(` ${r}.length > 1 && console.warn("invlid tag count"); `),i.push(` return ${r}.length ? v_Array[0] : null; `),i.join("\n")}(t.nodes,n)}`):s.write(`${function(t=[],r){if(t.length>1){let e=r.input.text,n=r.input.file,s=t[1].object.loc.start.pos;throw"Tag"!==t[0].type&&(s=t[0].object.loc.start.pos),new o("invalid top tag",{text:e,file:n,start:s})}let n,s=t[0];if("Tag"!==s.type){let e=r.input.text,n=r.input.file,s=t[0].object.loc.start.pos;throw new o("missing top tag",{text:e,file:n,start:s})}if(n=e.at("astgen-node-tag",s,r))return`return ${n}`;if(n=e.at("astgen-node-text",s,r))return`return ${n}`;throw new o("unhandle node type")}(t.nodes,n)}`),s.write("}"),i.vnodeTemplate=s.toString(),!1))}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/csjs"),o=require("@gotoeasy/file"),r=require("@gotoeasy/postobject"),n=require("@gotoeasy/err"),s=require("acorn-globals"),i="$$,require,window,location,clearInterval,setInterval,assignOptions,rpose,$SLOT,Object,Map,Set,WeakMap,WeakSet,Date,Math,Array,String,Number,JSON,Error,Function,arguments,Boolean,Promise,Proxy,Reflect,RegExp,alert,console,window,document".split(",");e.on("编译插件",r.plugin("s35p-component-gen-js",function(r,a){let l=e.at("编译环境"),u=a.result,c=a.script,p=(a.writer,e.at("编译模板JS")),f={};if(f.COMPONENT_NAME=e.at("组件类名",a.input.file),f.options=a.doc.options||"{}",f.state=a.doc.state||"{}",a.doc.api&&(f.optionkeys=a.doc.api.optionkeys,f.statekeys=a.doc.api.statekeys),f.actions=c.actions,f.methods=c.methods,f.updater=c.updater,f.vnodeTemplate=c.vnodeTemplate,u.componentJs=p(f),u.componentJs=function(e,t){let o,r=t.doc.api.optionkeys||[],a=t.doc.api.statekeys||[];try{if(!(o=s(e)).length)return e}catch(o){throw n.cat("source syntax error","\n-----------------",e,"\n-----------------","file="+t.input.file,o)}let l=[];for(let e,s=0;s<o.length;s++){e=o[s];let u=r.includes(e.name),c=a.includes(e.name),p=i.includes(e.name);if(!u&&!c&&!p){let o="template variable undefined: "+e.name;throw o+="\n  file: "+t.input.file,new n(o)}if(u&&c){let o="template variable uncertainty: "+e.name;throw o+="\n  file: "+t.input.file,new n(o)}c?l.push(`let ${e.name} = $state.${e.name};`):u&&l.push(`let ${e.name} = $options.${e.name};`)}return e.replace(/(\n.+?prototype\.nodeTemplate\s*=\s*function\s+.+?\r?\n)/,"$1"+l.join("\n"))}(u.componentJs,a),!l.release){let r=l.path.build_temp+"/"+e.at("组件目标文件名",a.input.file)+".js";o.write(r,t.formatJs(u.componentJs))}}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/file");require("@gotoeasy/csjs"),require("@gotoeasy/err");e.on("编译插件",t.plugin("s45p-component-gen-css",function(t,r){let n=r.style,s=[];n.csslibset&&s.push(...n.csslibset),n.less&&s.push(n.less),n.scss&&s.push(n.scss),n.css&&s.push(n.css),r.result.css=e.at("组件样式类名哈希化",r.input.file,s.join("\n"));let i=e.at("编译环境"),a=i.path.build_temp+"/"+e.at("组件目标文件名",r.input.file)+".css";i.release||(r.result.css?o.write(a,r.result.css):o.remove(a))}))})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/file"),require("@gotoeasy/postobject"));require("@gotoeasy/err");e.on("编译插件",t.plugin("w15p-component-complie-result-cache",function(t,o){e.at("组件编译缓存",o.input.file,o)}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("y15p-page-all-reference-components",function(t,o){if(!o.result.isPage)return!1;let r=new Set,n={};if(o.result.references.forEach(t=>{!function t(o,r,n){if(n[o])return;r.add(o),n[o]=!0;let s=e.at("标签源文件",o),i=e.at("组件编译缓存",s);i||(i=e.at("编译组件",s));let a=i.result.references;a.forEach(e=>{t(e,r,n)})}(t,r,n)}),r.has(o.result.tagpkg))throw new Err("circular reference: "+o.result.tagpkg);let s=[...r];s.sort(),s.push(o.result.tagpkg),o.result.allreferences=s}))})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/file")),o=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",o.plugin("y25p-page-gen-html",function(o,r){if(!r.result.isPage)return!1;let n=e.at("编译环境"),s=n.path.src,i=r.input.file,a=t.name(i),l=r.doc.api.prerender;r.result.html=require(n.prerender)({srcPath:s,file:i,name:a,type:l})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/csjs"),o=require("@gotoeasy/hash"),r=require("@gotoeasy/file"),n=require("postcss");e.on("页面样式后处理",(s,i)=>{let a,l=e.at("编译环境"),u=e.at("缓存目录")+"/from.css",c=e.at("页面目标CSS文件名",i),p=e.at("页面图片相对路径",i),f=e.at("browserslist"),g=o(p),d=o(s),h=`${e.at("缓存目录")}/pack-page-css-${f}/${g}-${d}.css`,b=[],y={url:"copy",basePath:e.at("缓存目录")+"/resources",assetsPath:p,useHash:!1};if(!l.nocache&&r.existsFile(h))return(a=r.read(h)).indexOf("url(")>0&&(b.push(require("postcss-url")(y)),n(b).process(s,{from:u,to:c}).sync().root.toResult()),a;b.push(require("postcss-discard-comments")({remove:e=>1})),b.push(require("postcss-normalize-whitespace")),b.push(require("postcss-discard-empty")),b.push(require("postcss-discard-duplicates")),b.push(require("autoprefixer")()),b.push(require("postcss-url")(y)),b.push(require("postcss-merge-rules")());let m=n(b).process(s,{from:u,to:c}).sync().root.toResult();return a=l.release?m.css:t.formatCss(m.css),r.write(h,a),a})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("y35p-page-gen-css-link-components",function(t,o){if(!o.result.isPage)return!1;e.at("编译环境");let r=[];o.result.allreferences.forEach(t=>{let o=e.at("组件编译缓存",e.at("标签源文件",t));o||(o=e.at("编译组件",t)),o.result.css&&r.push(o.result.css)}),o.result.css=r.join("\n"),o.result.pageCss=e.at("页面样式后处理",o.result.css,o.input.file)}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/file"),o=require("resolve-pkg");e.on("RPOSE运行时代码",function(e){return function(){if(!e){let r=t.resolve(o("@rpose/runtime",{cwd:__dirname}),"runtime.js");e=t.read(r)}return e}}())})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/file")),o=require("@gotoeasy/postobject"),r=require("@gotoeasy/err"),n=require("fs");e.on("编译插件",o.plugin("y55p-page-gen-js-link-runtime-components",function(o,s){if(!s.result.isPage)return!1;let i=e.at("编译环境"),a=s.result.allreferences,l=e.at("RPOSE运行时代码"),u=function(o){try{let n={};for(let s,i,a,l=0;s=o[l++];){if(i="'"+s+"'",a=e.at("标签源文件",s),!t.exists(a))throw new r("component not found (tag = "+s+")");n[i]=e.at("组件类名",a)}return`rpose.registerComponents(${JSON.stringify(n).replace(/"/g,"")});`}catch(e){throw r.cat(MODULE+"gen register stmt failed",o,e)}}(a),c=function(t){try{let o=[];for(let r,n,s=0;r=t[s++];)(n=e.at("组件编译缓存",e.at("标签源文件",r)))||(n=e.at("编译组件",r)),o.push(n.result.componentJs);return o.join("\n")}catch(e){throw r.cat(MODULE+"get component src failed",t,e)}}(a),p=e.at("缓存目录")+"/resources",f=e.at("页面图片相对路径",s.input.file),g=`\n                ${l}\n\n                (function($$){\n                    // 组件注册\n                    ${u}\n\n                    ${c=c.replace(/\%imagepath\%([0-9a-z]+\.[0-9a-zA-Z]+)/g,function(e,o){let r=p+"/"+o,s=i.path.build_dist+"/"+(i.path.build_dist_images?i.path.build_dist_images+"/":"")+o;return t.existsFile(r)&&!t.existsFile(s)&&(t.mkdir(s),n.copyFileSync(r,s)),f+o})}\n\n                    // 组件挂载\n                    rpose.mount( rpose.newComponentProxy('${s.result.tagpkg}').render(), '${s.doc.mount}' );\n                })(rpose.$$);\n            `;s.result.pageJs=g}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/csjs"),o=require("@gotoeasy/file"),r=require("@gotoeasy/postobject"),n=(require("@gotoeasy/err"),require("@gotoeasy/hash"));e.on("编译插件",r.plugin("y65p-page-gen-js-babel",function(r,s){if(!s.result.isPage)return!1;let i=e.at("编译环境"),a=e.at("browserslist"),l=n(s.result.pageJs),u=`${e.at("缓存目录")}/${a}-babel/${l}-babel.js`;if(!i.nocache&&o.existsFile(u))return s.result.babelJs=o.read(u);try{s.result.babelJs=t.babel(s.result.pageJs),o.write(u,s.result.babelJs)}catch(e){throw o.write(i.path.build+"/error/babel.log",s.result.pageJs+"\n\n"+e.stack),e}}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/csjs"),o=require("@gotoeasy/file"),r=require("@gotoeasy/postobject"),n=(require("@gotoeasy/err"),require("@gotoeasy/hash"));e.on("编译插件",r.plugin("y75p-page-gen-js-browserify-minformat",function(r,s){if(!s.result.isPage)return!1;let i=e.at("编译环境"),a=e.at("browserslist"),l=n(s.result.babelJs),u=i.release?"min":"format",c=`${e.at("缓存目录")}/${a}-browserify-${u}/${l}-browserify-${u}.js`;if(!i.nocache&&o.existsFile(c))return s.result.browserifyJs=Promise.resolve(o.read(c));s.result.browserifyJs=new Promise((e,r)=>{(new Date).getTime(),t.browserify(s.result.babelJs,null).then(r=>{r=i.release?t.miniJs(r):t.formatJs(r),o.write(c,r),e(r)}).catch(e=>{o.write(i.path.build+"/error/browserify.log",s.result.babelJs+"\n\n"+e.stack),r(e)})})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/hash")),o=require("@gotoeasy/file"),r=require("@gotoeasy/postobject");require("@gotoeasy/err"),require("fs");e.on("编译插件",r.plugin("y85p-write-page",function(r,n){if(!n.result.isPage)return!1;let s,i=e.at("编译环境"),a=(e.at("browserslist"),(new Date).getTime());n.result.browserifyJs.then(r=>{let l=e.at("页面目标HTML文件名",n.input.file),u=e.at("页面目标CSS文件名",n.input.file),c=e.at("页面目标JS文件名",n.input.file),p=n.result.html,f=n.result.pageCss,g=r;n.result.js=g,o.write(u,f),o.write(c,g),o.write(l,p),i.watch&&(n.result.hashcode=t(p+f+g)),s=(new Date).getTime()-a,console.info("[pack]",s+"ms -",l.substring(i.path.build_dist.length+1))}).catch(e=>{console.error("[pack]",e)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/file"),require("@gotoeasy/postobject"),require("@gotoeasy/err"),require("@gotoeasy/hash")),o=require("browserslist");e.on("browserslist",function(){let e=o();return t(e.join("\n"))})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/hash");e.on("哈希样式类名",function(o,r){let n=r;if(n.startsWith("_"))return n;const s=e.at("编译环境");if(r.indexOf("@")>0){let e=r.split("@");n=`${e[1]}---${e[0]}`}else if(n.indexOf("---")>0||n.indexOf("___")>0||n.startsWith("_"));else{let s=e.at("标签全名",o);n=`${r}___${t(s)}`}return s.release?"_"+t(n.toLowerCase()):n})})(),(()=>{require("@gotoeasy/err");const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/hash"),require("postcss")),o=require("css-selector-tokenizer");e.on("组件样式类名哈希化",function(r,n){return t([(t,n)=>{t.walkRules(t=>{let n=o.parse(t.selector);(n.nodes||[]).forEach(t=>{"selector"===t.type&&(t.nodes||[]).forEach(t=>{"class"===t.type&&(t.name=e.at("哈希样式类名",r,t.name))})}),t.selector=o.stringify(n)})}]).process(n,{from:"from.css"}).sync().root.toResult().css})})(),(()=>{const e=require("@gotoeasy/file"),t=require("@gotoeasy/bus"),o=require("@gotoeasy/npm"),r=(require("@gotoeasy/hash"),require("find-node-modules"));t.on("标签全名",t=>{let o=t.indexOf(":");if(o>0&&t.substring(o).indexOf(".")<0)return t;let r="";if((o=t.lastIndexOf("/node_modules/"))>0){let n=t.substring(o+14).split("/");r=n[0].startsWith("@")?n[0]+"/"+n[1]+":"+e.name(t):n[0]+":"+e.name(t)}else r=e.name(t);return r}),t.on("标签源文件",e=>{if(e.endsWith(".rpose"))return e;if(e.indexOf(":")>0){let o=e.split(":");o[0].indexOf("=")>0&&(o=o[0].split("="));let r=t.at("模块组件信息",o[0].trim()),n=r.files,s="/"+o[1]+".rpose";for(let e,t=0;e=n[t++];)if(e.endsWith(s))return e;return t.at("标签库引用",e,r.config)}{let o=t.at("标签项目源文件",e);if(o)return o;let r=t.at("编译环境");return t.at("标签库引用",e,r.path.root)}}),t.on("文件所在模块",e=>{let t="/",o=e.lastIndexOf("/node_modules/");if(o>0){let r=e.substring(o+14).split("/");t=r[0].startsWith("@")?r[0]+"/"+r[1]:r[0]}return t}),t.on("文件所在项目根目录",e=>{let o,r=e.lastIndexOf("/node_modules/");if(r>0){let t=[];t.push(e.substring(0,r+13));let n=e.substring(r+14).split("/");n[0].startsWith("@")?(t.push(n[0]),t.push(n[1])):t.push(n[0]),o=t.join("/")}else o=t.at("编译环境").path.root;return o}),t.on("文件所在项目配置文件",o=>{let r,n=o.lastIndexOf("/node_modules/");if(n>0){let e=[];e.push(o.substring(0,n+13));let t=o.substring(n+14).split("/");t[0].startsWith("@")?(e.push(t[0]),e.push(t[1])):e.push(t[0]),e.push("rpose.config.btf"),r=e.join("/")}else r=t.at("编译环境").path.root+"/rpose.config.btf";if(e.existsFile(r))return r}),t.on("模块组件信息",function(o=new Map){return function(n){if(n.indexOf(":")>0&&(n=n.substring(0,n.indexOf(":"))),n.lastIndexOf("@")>0&&(n=n.substring(0,n.lastIndexOf("@"))),n=n.toLowerCase(),!o.has(n)){let s=t.at("编译环境"),i=[...r({cwd:s.path.root,relative:!1}),...r({cwd:__dirname,relative:!1})];for(let t,r,s=0;t=i[s++];)if(r=e.resolve(t,n).replace(/\\/g,"/"),e.existsDir(r)){let t=JSON.parse(e.read(e.resolve(r,"package.json"))),n=t.version,s=t.name,i=s+"@"+n,a=e.files(r,"/src/**.rpose"),l=e.resolve(r,"rpose.config.btf");o.set(s,{path:r,pkg:i,name:s,version:n,files:a,config:l});break}}return o.get(n)||{files:[],config:""}}}()),t.on("组件类名",e=>{let o=t.at("标签全名",t.at("标签源文件",e));return o=("-"+(o=o.replace(/[@\/`]/g,"$").replace(/\./g,"_").replace(":","$-"))).split("-").map(e=>e.substring(0,1).toUpperCase()+e.substring(1)).join("")}),t.on("组件目标文件名",function(o){let r=t.at("编译环境");return o.startsWith(r.path.src_buildin)?"$buildin/"+e.name(o):t.at("标签全名",o).replace(":","/")}),t.on("页面目标JS文件名",function(e){let o=t.at("编译环境");return o.path.build_dist+e.substring(o.path.src.length,e.length-6)+".js"}),t.on("页面目标CSS文件名",function(e){let o=t.at("编译环境");return o.path.build_dist+e.substring(o.path.src.length,e.length-6)+".css"}),t.on("页面目标HTML文件名",function(e){let o=t.at("编译环境");return o.path.build_dist+e.substring(o.path.src.length,e.length-6)+".html"}),t.on("自动安装",function(e={}){return function(t){return t.indexOf(":")>0&&(t=t.substring(0,t.indexOf(":"))),t.lastIndexOf("@")>0&&(t=t.substring(0,t.lastIndexOf("@"))),e[t]||(o.isInstalled(t)?e[t]=!0:e[t]=o.install(t,{timeout:6e4})),e[t]}}()),t.on("页面图片相对路径",e=>{let o=t.at("编译环境"),r=e.substring(o.path.src.length).split("/");return("../".repeat(r.length-2)+o.path.build_dist_images||".")+"/"})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("z99p-log",function(e,t){}))})(),console.timeEnd("load");const bus=require("@gotoeasy/bus"),npm=require("@gotoeasy/npm"),Err=require("@gotoeasy/err"),File=require("@gotoeasy/file"),postobject=require("@gotoeasy/postobject");async function build(e){console.time("build");try{bus.at("编译环境",e);bus.at("clean"),await Promise.all(bus.at("全部编译"))}catch(e){console.error(Err.cat("build failed",e).toString())}console.timeEnd("build")}function clean(e){console.time("clean");try{bus.at("编译环境",e);bus.at("clean")}catch(e){console.error(Err.cat("clean failed",e).toString())}console.timeEnd("clean")}async function watch(e){await build(e),bus.at("文件监视")}module.exports={build,clean,watch};