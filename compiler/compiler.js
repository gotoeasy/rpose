console.time("load"),(()=>{const e=require("@gotoeasy/file"),t=require("@gotoeasy/btf"),o=require("@gotoeasy/bus"),s=(require("@gotoeasy/util"),require("@gotoeasy/err")),r=require("@gotoeasy/npm"),n=require("path");o.on("编译环境",function(o){return function(i){if(o)return o;let a=e.resolve(__dirname,"./package.json");!e.existsFile(a)&&(a=e.resolve(__dirname,"../package.json"));let l=JSON.parse(e.read(a)).version,u=e.path(a)+"/default.rpose.config.btf";return(o=function(o,i,a){let l=a.cwd||process.cwd();if(l=n.resolve(l).replace(/\\/g,"/"),!e.existsDir(l))throw new s("invalid path of cwd: "+a.cwd);let u=l;o=e.resolve(u,o),e.exists(o)||(o=i);let c={path:{}},p=new t(o),f=p.getMap("path");f.forEach((e,t)=>f.set(t,e.split("//")[0].trim()));let g={};return p.getMap("taglib").forEach((e,t)=>g[t]=e.split("//")[0].trim()),c.imports=g,c.path.cwd=l,c.path.root=u,c.path.src=u+"/src",c.path.build=function(e,t,o,s){return t.get(o)?e+"/"+t.get(o).split("/").filter(e=>!!e).join("/"):e+"/"+s.split("/").filter(e=>!!e).join("/")}(u,f,"build","build"),c.path.build_temp=c.path.build+"/temp",c.path.build_dist=c.path.build+"/dist",c.path.build_dist_images=f.get("build_dist_images")||"images",c.path.cache=f.get("cache"),c.theme=null!=p.getText("theme")&&p.getText("theme").trim()?p.getText("theme").trim():"@gotoeasy/theme",c.prerender=null!=p.getText("prerender")&&p.getText("prerender").trim()?p.getText("prerender").trim():"@gotoeasy/pre-render",function(...t){let o=["@gotoeasy/theme","@gotoeasy/pre-render"],s=[...require("find-node-modules")({cwd:__dirname,relative:!1}),...require("find-node-modules")({cwd:process.cwd(),relative:!1})];for(let n,i=0;n=t[i++];){if(o.includes(n))continue;let t=!1;for(let o,r=0;o=s[r++];)e.isDirectoryExists(e.resolve(o,n))&&(t=!0);!t&&r.install(n)}}(c.theme,c.prerender),c}("rpose.config.btf",u,i)).clean=!!i.clean,o.release=!!i.release,o.debug=!!i.debug,o.nocache=!!i.nocache,o.build=!!i.build,o.watch=!!i.watch,o.compilerVersion=l,o.path.cache&&(o.path.cache=e.resolve(o.path.cwd,o.path.cache)),o}}())})(),(()=>{const e=require("@gotoeasy/err"),t=require("@gotoeasy/file"),o=require("@gotoeasy/bus");o.on("clean",()=>{try{let s=o.at("编译环境");s.clean&&(t.remove(s.path.build),console.info("clean:",s.path.build)),t.mkdir(s.path.build_dist)}catch(t){throw e.cat(" clean failed",t)}})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/cache"),o=require("csslibify");!function(s={},r,n){e.on("组件编译缓存",function(e,t){return t?(s[e]=t,t):void 0===t?s[e]:void delete s[e]}),e.on("缓存",function(){if(!r){let o=e.at("编译环境");r=t({name:"rpose-compiler-"+o.compilerVersion,path:o.path.cache})}return r}),e.on("缓存资源目录数组",function(){return n||(n=[e.at("缓存").path+"/resources",o().basePath]),n})}()})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/os"),require("@gotoeasy/hash")),o=require("@gotoeasy/file");function s(e){let t=o.name(e);if(!/[^a-zA-Z0-9_\-]/.test(t)&&/^[a-zA-Z]/.test(t))return t.toLowerCase()}function r(t,s){let r=e.at("页面目标HTML文件名",t),n=e.at("页面目标CSS文件名",t),i=e.at("页面目标JS文件名",t);o.existsFile(r)&&(o.write(r,function(e=""){return`<!doctype html><html lang="en"><head><meta charset="utf-8"></head><body>Page build failed or src file removed<p/>\n        <pre style="background:#333;color:#ddd;padding:10px;">${e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre>\n    </body>`}(s)),o.remove(n),o.remove(i))}!function(n,i={}){function a(e,s){let r=o.read(e);return{file:e,text:r,hashcode:t(r),tag:s}}function l(t){if(!t)return[];let o=[];for(let s in n){let r=e.at("组件编译缓存",s);if(r){(r.result.allreferences||[]).includes(t)&&o.push(s)}}return o}e.on("标签项目源文件",function(e){let t=i[e];if(t&&t.length)return t[0]}),e.on("源文件对象清单",function(){if(!n){n={};let t=e.at("编译环境");o.files(t.path.src,"**.rpose").forEach(e=>{let t=s(e);if(t){let o=i[t]=i[t]||[];o.push(e),1===o.length&&(n[e]=a(e,t))}else console.error("[src-file-manager]","ignore invalid source file ..........",e)});for(let e in i){let t=i[e];if(t.length>1){console.error("[src-file-manager]","duplicate tag name:",e),console.error(t);for(let e,o=1;e=t[o++];)console.error("  ignore ..........",e)}}}return n}),e.on("源文件添加",function(t){let o=s(t.file);if(!o)return console.error("[src-file-manager]","invalid source file name ..........",t.file);let r=i[o]=i[o]||[];return r.push(t.file),r.length>1?(console.error("[src-file-manager]","duplicate tag name:",o),console.error(r),void console.error("  ignore ..........",t.file)):(n[t.file]=a(t.file,o),e.at("全部编译"))}),e.on("源文件修改",function(t){let o=s(t.file),i=l(o),a=n[t.file];if(o&&a){if(a.hashcode!==t.hashcode)return n[a.file]=Object.assign({},t),i.forEach(t=>{e.at("组件编译缓存",t,!1),r(t,`rebuilding for component [${o}] changed`)}),e.at("组件编译缓存",a.file,!1),e.at("全部编译")}else delete n[t.file]}),e.on("源文件删除",function(t){let o=s(t),u=l(o),c=n[t],p=i[o];if(delete n[t],p){let s=p.indexOf(t);if(s>0)return p.splice(s,1);0===s&&(p.splice(s,1),p.length?(n[p[0]]=a(p[0],o),e.at("组件编译缓存",p[0],!1)):delete i[o])}if(o&&c)return u.forEach(t=>{e.at("组件编译缓存",t,!1),r(t,`rebuilding for component [${o}] removed`)}),e.at("组件编译缓存",c.file,!1),e.at("全部编译")})}()})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/os"),require("@gotoeasy/file")),o=require("@gotoeasy/err"),s=require("@gotoeasy/hash"),r=require("chokidar");async function n(t,s){console.time("build");let r=e.at(t,s);if(r)for(let e,t=0;e=r[t++];)try{await e}catch(e){console.error(o.cat("build failed",e).toString())}console.timeEnd("build")}function i(e){let o=t.name(e);return!(/[^a-zA-Z0-9_\-]/.test(o)||!/^[a-zA-Z]/.test(o))}e.on("文件监视",function(o={}){return function(){let a,l=e.at("编译环境");l.watch&&(e.at("热刷新服务器"),r.watch(l.path.src).on("add",async e=>{if(a&&(e=e.replace(/\\/g,"/"))&&/\.rpose$/i.test(e))if(i(e)){console.info("add ......",e);let r=t.read(e),i={file:e,text:r,hashcode:s(r)};o[e]=i,await n("源文件添加",i)}else console.info("ignored ...... add",e)}).on("change",async e=>{if(a&&(e=e.replace(/\\/g,"/"))&&/\.rpose$/i.test(e))if(i(e)){let r=t.read(e),i=s(r);if(!o[e]||o[e].hashcode!==i){console.info("change ......",e);let t={file:e,text:r,hashcode:i};o[e]=t,await n("源文件修改",t)}}else console.info("ignored ...... change",e)}).on("unlink",async e=>{a&&(e=e.replace(/\\/g,"/"))&&/\.rpose$/i.test(e)&&(i(e)?(console.info("del ......",e),delete o[e],await n("源文件删除",e)):console.info("ignored ...... del",e))}).on("ready",()=>{a=!0}))}}())})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/os"),require("@gotoeasy/file");e.on("全部编译",function(){let t=e.at("源文件对象清单"),o=e.at("编译环境");e.at("项目配置处理",o.path.root+"rpose.config.btf");let s,r,n=[];for(let i in t){s=(new Date).getTime();let a=e.at("编译组件",t[i]);a.result.browserifyJs&&n.push(a.result.browserifyJs),(r=(new Date).getTime()-s)>100&&console.info("[compile] "+r+"ms -",i.replace(o.path.src+"/",""))}return n})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/file"),o=require("@gotoeasy/hash"),s=require("@gotoeasy/postobject");e.on("编译组件",function(r){let n;if(r.file)n=r;else{let s,i,a;if(s=e.at("标签源文件",r),!t.existsFile(s))throw new Err(`file not found: ${s} (${r})`);n={file:s,text:i=t.read(s),hashcode:a=o(i)}}let i=e.at("编译环境"),a=e.at("组件编译缓存",n.file);if(a&&a.input.hashcode!==n.hashcode&&(a=e.at("组件编译缓存",n.file,!1)),!a){let t=e.on("编译插件");return s(t).process({...n},{log:i.debug})}return a})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/file"),o=require("@gotoeasy/hash"),s=require("fs"),r=require("url"),n=require("path"),i=require("http"),a=require("opn"),l="rebuilding...";e.on("热刷新服务器",function(u){return function(){let c=e.at("编译环境");c.watch&&function(c,p){i.createServer(function(i,a){let p=r.parse(i.url);if(/^\/query$/i.test(p.pathname))return void function(s,r,n){u=!0;let i=e.at("编译环境"),a=n.query.split("&")[0].split("=")[1],c=t.resolve(i.path.src,a.substring(0,a.length-5)+".rpose"),p="";if(t.existsFile(c)){let s=e.at("组件编译缓存",c);if(s&&(p=s.result.hashcode||""),!p){let s=e.at("页面目标HTML文件名",c),r=e.at("页面目标CSS文件名",c),n=e.at("页面目标JS文件名",c);if(t.existsFile(s)){let e=t.read(s);if(e.indexOf("<body>Page build failed or src file removed<p/>")>0)p=l;else{let s=t.existsFile(r)?t.read(r):"",i=t.existsFile(n)?t.read(n):"";p=o(e+s+i)}}}}r.writeHead(200),r.end(p)}(0,a,p);let f=n.join(c,p.pathname).replace(/\\/g,"/");t.existsDir(f)&&(f=t.resolve(f,"index.html")),/\.html$/i.test(f)?t.existsFile(f)?function(s,r,n,i){let a=e.at("编译环境"),u=t.resolve(a.path.src,i.substring(a.path.build_dist.length+1,i.length-5)+".rpose"),c=e.at("组件编译缓存",u),p=c?c.result.hashcode||"":null;if(!p){let s=e.at("页面目标HTML文件名",u),r=e.at("页面目标CSS文件名",u),n=e.at("页面目标JS文件名",u);if(t.existsFile(s)){let e=t.read(s),i=t.existsFile(r)?t.read(r):"",a=t.existsFile(n)?t.read(n):"";p=o(e+i+a)}}let f=`\n        <script>\n            var _times_ = 0;\n            function refresh() {\n                let url = '/query?page=${i.substring(a.path.build_dist.length+1)}&t=' + new Date().getTime();\n                ajaxAsync(url, function(rs){\n                    if ( rs !== '${p}' ) {\n                        if ( rs === '${l}' ) {\n                            _times_++;\n                            _times_ >= 5 ? location.reload() : setTimeout(refresh, 1000);\n                        }else{\n                            location.reload();\n                        }\n                    }else{\n                        _times_ = 0;\n                        setTimeout(refresh, 1000);\n                    }\n                }, function(err){\n                    _times_ = 0;\n                    setTimeout(refresh, 1000);\n                });\n            }\n\n            function ajaxAsync(url, fnCallback, fnError) {\n                var xhr = new XMLHttpRequest();\n                xhr.onreadystatechange = function (xxx, eee) {\n                    if (xhr.readyState === 4 && xhr.status === 200) {\n                        fnCallback(xhr.responseText);\n                    }\n                };\n                xhr.onerror = fnError;\n                xhr.open("GET", url, true);\n                xhr.send();\n            }\n\n            setTimeout(refresh, 3000);\n        <\/script>`,g=t.read(i).replace(/<head>/i,"<head>"+f);r.writeHead(200,{"Content-Type":"text/html;charset=UFT8"}),r.end(g)}(0,a,0,f):(a.writeHead(404),a.end("404 Not Found")):t.existsFile(f)?(/\.css$/i.test(f)?a.writeHead(200,{"Content-Type":"text/css;charset=UFT8"}):a.writeHead(200),s.createReadStream(f).pipe(a)):/favicon\.ico$/i.test(f)?(a.writeHead(200),a.end(null)):(a.writeHead(404),a.end("404 Not Found"))}).listen(p);let f="http://localhost:"+p;console.log("-------------------------------------------"),console.log(` server ready ...... ${f}`),console.log("-------------------------------------------"),setTimeout(()=>{!u&&a(f)},1e3)}(c.path.build_dist,3700)}}())})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("b00p-log",function(e,t){}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("b01p-init-context",function(e,t){t.input={},t.doc={},t.style={},t.script={},t.keyCounter=1,t.result={},e.walk((e,o)=>{t.input.file=o.file,t.input.text=o.text,t.input.hashcode=o.hashcode},{readonly:!0})}))})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/postobject");function t(e){return e.startsWith("[")&&e.indexOf("]")>0}function o(e){return e.startsWith("---------")}function s(e){return e.startsWith("=========")}function r(e){let t,o;for(let s=1;s<e.length;s++)if("\\"!==e.charAt(s-1)&&"]"===e.charAt(s))return o=(t=e.substring(1,s).toLowerCase()).length,{name:t=t.replace(/\\\]/g,"]"),len:o};return o=(t=e.substring(1,e.lastIndexOf("]")).toLowerCase()).length,{name:t=t.replace(/\\\]/g,"]"),len:o}}function n(e,t){let o=0;for(let s=0;s<t;s++)o+=e[s];return o}e.on("项目配置文件解析",function(e,i=!0){let a=e.indexOf("\r\n")>=0?"\r\n":"\n",l=e.split(a),u=l.map(e=>e.length+a.length),c=[];return function(e,i,a,l){let u,c,p,f,g=!1;for(let l=0;l<i.length;l++)if(t(u=i[l])){c={type:"ProjectBtfBlock"},p=r(u),f=u.substring(p.len+2);let t=l+1,o=1,s=n(a,t-1),i={line:t,column:o,pos:s};o=p.len+3,s+=o-1,end={line:t,column:o,pos:s},c.name={type:"ProjectBtfBlockName",value:p.name,loc:{start:i,end}},f&&(o=p.len+3,i={line:t,column:o,pos:s},o=u.length+1,s=n(a,t-1)+o-1,end={line:t,column:o,pos:s},c.comment={type:"ProjectBtfBlockComment",value:f,loc:{start:i,end}}),c.buf=[],e.push(c),g=!0}else if(o(u))g=!1;else{if(s(u))return;if(g){let t=e[e.length-1].buf;"\\"===u.charAt(0)&&(/^\\+\[.*\]/.test(u)||/^\\+\---------/.test(u)||/^\\+\=========/.test(u))?t.push(u.substring(1)):t.push(u)}}}(c,l,u),c.forEach(e=>{if(e.buf.length){let t="ProjectBtfBlockText",o=e.buf.join(a),s=e.name.loc.start.line+1,r=1,i=n(u,s-1),l={line:s,column:r,pos:i};s=e.name.loc.start.line+e.buf.length,r=e.buf[e.buf.length-1].length+1,i=n(u,s-1)+r,1===r&&e.buf.length>1&&(s--,r=e.buf[e.buf.length-2].length+1),end={line:s,column:r,pos:i},e.text={type:t,value:o,loc:{start:l,end}}}delete e.buf,!1===i&&(delete e.name.loc,void 0!==e.comment&&delete e.comment.loc,void 0!==e.text&&delete e.text.loc)}),{nodes:c}})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/err"),require("@gotoeasy/file")),o=require("@gotoeasy/hash"),s=require("csslibify");e.on("样式库",function(r){let n,i,a,l=[];(n=r.match(/^(.*?)=(.*?):(.*)$/))?(i=n[1].trim(),a=n[2].trim(),cssfilter=n[3],cssfilter.replace(/;/g,",").split(",").forEach(e=>{(e=e.trim())&&l.push(e)})):(n=r.match(/^(.*?)=(.*)$/))?(i=n[1].trim(),a=n[2].trim(),l.push("**.min.css")):(n=r.match(/^(.*?):(.*)$/))?(i="*",a=n[1].trim(),cssfilter=n[2],cssfilter.replace(/;/g,",").split(",").forEach(e=>{(e=e.trim())&&l.push(e)})):(i="*",a=r.trim(),l.push("**.min.css")),a.lastIndexOf("@")>1&&(a=a.substring(0,a.lastIndexOf("@")));let u,c=e.at("编译环境");a.startsWith("$")&&(u=c.path.root+"/"+a,!t.existsDir(u)&&(u=c.path.root+"/"+a.substring(1))),(!u||!t.existsDir(u))&&(u=function(o){e.at("自动安装",o);let s=[...require("find-node-modules")({cwd:process.cwd(),relative:!1}),...require("find-node-modules")({cwd:__dirname,relative:!1})];for(let e,r,n=0;e=s[n++];)if(r=t.resolve(e,o),t.existsDir(r))return r;throw new Error("path not found of npm package: "+o)}(a));let p=t.files(u,...l);(!i||"*"===i)&&(a="");let f=o(JSON.stringify([a,p])),g=s(a,i,f);return!g._imported.length&&p.forEach(e=>g.imp(e)),g})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/postobject"),require("@gotoeasy/err"));e.on("解析[csslib]",function(e,o,s){let r={},n=(null==e?"":e.trim()).split("\n");for(let e,i=0;i<n.length;i++){let a,l,u=(e=n[i]).indexOf("=");if(!(u<0)){if(a=e.substring(0,u).trim(),(u=(l=e.substring(u+1).trim()).lastIndexOf("//"))>=0&&(l=l.substring(0,u).trim()),!a)throw new t("use * as empty csslib name. etc. * = "+l,{file:o.input.file,text:o.input.text,line:s.start.line+i,column:1});if(r[a])throw new t("duplicate csslib name: "+a,{file:o.input.file,text:o.input.text,line:s.start.line+i,column:1});r[a]=l}}return r})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/err"),require("@gotoeasy/file")),o=require("@gotoeasy/btf");e.on("标签库定义",function(s={},r={}){let n=[];return e.on("标签库引用",function(t,o){let r,n=e.at("文件所在模块",o),i=t.indexOf("="),a=t.indexOf(":");return r=i<0&&a<0?t.trim():a>0?t.substring(a+1).trim():t.substring(0,i).trim(),s[n+":"+r]}),function(i,a){let l=e.at("normalize-taglib",i);!function(o){if(!r[o]){let n=e.at("模块组件信息",o);for(let e,o=0;e=n.files[o++];)s[n.name+":"+t.name(e)]=e;r[o]=!0}}(l.pkg);let u,c,p,f=e.at("文件所在模块",a);if(u=f+":"+l.astag,c=l.pkg+":"+l.tag,s[c])return s[u]=s[c],n=[],s;n.push(`[${f}] ${l.taglib}`);try{p=require.resolve(l.pkg+"/package.json",{paths:[e.at("编译环境").path.root,__dirname]})}catch(e){n.unshift(e.message);let t=n.join("\n => ");throw n=[],new Error(t)}let g=t.path(p)+"/rpose.config.btf";if(!t.existsFile(g)){n.unshift(`tag [${l.tag}] not found in package [${l.pkg}]`);let e=n.join("\n => ");throw n=[],new Error(e)}let d,h=new o(g).getText("taglib");try{d=e.at("解析[taglib]",h,{input:{file:g}})}catch(e){n.push(`[${l.pkg}] ${l.pkg}:${l.tag}`),n.push(g),n.unshift(e.message);let t=n.join("\n => ");throw n=[],new Error(t)}let b=d[l.tag];if(!b){n.push(g),n.unshift(`tag [${l.tag}] not found in package [${l.pkg}]`);let e=n.join("\n => ");throw n=[],new Error(e)}return e.at("自动安装",b.pkg),e.at("标签库定义",b.taglib,g)}}())})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/postobject"),require("@gotoeasy/err");e.on("normalize-taglib",function(e,t=0){let o,s,r,n;if(n=e.match(/^\s*([\S]+)\s*=\s*([\S]+)\s*:\s*([\S]+)\s*$/))o=n[1],s=n[2],r=n[3];else if(n=e.match(/^\s*([\S]+)\s*=\s*([\S]+)\s*$/))o=n[1],s=n[2],r=n[1];else{if(!(n=e.match(/^\s*([\S]+)\s*:\s*([\S]+)\s*$/)))return null;o=n[2],s=n[1],r=n[2]}return{line:t,astag:o,pkg:s,tag:r,taglib:o+"="+s+":"+r}})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/postobject"),require("@gotoeasy/err"));e.on("解析[taglib]",function(o,s,r){let n={},i=(null==o?"":o.trim()).split("\n");for(let o,a,l=0;l<i.length;l++)if(o=i[l].split("//")[0].trim()){if(!(a=e.at("normalize-taglib",o,l))){if(r)throw new t("invalid taglib: "+a.taglib,{file:s.input.file,text:s.input.text,line:r.start.line+l,column:1});throw new t(`invalid taglib: ${o}`)}if(/^(if|for)$/i.test(a.astag)){if(r)throw new t("can not use buildin tag name: "+a.astag,{file:s.input.file,text:s.input.text,line:r.start.line+l,column:1});throw new t("can not use buildin tag name: "+a.astag)}if(n[a.astag]){if(r)throw new t("duplicate tag name: "+a.astag,{file:s.input.file,text:s.input.text,line:r.start.line+l,column:1});throw new t("duplicate tag name: "+a.astag)}n[a.astag]=a}return n})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/file"),s=require("@gotoeasy/err");e.on("编译插件",t.plugin("b95p-init-project-config",function(t,o){o.project=e.at("项目配置处理",o.input.file)})),e.on("项目配置处理",function(s={}){return function(r){let n,i=(new Date).getTime(),a=r.endsWith("/rpose.config.btf")?r:e.at("文件所在项目配置文件",r);if(s[a])return s[a];if(!o.existsFile(a))return{};let l=e.on("项目配置处理插件"),u=t(l).process({file:a});return s[a]=u.result,(n=(new Date).getTime()-i)>100&&console.debug("init-project-config:",n+"ms"),s[a]}}()),e.on("项目配置处理插件",t.plugin("process-project-config-101",function(t,s){s.input={},s.result={},t.walk((t,r)=>{s.input.file=r.file,s.input.text=o.read(r.file);let n=e.at("项目配置文件解析",s.input.text),i=this.createNode(n);t.replaceWith(...i.nodes)}),t.walk((e,t)=>{if(!t.text||!t.text.value||!t.text.value.trim())return e.remove();let o=t.name.value,s=t.text.value,r=t.text.loc,n=this.createNode({type:o,value:s,loc:r});e.replaceWith(n)})})),e.on("项目配置处理插件",t.plugin("process-project-config-102",function(t,o){let s;if(e.on("哈希样式类名")[0],t.walk("csslib",(t,r)=>{s=e.at("解析[csslib]",r.value,o,r.loc),t.remove()}),!s)return;let r=o.result.oCsslib={},n=o.result.oCsslibPkgs=o.result.oCsslibPkgs||{};for(let t in s)r[t]=e.at("样式库",`${t}=${s[t]}`),n[t]=r[t].pkg})),e.on("项目配置处理插件",function(o){return t.plugin("process-project-config-103",function(t,s){if(!o){let t="@rpose/buildin";if(!e.at("自动安装",t))throw new Error("package install failed: "+t);e.at("标签库定义","@rpose/buildin:```",""),e.at("标签库定义","@rpose/buildin:router",""),e.at("标签库定义","@rpose/buildin:router-link",""),o=!0}})}()),e.on("项目配置处理插件",function(o){return t.plugin("process-project-config-105",function(t,r){let n,i;if(t.walk("taglib",(t,o)=>{n=e.at("解析[taglib]",o.value,r,o.loc),i=o.loc.start.line,t.remove()}),r.result.oTaglib=n||{},!n)return;let a=new Map;for(let e in n)a.set(n[e].pkg,n[e]);a.forEach((t,o)=>{if(!e.at("自动安装",o))throw new s("package install failed: "+o,{file:r.input.file,text:r.input.text,line:i+t.line,column:1})});for(let t in n)try{e.at("标签库定义",n[t].taglib,r.input.file)}catch(e){throw new s.cat(e,{file:r.input.file,text:r.input.text,line:i+n[t].line,column:1})}if(!o){if(pkg="@rpose/buildin",!e.at("自动安装",pkg))throw new Error("package install failed: "+pkg);e.at("标签库定义","@rpose/buildin:```",""),e.at("标签库定义","@rpose/buildin:router",""),e.at("标签库定义","@rpose/buildin:router-link",""),o=!0}})}())})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/postobject");function t(e){return e.startsWith("[")&&e.indexOf("]")>0}function o(e){return e.startsWith("---------")}function s(e){return e.startsWith("=========")}function r(e){let t,o;for(let s=1;s<e.length;s++)if("\\"!==e.charAt(s-1)&&"]"===e.charAt(s))return o=(t=e.substring(1,s).toLowerCase()).length,{name:t=t.replace(/\\\]/g,"]"),len:o};return o=(t=e.substring(1,e.lastIndexOf("]")).toLowerCase()).length,{name:t=t.replace(/\\\]/g,"]"),len:o}}function n(e,t){let o=0;for(let s=0;s<t;s++)o+=e[s];return o}e.on("RPOSE源文件解析",function(e,i=!0){let a=e.indexOf("\r\n")>=0?"\r\n":"\n",l=e.split(a),u=l.map(e=>e.length+a.length),c=[];return function(e,i,a,l){let u,c,p,f,g=!1;for(let l=0;l<i.length;l++)if(t(u=i[l])){c={type:"RposeBlock"},p=r(u),f=u.substring(p.len+2);let t=l+1,o=1,s=n(a,t-1),i={line:t,column:o,pos:s};o=p.len+3,s+=o-1,end={line:t,column:o,pos:s},c.name={type:"RposeBlockName",value:p.name,loc:{start:i,end}},f&&(o=p.len+3,i={line:t,column:o,pos:s},o=u.length+1,s=n(a,t-1)+o-1,end={line:t,column:o,pos:s},c.comment={type:"RposeBlockComment",value:f,loc:{start:i,end}}),c.buf=[],e.push(c),g=!0}else if(o(u))g=!1;else{if(s(u))return;if(g){let t=e[e.length-1].buf;"\\"===u.charAt(0)&&(/^\\+\[.*\]/.test(u)||/^\\+\---------/.test(u)||/^\\+\=========/.test(u))?t.push(u.substring(1)):t.push(u)}}}(c,l,u),c.forEach(e=>{if(e.buf.length){let t="RposeBlockText",o=e.buf.join(a),s=e.name.loc.start.line+1,r=1,i=n(u,s-1),l={line:s,column:r,pos:i};s=e.name.loc.start.line+e.buf.length,r=e.buf[e.buf.length-1].length+1,i=n(u,s-1)+r,1===r&&e.buf.length>1&&(s--,r=e.buf[e.buf.length-2].length+1),end={line:s,column:r,pos:i},e.text={type:t,value:o,loc:{start:l,end}}}delete e.buf,!1===i&&(delete e.name.loc,void 0!==e.comment&&delete e.comment.loc,void 0!==e.text&&delete e.text.loc)}),{nodes:c}})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("c15p-parse-rpose-src-to-blocks",function(t,o){let s=o.result;t.walk((t,o)=>{s.tagpkg=e.at("标签全名",o.file);let r=e.at("RPOSE源文件解析",o.text),n=this.createNode(r);return t.replaceWith(...n.nodes),!1})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("c25p-blocks-to-context-doc",function(e,t){let o=t.doc;e.walk("RposeBlock",(e,t)=>{/^(api|options|state|mount)$/.test(t.name.value)&&(o[t.name.value]=t.text?t.text.value:"",e.remove())})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("c35p-normalize-context-doc",function(e,t){let o=t.doc;o.api=function(e){let t={};return(null==e?"":e.trim()).split("\n").forEach(e=>{let o,s,r=e.indexOf("=");r<0&&(r=e.indexOf(":")),r<0||(o=e.substring(0,r).trim(),(r=(s=e.substring(r+1).trim()).lastIndexOf("//"))>=0&&(s=s.substring(0,r).trim()),/^option[\-]?keys$/i.test(o)?(o="optionkeys",s=s.split(/[,;]/).map(e=>e.trim())):/^state[\-]?keys$/i.test(o)?(o="statekeys",s=s.split(/[,;]/).map(e=>e.trim())):/^pre[\-]?render$/i.test(o)&&(o="prerender"),t[o]=s)}),t}(o.api),o.mount&&(o.mount=o.mount.trim())}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("c45p-is-page",function(e,t){t.result.isPage=t.doc.mount&&!/\/components\//i.test(t.input.file)&&!/\/node_modules\//i.test(t.input.file)}))})(),(()=>{const e=require("@gotoeasy/err"),t=require("@gotoeasy/bus"),o=require("@gotoeasy/btf"),s=require("@gotoeasy/file");function r(t){let o=[...require("find-node-modules")({cwd:__dirname,relative:!1}),...require("find-node-modules")({relative:!1})];for(let e,r,n=0;e=o[n++];)if(r=e.replace(/\\/g,"/")+"/"+t+"/theme.btf",s.exists(r))return r;throw new e("theme file not found: "+t+"/theme.btf")}t.on("样式风格",function(i){return function(){let a=t.at("编译环境");try{let l;if(!i){if(a.theme){l=function t(s){if(n.has(s)){let t=[...n].push(s);throw e.cat(t,new e("theme circular extend"))}n.add(s);btf=new o(s);let i=(btf.getText("extend")||"").trim();let a;let l=btf.getMap("theme");i&&(a=t(r(i)),l.forEach((e,t)=>a.set(t,e)),l=a);return l}(function(){let o,n=t.at("编译环境");if(n.theme.endsWith(".btf")){if(s.exists(o))return o;if(o=s.resolve(n.path.root,n.theme),s.exists(o))return o;throw new e("theme file not found: "+o)}return r(n.theme)}())}else l=new Map;i={less:function(e){let t=[];return e.forEach((e,o)=>t.push("@"+o+" : "+e+";")),t.join("\n")+"\n"}(l),scss:function(e){let t=[];return e.forEach((e,o)=>t.push("$"+o+" : "+e+";")),t.join("\n")+"\n"}(l),css:function(e){if(!e.size)return"";let t=[];return t.push(":root{"),e.forEach((e,o)=>t.push("--"+o+" : "+e+";")),t.push("}"),t.join("\n")+"\n"}(l)}}return i}catch(t){throw e.cat("init theme failed: "+a.theme,t)}}}());const n=new Set})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/csjs");e.on("编译插件",t.plugin("d15p-compile-component-scss",function(t,s){let r=s.style;t.walk("RposeBlock",(t,s)=>{if(/^scss$/.test(s.name.value)){let n=s.text?s.text.value:"";if(n){let t=e.at("样式风格");r.scss=function(t){let s=e.at("编译环境"),r=e.at("缓存"),n=JSON.stringify(["scssToCss",t]);if(!s.nocache){let e=r.get(n);if(e)return e}let i=o.scssToCss(t);return r.set(n,i)}(t.scss+n)}return t.remove(),!1}})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/csjs");e.on("编译插件",t.plugin("d25p-compile-component-less",function(t,s){let r=s.style;t.walk("RposeBlock",(t,s)=>{if(/^less$/.test(s.name.value)){let n=s.text?s.text.value:"";if(n){let t=e.at("样式风格");r.less=function(t){let s=e.at("编译环境"),r=e.at("缓存"),n=JSON.stringify(["lessToCss",t]);if(!s.nocache){let e=r.get(n);if(e)return e}let i=o.lessToCss(t);return r.set(n,i)}(t.less+n)}return t.remove(),!1}})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/hash"),o=require("postcss");module.exports=e.on("样式统一化整理",(s,r)=>{let n=File.path(r),i=e.at("缓存").path+"/resources",a=i+"/to.css",l=i,u={url:"copy",from:r,to:a,basePath:n,assetsPath:l,useHash:!0,hashOptions:{method:e=>t({contents:e})}},c=e.at("编译环境"),p=e.at("缓存"),f=JSON.stringify(["组件样式统一化",s,n,i,l]),g=[];if(!c.nocache){let e=p.get(f);if(e)return e}g.push(require("postcss-import-sync")({from:r})),g.push(require("postcss-unprefix")()),g.push(require("postcss-url")(u)),g.push(require("postcss-nested")()),g.push(require("postcss-css-variables")()),g.push(require("postcss-discard-comments")({remove:e=>1})),g.push(require("postcss-minify-selectors")),g.push(require("postcss-minify-params")),g.push(require("postcss-normalize-string")),g.push(require("postcss-normalize-display-values")),g.push(require("postcss-normalize-positions")),g.push(require("postcss-normalize-repeat-style")),g.push(require("postcss-minify-font-values")),g.push(require("postcss-minify-gradients")),g.push(require("postcss-color-hex-alpha")),g.push(require("postcss-merge-longhand"));let d=o(g).process(s,{from:r,to:a}).sync().root.toResult();return p.set(f,d.css)})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");require("@gotoeasy/file");e.on("编译插件",t.plugin("d35p-normalize-component-css",function(t,o){let s=o.style;if(t.walk("RposeBlock",(t,o)=>{if(/^css$/.test(o.name.value)){let r=o.text?o.text.value:"";if(r){let t=e.at("样式风格");s.css=t.css+r}return t.remove(),!1}}),!s.css)return;let r=o.input.file.replace(/\.rpose$/i,".css");s.css=e.at("样式统一化整理",s.css,r)}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err"),s=require("acorn"),r=require("astring");e.on("编译插件",t.plugin("d45p-normalize-component-actions",function(t,n){let i=n.script;t.walk("RposeBlock",(t,n)=>{if(!/^actions$/.test(n.name.value))return;let a=n.text?n.text.value.trim():"";if(a){let t=function(t,n){let i,a=e.at("编译环境"),l=e.at("缓存"),u=JSON.stringify(["generateActions",t]);if(!a.nocache){let e=l.get(u);if(e)return e}return i=t.startsWith("{")?function(e,t){let n,i=`this.$actions     = ${e}`;try{n=s.parse(i,{ecmaVersion:10,sourceType:"module",locations:!0})}catch(e){throw new o("syntax error in [actions]",e)}let a=[],l=n.body[0].expression.right.properties;l&&l.forEach(e=>{if("ArrowFunctionExpression"==e.value.type)a.push(e.key.name);else if("FunctionExpression"==e.value.type){let t=e.value;t.type="ArrowFunctionExpression",a.push(e.key.name)}});let u={src:"",names:a};return a.length&&(a.sort(),u.src=r.generate(n)),u}(t):function(e,t){let n;try{n=s.parse(e,{ecmaVersion:10,sourceType:"module",locations:!0})}catch(e){throw new o("syntax error in [actions]",e)}let i=new Map;n.body.forEach(e=>{let t;"FunctionDeclaration"==e.type?(e.type="ArrowFunctionExpression",i.set(e.id.name,r.generate(e))):"VariableDeclaration"==e.type?"FunctionDeclaration"!=(t=e.declarations[0].init).type&&"ArrowFunctionExpression"!=t.type||(t.type="ArrowFunctionExpression",i.set(e.declarations[0].id.name,r.generate(t))):"ExpressionStatement"==e.type&&("FunctionDeclaration"!=(t=e.expression.right).type&&"ArrowFunctionExpression"!=t.type||(t.type="ArrowFunctionExpression",i.set(e.expression.left.name,r.generate(t))))});let a=[...i.keys()],l={src:"",names:a};if(a.length){let e=[];e.push("this.$actions = {"),a.forEach(t=>{e.push('"'+t+'": '+i.get(t)+",")}),e.push("}"),l.src=e.join("\n")}return l}(t),l.set(u,i)}(a,n.text.loc);i.actions=t.src,i.$actionkeys=t.names}return t.remove(),!1})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("acorn"),s=require("astring");e.on("编译插件",t.plugin("d55p-normalize-component-methods",function(t,r){let n=r.script;t.walk("RposeBlock",(t,r)=>{if(!/^methods$/.test(r.name.value))return;let i=r.text?r.text.value.trim():"";if(i){let t=function(t,r){let n=e.at("编译环境"),i=e.at("缓存"),a=JSON.stringify(["generateMethods",t]);if(!n.nocache){let e=i.get(a);if(e)return e}let l,u=`oFn               = ${t}`;try{l=o.parse(u,{ecmaVersion:10,sourceType:"module",locations:!0})}catch(e){throw new Err("syntax error in [methods]",e)}let c=new Map,p=l.body[0].expression.right.properties;p&&p.forEach(e=>{if("ArrowFunctionExpression"==e.value.type)c.set(e.key.name,"this."+e.key.name+"="+s.generate(e.value));else if("FunctionExpression"==e.value.type){let t=e.value;t.type="ArrowFunctionExpression",c.set(e.key.name,"this."+e.key.name+"="+s.generate(t))}});let f=[...c.keys()];f.sort();let g={src:"",names:f};return f.forEach(e=>g.src+=c.get(e)+"\n"),i.set(a,g)}(i,r.text.loc);n.methods=t.src}return t.remove(),!1})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("d75p-init-component-[csslib]",function(t,s){let r=e.at("项目配置处理",s.input.file),n=s.result.oCsslib=Object.assign({},r.oCsslib||{}),i=s.result.oCsslibPkgs=Object.assign({},r.oCsslibPkgs||{});t.walk("RposeBlock",(t,r)=>{if("csslib"!==r.name.value)return;if(!r.text||!r.text.value||!r.text.value.trim())return;let a=e.at("解析[csslib]",r.text.value,s,r.text.loc);for(let t in a){if(n[t])throw new o("duplicate csslib name: "+t,{file:s.input.file,text:s.input.text,line:r.text.loc.start.line,column:1});n[t]=e.at("样式库",`${t}=${a[t]}`),i[t]=n[t].pkg}return t.remove(),!1})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("d85p-init-component-[taglib]",function(t,s){let r=e.at("项目配置处理",s.input.file),n=s.result.oTaglib=Object.assign({},r.oTaglib||{});t.walk("RposeBlock",(t,r)=>{if("taglib"!==r.name.value)return;if(!r.text||!r.text.value||!r.text.value.trim())return;let i=e.at("解析[taglib]",r.text.value,s,r.text.loc);for(let e in i)if(n[e])throw new o("duplicate taglib name: "+e,{file:s.input.file,text:s.input.text,line:r.text.loc.start.line+n[e].line,column:1});let a=new Map;for(let e in i)a.set(i[e].pkg,i[e]);a.forEach((t,n)=>{if(!e.at("自动安装",n))throw new o("package install failed: "+n,{file:s.input.file,text:s.input.text,line:r.text.loc.start.line+t.line,column:1})});for(let t in i)try{e.at("标签库定义",i[t].taglib,s.input.file)}catch(e){throw new o.cat(e,{file:s.input.file,text:s.input.text,line:r.text.loc.start.line+i[t].line,column:1})}return t.remove(),!1})}))})(),(()=>{const e=require("@gotoeasy/bus");module.exports=e.on("视图编译选项",function(e={},t){return e.CodeBlockStart="{%",e.CodeBlockEnd="%}",e.ExpressionStart="{",e.ExpressionEnd="}",e.TypeHtmlComment="HtmlComment",e.TypeCodeBlock="JsCode",e.TypeExpression="Expression",e.TypeTagOpen="TagOpen",e.TypeTagClose="TagClose",e.TypeTagSelfClose="TagSelfClose",e.TypeAttributeName="AttributeName",e.TypeAttributeValue="AttributeValue",e.TypeEqual="=",e.TypeText="Text",function(o){return!t&&o&&(t=!0,e.CodeBlockStart=o.CodeBlockStart||e.CodeBlockStart,e.CodeBlockEnd=o.CodeBlockEnd||e.CodeBlockEnd,e.ExpressionStart=o.ExpressionStart||e.ExpressionStart,e.ExpressionEnd=o.ExpressionEnd||e.ExpressionEnd,e.TypeHtmlComment=o.TypeHtmlComment||e.TypeHtmlComment,e.TypeCodeBlock=o.TypeCodeBlock||e.TypeCodeBlock,e.TypeExpression=o.TypeExpression||e.TypeExpression,e.TypeTagOpen=o.TypeTagOpen||e.TypeTagOpen,e.TypeTagClose=o.TypeTagClose||e.TypeTagClose,e.TypeTagSelfClose=o.TypeTagSelfClose||e.TypeTagSelfClose,e.TypeAttributeName=o.TypeAttributeName||e.TypeAttributeName,e.TypeAttributeValue=o.TypeAttributeValue||e.TypeAttributeValue,e.TypeEqual=o.TypeEqual||e.TypeEqual,e.TypeText=o.TypeText||e.TypeText),e}}())})(),(()=>{const e=require("@gotoeasy/bus");e.on("是否表达式",function(){e.at("视图编译选项");return function(e){if(!e)return!1;let t=e.replace(/\\\{/g,"").replace(/\\\}/g,"");return/\{.*\}/.test(t)}}())})(),(()=>{const e=require("@gotoeasy/bus"),t="\0",o="￿";module.exports=e.on("字符阅读器",function(e){return new class{constructor(e){this.ary=e.split(""),this.maxLength=this.ary.length,this.pos=0}skip(e){return e>0&&(this.pos=this.pos+e,this.pos>this.maxLength&&(this.pos=this.maxLength)),this.pos}skipBlank(){let e="";for(;/\s/.test(this.getCurrentChar())&&!this.eof();)e+=this.readChar();return e}getPos(){return this.pos}eof(){return this.pos>=this.maxLength}readChar(){let e=this.getCurrentChar();return this.pos<this.maxLength&&(this.pos+=1),e}getPrevChar(){return 0==this.pos?t:this.ary[this.pos-1]}getCurrentChar(){return this.pos>=this.maxLength?o:this.ary[this.pos]}getNextChar(e=1){let t=e<1?1:e;return this.pos+t>=this.maxLength?o:this.ary[this.pos+t]}getChar(e=0){return e<0?t:e>=this.maxLength?o:this.ary[e]}getPrevString(e){return this.getString(this.pos-e,this.pos)}getString(e,t){let o=e<0?0:e>=this.maxLength?this.maxLength-1:e,s=t<0?0:t>this.maxLength?this.maxLength:t,r="";for(let e=o;e<s;e++)r+=this.ary[e];return r}getNextString(e){return this.getString(this.pos,this.pos+e)}}(e)})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/file"),require("@gotoeasy/err")),o="br,hr,input,img,meta,link,area,base,basefont,bgsound,col,command,isindex,frame,embed,keygen,menuitem,nextid,param,source,track,wbr".split(",");function s(e){return null==e?null:e.replace(/\\{/g,"\0").replace(/\\}/g,"￾￿")}function r(e){return null==e?null:e.replace(/\u0000\u0001/g,"{").replace(/\ufffe\uffff/g,"}")}function n(n,i,a,l){let u=s(i),c=e.at("视图编译选项"),p=e.at("字符阅读器",u),f=[];function g(){let e=p.getPos();if("<"!==p.getCurrentChar()||p.eof()||"\x3c!--"===p.getNextString(4)||"<![CDATA["===p.getNextString(9)||u.indexOf(c.CodeBlockStart,e)==e||u.indexOf(c.ExpressionStart,e)==e)return 0;let s,i,g="";if("</"===p.getNextString(2)){if(u.indexOf(">",e+3)<0)return 0;for((i={}).start=p.getPos(),p.skip(2);">"!==p.getCurrentChar()&&!p.eof();)g+=p.readChar();return p.skip(1),i.end=p.getPos(),s={type:c.TypeTagClose,value:g.trim(),pos:i},f.push(s),1}if("<"===p.getCurrentChar()&&u.indexOf(">",e+2)<0)return 0;if(!/[a-z]/i.test(p.getNextChar()))return 0;for((i={}).start=p.getPos(),p.skip(1);/[^\s\/>]/.test(p.getCurrentChar());)g+=p.readChar();let h={type:"",value:r(g).trim(),pos:i};for(f.push(h);d(););if(p.skipBlank(),"/>"===p.getNextString(2))return h.type=c.TypeTagSelfClose,p.skip(2),i.end=p.getPos(),1;if(">"===p.getCurrentChar())return o.includes(g.toLowerCase())?h.type=c.TypeTagSelfClose:h.type=c.TypeTagOpen,p.skip(1),i.end=p.getPos(),1;throw new t('tag missing ">"',"file="+a,{text:n,start:i.start+l})}function d(){if(p.eof())return 0;p.skipBlank();let e={};e.start=p.getPos();let o="",s="";if("{"===p.getCurrentChar()){let e=[];for(o+=p.readChar();!p.eof();){if("{"===p.getCurrentChar()&&"\\"!==p.getPrevChar()&&e.push("{"),"}"===p.getCurrentChar()&&"\\"!==p.getPrevChar()){if(!e.length){o+=p.readChar();break}e.pop()}o+=p.readChar()}if(!o)return 0}else{for(;/[^\s=\/>]/.test(p.getCurrentChar());)o+=p.readChar();if(!o)return 0}e.end=p.getPos();let i={type:c.TypeAttributeName,value:r(o),pos:e};if(f.push(i),p.skipBlank(),(e={}).start=p.getPos(),"="===p.getCurrentChar()){e.end=p.getPos()+1,i={type:c.TypeEqual,value:"=",pos:e},f.push(i);let o=p.getPos()+l+1;if(p.skip(1),p.skipBlank(),(e={}).start=p.getPos(),'"'===p.getCurrentChar()){p.skip(1);let u=p.getPos();for(;!p.eof()&&'"'!==p.getCurrentChar();){let e=p.readChar();"\r"!==e&&"\n"!==e&&(s+=e)}if(p.eof()||'"'!==p.getCurrentChar())throw new t('invalid attribute value format (missing ")',"file="+a,{text:n,start:o,end:u+l});p.skip(1),e.end=p.getPos(),i={type:c.TypeAttributeValue,value:r(s),pos:e},f.push(i)}else if("'"===p.getCurrentChar()){p.skip(1);let u=p.getPos();for(;!p.eof()&&"'"!==p.getCurrentChar();){let e=p.readChar();"\r"!=e&&"\n"!=e&&(s+=e)}if(p.eof()||"'"!==p.getCurrentChar())throw new t("invalid attribute value format (missing ')","file="+a,{text:n,start:o,end:u+l});p.skip(1),e.end=p.getPos(),i={type:c.TypeAttributeValue,value:r(s),pos:e},f.push(i)}else if("{"===p.getCurrentChar()){let u=[],g=p.getPos()+1;for(;!p.eof();){if("{"===p.getCurrentChar())u.push("{");else if("}"===p.getCurrentChar()){if(!u.length)break;if(1===u.length){s+=p.readChar();break}u.pop()}s+=p.readChar()}if(p.eof())throw new t("invalid attribute value format (missing })","file="+a,{text:n,start:o,end:g+l});e.end=p.getPos(),i={type:c.TypeAttributeValue,value:r(s),pos:e},f.push(i)}else{for(;/[^\s\/>]/.test(p.getCurrentChar());)s+=p.readChar();if(!s)throw new t("missing attribute value","file="+a,{text:n,start:o,end:o+1});if(!/^(\d+|\d+\.?\d+)$/.test(s))throw new t("invalid attribute value","file="+a,{text:n,start:o,end:p.getPos()+l});e.end=p.getPos(),i={type:c.TypeAttributeValue,value:s-0,pos:e},f.push(i)}}return 1}function h(){let e,t=p.getPos(),o=u.indexOf("\x3c!--",t),s=u.indexOf("--\x3e",t+4);if(o===t&&s>t){let n={};return n.start=o,n.end=s+3,e={type:c.TypeHtmlComment,value:r(u.substring(t+4,s)),pos:n},p.skip(s+3-t),f.push(e),1}return 0}function b(){let e,t=p.getPos(),o=u.indexOf("<![CDATA[",t),n=u.indexOf("]]>",t+9);if(o===t&&n>t){let i={};i.start=o,i.end=n+3;let a=s(u.substring(t+9,n));if(p.skip(n+3-t),/\{.*?}/.test(a)){let t,s,n,i,l=o+9;for(;(t=a.indexOf("{"))>=0&&(s=a.indexOf("}",t))>0;)t>0&&(l=(i={start:l,end:l+(n=r(a.substring(0,t))).length}).end,e={type:c.TypeText,value:n,pos:i},f.push(e)),l=(i={start:l,end:l+(n=r(a.substring(t,s+1))).length}).end,e={type:c.TypeExpression,value:n,pos:i},f.push(e),a=a.substring(s+1);a&&(l=(i={start:l,end:l+(n=r(a)).length}).end,e={type:c.TypeText,value:n,pos:i},f.push(e))}else e={type:c.TypeText,value:a,pos:i},f.push(e);return 1}return 0}function y(){let e,t,o=p.getPos();if(0!==o&&"\n"!==p.getPrevChar()||u.indexOf("```",o)!==o||!(u.indexOf("\n```",o+3)>0))return 0;let s,r=u.substring(o),n=/(^```[\s\S]*?\r?\n)([\s\S]*?)\r?\n```[\s\S]*?\r?(\n|$)/.exec(r),i=n[0].length;e=o,t=o+i,s={type:c.TypeTagSelfClose,value:"```",pos:{start:e,end:t}},f.push(s);let a,l=n[1].match(/\b\w*\b/),g=l?l[0].toLowerCase():"";g&&(t=(e=o+l.index)+g.length,s={type:c.TypeAttributeName,value:"lang",pos:{start:e,end:t}},f.push(s),s={type:c.TypeEqual,value:"=",pos:{start:e,end:t}},f.push(s),s={type:c.TypeAttributeValue,value:g,pos:{start:e,end:t}},f.push(s)),(l=n[1].match(/\b\d+(\%|px)/i))?a=l[0]:(l=n[1].match(/\b\d+/i))&&(a=l[0]),a&&(t=(e=o+l.index)+a.length,s={type:c.TypeAttributeName,value:"height",pos:{start:e,end:t}},f.push(s),s={type:c.TypeEqual,value:"=",pos:{start:e,end:t}},f.push(s),a=/^\d+$/.test(a)?a+"px":a,s={type:c.TypeAttributeValue,value:a,pos:{start:e,end:t}},f.push(s));let d=(l=n[1].match(/\bref\s?=\s?"(.*?)"/i))&&l[0]?l[0]:"";d&&(s={type:c.TypeAttributeName,value:"ref",pos:{start:e,end:t}},f.push(s),s={type:c.TypeEqual,value:"=",pos:{start:e,end:t}},f.push(s),s={type:c.TypeAttributeValue,value:d,pos:{start:e,end:t}},f.push(s));let h=n[2].replace(/\u0000\u0001/g,"\\{").replace(/\ufffe\uffff/g,"\\}");return h=h.replace(/\n\\+```/g,e=>"\n"+e.substring(2)),/^\\+```/.test(h)&&(h=h.substring(1)),h=h.replace(/\{/g,"\\{").replace(/\}/g,"\\}"),t=(e=o+n[1].length)+n[2].length,s={type:c.TypeAttributeName,value:"$CODE",pos:{start:e,end:t}},f.push(s),s={type:c.TypeEqual,value:"=",pos:{start:e,end:t}},f.push(s),s={type:c.TypeAttributeValue,value:h,pos:{start:e,end:t}},f.push(s),p.skip(i),1}function m(){let e,t=p.getPos(),o=u.indexOf(c.CodeBlockStart,t),s=u.indexOf(c.CodeBlockEnd,t+c.CodeBlockStart.length);if(o===t&&s>0){let n={};return n.start=o,n.end=s+c.CodeBlockEnd.length,e={type:c.TypeCodeBlock,value:r(u.substring(t+c.CodeBlockStart.length,s)),pos:n},p.skip(s+c.CodeBlockEnd.length-t),f.push(e),1}return 0}function x(){if(p.eof())return 0;let e={};e.start=p.getPos();let t,o,s="";for(;!p.eof()&&(s+=p.readChar(),o=p.getPos(),"<"!==p.getCurrentChar()&&"```"!==p.getNextString(3)&&u.indexOf(c.CodeBlockStart,o)!==o&&u.indexOf(c.ExpressionStart,o)!==o););return s?(e.end=p.getPos(),t={type:c.TypeText,value:r(s),pos:e},f.push(t),1):0}function w(){if(p.eof())return 0;let e,t={};return t.start=p.getPos(),(e=function(){let e=p.getPos(),t=u.indexOf(c.ExpressionStart,e),o=u.indexOf(c.ExpressionEnd,e+c.ExpressionStart.length);if(t===e&&o>0){let t={type:c.TypeExpression,value:r(u.substring(e,o+c.ExpressionEnd.length))};return p.skip(o+c.ExpressionEnd.length-e),t}return null}())?(t.end=p.getPos(),e.pos=t,f.push(e),1):0}this.parse=function(){for(;g()||h()||b()||m()||w()||y()||x(););return f.forEach(e=>{e.loc=function(e,t,o,s){let r,n,i={},a={};return r=e.substring(0,t+s).split("\n"),i.line=r.length,n=r.pop(),i.column=n.length+1,i.pos=s+t,r=e.substring(0,o+s).split("\n"),a.line=r.length,n=r.pop(),a.column=n.length,a.pos=s+o,n.length||(a.line--,a.column=r.pop().length+1),{start:i,end:a}}(n,e.pos.start,e.pos.end,l),delete e.pos}),f}}e.on("视图TOKEN解析器",function(e,t,o,s){return new n(e,t,o,s)})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("e15p-parse-view-tokens-to-ast",function(t,o){t.walk("RposeBlock",(t,s)=>{if(!/^view$/.test(s.name.value))return;let r=s.text?s.text.value:"";if(!r)return t.remove();let n=e.at("视图TOKEN解析器",o.input.text,r,o.input.file,s.text.loc.start.pos),i={type:"View",src:r,loc:s.text.loc,nodes:n.parse()},a=this.createNode(i);t.replaceWith(a)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("f15p-astedit-normalize-group-attribute",function(t,s){const r=e.at("视图编译选项");t.walk(r.TypeAttributeName,(t,n)=>{let i=t.after();if(i&&i.type===r.TypeEqual){let a=i.after();if(!a||!a.type===r.TypeAttributeValue)throw new o("missing attribute value");if(e.at("是否表达式",n.value))throw new o("unsupport expression on attribute name",{file:s.input.file,text:s.input.text,start:n.loc.start.pos,end:n.loc.end.pos});if(/^\s*\{\s*\}\s*$/.test(a.object.value))throw new o("invalid empty expression",{file:s.input.file,text:s.input.text,start:a.object.loc.start.pos,end:a.object.loc.end.pos});let l={type:"Attribute",name:n.value,value:a.object.value,isExpression:e.at("是否表达式",a.object.value),loc:{start:n.loc.start,end:a.object.loc.end}},u=this.createNode(l);t.replaceWith(u),i.remove(),a.remove()}else{let o={type:"Attribute",name:n.value,value:!0,isExpression:!1,loc:n.loc};e.at("是否表达式",n.value)&&(o.isExpression=!0,o.isObjectExpression=!0,delete o.value);let s=this.createNode(o);t.replaceWith(s)}}),t.walk("Attribute",(e,t)=>{if(!e.parent)return;let o=[e],s=e.after();for(;s&&"Attribute"===s.type;)o.push(s),s=s.after();let r=this.createNode({type:"Attributes"});e.before(r),o.forEach(e=>{r.addChild(e.clone()),e.remove()})})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("f25p-astedit-normolize-tag-of-self-close",function(t,o){const s=e.at("视图编译选项");t.walk(s.TypeTagSelfClose,(e,t)=>{let o=t.value,s=t.loc,r=this.createNode({type:"Tag",value:o,loc:s}),n=e.after();n&&"Attributes"===n.type&&(r.addChild(n.clone()),n.remove()),e.replaceWith(r)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("f35p-astedit-normolize-tag-of-open-close",function(t,s){const r=e.at("视图编译选项");let n=(e,t)=>{let i=t.after();for(;i&&i.type!==r.TypeTagClose;){if(i.type===r.TypeTagOpen){let t="Tag",o=i.object.value,s=i.object.loc,r=this.createNode({type:t,value:o,loc:s});n(r,i),e.addChild(r)}else e.addChild(i.clone());i.remove(),i=t.after()}if(!i)throw new o("missing close tag","file="+s.input.file,{text:s.input.text,start:e.object.loc.start.pos});if(i.type===r.TypeTagClose){if(t.object.value!==i.object.value)throw new o(`unmatch close tag: ${t.object.value}/${i.object.value}`,"file="+s.input.file,{text:s.input.text,start:e.object.loc.start.pos,end:i.object.loc.end.pos});return e.object.loc.end=i.object.loc.end,i.remove(),e}throw new Error("todo unhandle type")};t.walk(r.TypeTagOpen,(e,t)=>{if(!e.parent)return;let o=t.value,s=t.loc,r=this.createNode({type:"Tag",value:o,loc:s});n(r,e),e.replaceWith(r)})}))})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/postobject");function t(e){return e.startsWith("[")&&e.indexOf("]")>0}function o(e){return e.startsWith("---------")}function s(e){return e.startsWith("=========")}function r(e){let t,o;for(let s=1;s<e.length;s++)if("\\"!==e.charAt(s-1)&&"]"===e.charAt(s))return{name:t=e.substring(1,s).toLowerCase(),len:o=t.length};return{name:t=e.substring(1,e.lastIndexOf("]")).toLowerCase(),len:o=t.length}}e.on("BTF内容解析",function(e){let n=e.indexOf("\r\n")>=0?"\r\n":"\n",i=[];return function(e,n){let i,a,l,u=!1;for(let c=0;c<n.length;c++)if(t(i=n[c]))a=r(i),l=i.substring(a.len+2),e.push({type:"BlockName",name:a.name,comment:l}),u=!0;else if(o(i))e.push({type:"Comment",value:i}),u=!1;else if(s(i))e.push({type:"Comment",value:i}),u=!1;else if(u){"BlockText"!==e[e.length-1].type&&e.push({type:"BlockText",name:e[e.length-1].name,value:[]});let t=e[e.length-1];t.value.push(i)}else e.push({type:"Comment",value:i})}(i,e.split(n)),i.forEach(e=>{"BlockText"===e.type&&(e.value=e.value.join(n))}),i})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("refractor"),o=require("rehype");function s(e){e.languages.inilike={constant:/^[ \t]*[^\s=:]+?(?=[ \t]*[=:])/m,"attr-value":{pattern:/(=|:).*/,inside:{punctuation:/^(=|:)/}}}}s.displayName="inilike",s.aliases=[],t.register(s),e.on("语法高亮转换",function(s="@rpose/buildin:```",r){return function(o="",a="clike"){if(r||((r={}).token=e.at("哈希样式类名",s,"token"),r.comment=e.at("哈希样式类名",s,"comment"),r.selector=e.at("哈希样式类名",s,"selector")),/^(btf|rpose)$/i.test(a)){return"<ol><li>"+function(o){let s=[];return e.at("BTF内容解析",o).forEach(e=>{if("BlockName"===e.type)s.push(function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/(.*)/g,`<span class="${r.token} ${r.selector}">$1</span>`)}("["+e.name+"]")+n(e.comment));else if("BlockText"===e.type){let o=e.name;t.registered(o)||(o=/^(actions|methods|options|state)$/i.test(o)?"js":/^view$/i.test(o)?"markup":"inilike"),s.push(i(e.value,o))}else{if("Comment"!==e.type)throw new Error("unknow type");s.push(n(e.value))}}),s.join("\n")}(o).split(/\r?\n/).join("</li><li>")+"</li></ol>"}return!t.registered(a)&&(a="clike"),"<ol><li>"+i(o,a).split(/\r?\n/).join("</li><li>")+"</li></ol>"};function n(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/(\S+.*)/g,`<span class="${r.token} ${r.comment}">$1</span>`)}function i(n,i){let a=t.highlight(n,i);return function t(o){o&&o.forEach(o=>{if(o.properties&&o.properties.className){let t=[];o.properties.className.forEach(o=>{!r[o]&&(r[o]=e.at("哈希样式类名",s,o)),t.push(r[o])}),o.properties.className=t}t(o.children)})}(a),o().stringify({type:"root",children:a}).toString()}}())})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",t.plugin("f45p-astedit-transform-tag-```",function(t,o){t.walk("Tag",(t,o)=>{if("```"!==o.value)return;let s,r,n;for(let e,o=0;e=t.nodes[o++];)if("Attributes"===e.type){s=e;break}for(let e,t=0;e=s.nodes[t++];)"$CODE"===e.object.name?(r=e,e.object.value=e.object.value.replace(/\\\{/g,"{").replace(/\\\}/g,"}")):"lang"===e.object.name&&(n=e.object.value);r.object.value=e.at("语法高亮转换",r.object.value,n);let i=this.createNode({type:"Attribute"});i.object.name="@taglib",i.object.value="@rpose/buildin:```";let a=Object.assign({},o.loc);a.end.line=a.start.line,a.end.column=3,a.end.pos=a.start.pos+3,i.object.loc=a,s.addChild(i)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("f55p-astedit-normolize-flag-is-svg-tag",function(e,t){e.walk("Tag",(e,t)=>{/^svg$/i.test(t.value)&&(t.svg=!0,e.walk("Tag",(e,t)=>{t.svg=!0},{readonly:!0}))},{readonly:!0})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=/^(html|link|meta|style|title|address|article|aside|footer|header|h1|h2|h3|h4|h5|h6|hgroup|main|nav|section|blockquote|dd|dir|div|dl|dt|figcaption|figure|hr|li|ol|p|pre|ul|a|abbr|b|bdi|bdo|br|cite|code|data|dfn|em|i|kbd|mark|q|rb|rbc|rp|rt|rtc|ruby|s|samp|small|span|strong|sub|sup|time|tt|u|var|wbr|area|audio|img|map|track|video|applet|embed|iframe|noembed|object|param|picture|source|canvas|noscript|script|del|ins|caption|col|colgroup|table|tbody|td|tfoot|th|thead|tr|button|datalist|fieldset|form|input|label|legend|meter|optgroup|option|output|progress|select|textarea|details|dialog|menu|menuitem|summary|content|element|shadow|slot|template|acronym|basefont|bgsound|big|blink|center|command|font|frame|frameset|image|isindex|keygen|listing|marquee|multicol|nextid|nobr|noframes|plaintext|spacer|strike|xmp|head|base|body|math|svg)$/i;e.on("编译插件",t.plugin("f65p-astedit-normolize-flag-is-standard-tag",function(e,t){e.walk("Tag",(e,t)=>{t.standard=!!t.svg||o.test(t.value)},{readonly:!0})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("g15p-astedit-group-attribtue-{prop}",function(e,t){e.walk("Tag",(e,t)=>{if(!e.nodes||!e.nodes.length)return;let o;for(let t,s=0;t=e.nodes[s++];)if("Attributes"===t.type){o=t;break}if(!o||!o.nodes||!o.nodes.length)return;let s=[];if(o.nodes.forEach(e=>{e.object.isObjectExpression&&s.push(e)}),!s.length)return;let r=this.createNode({type:"ObjectExpressionAttributes"});s.forEach(e=>{let t=e.clone();t.type="ObjectExpressionAttribute",t.object.type="ObjectExpressionAttribute",r.addChild(t),e.remove()}),e.addChild(r)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=/^(onclick|onchange|onabort|onafterprint|onbeforeprint|onbeforeunload|onblur|oncanplay|oncanplaythrough|oncontextmenu|oncopy|oncut|ondblclick|ondrag|ondragend|ondragenter|ondragleave|ondragover|ondragstart|ondrop|ondurationchange|onemptied|onended|onerror|onfocus|onfocusin|onfocusout|onformchange|onforminput|onhashchange|oninput|oninvalid|onkeydown|onkeypress|onkeyup|onload|onloadeddata|onloadedmetadata|onloadstart|onmousedown|onmouseenter|onmouseleave|onmousemove|onmouseout|onmouseover|onmouseup|onmousewheel|onoffline|ononline|onpagehide|onpageshow|onpaste|onpause|onplay|onplaying|onprogress|onratechange|onreadystatechange|onreset|onresize|onscroll|onsearch|onseeked|onseeking|onselect|onshow|onstalled|onsubmit|onsuspend|ontimeupdate|ontoggle|onunload|onunload|onvolumechange|onwaiting|onwheel)$/i;e.on("编译插件",t.plugin("g25p-astedit-group-attribtue-events",function(e,t){e.walk("Tag",(e,t)=>{if(!e.object.standard)return;if(!e.nodes||!e.nodes.length)return;let s;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){s=t;break}if(!s||!s.nodes||!s.nodes.length)return;let r=[];if(s.nodes.forEach(e=>{o.test(e.object.name)&&r.push(e)}),!r.length)return;let n=this.createNode({type:"Events"});r.forEach(e=>{let t=e.clone();t.type="Event",t.object.type="Event",n.addChild(t),e.remove()}),e.addChild(n)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("g35p-astedit-process-attribtue-style",function(e,t){e.walk("Tag",(e,s)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let n=[];if(r.nodes.forEach(e=>{/^style$/i.test(e.object.name)&&n.push(e)}),!n.length)return;if(n.legnth>1)throw new o("duplicate attribute of style",{file:t.input.file,text:t.input.text,start:n[1].object.loc.start.pos,end:n[1].object.loc.end.pos});let i=n[0].clone();i.type="Style",i.object.type="Style",e.addChild(i),n[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("g45p-astedit-process-attribtue-class",function(e,t){e.walk("Tag",(e,s)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let n=[];if(r.nodes.forEach(e=>{/^class$/i.test(e.object.name)&&n.push(e)}),!n.length)return;if(n.legnth>1)throw new o("duplicate attribute of class",{file:t.input.file,text:t.input.text,start:n[1].object.loc.start.pos,end:n[1].object.loc.end.pos});let i=n[0].clone();i.type="Class",i.object.type="Class",i.object.classes=function(e){let t=[],o=(e=e.replace(/\{.*?\}/g,function(e){let o,s,r,n=e.substring(1,e.length-1);for(;n.indexOf(":")>0;){o=n.indexOf(":"),s=n.substring(0,o).replace(/['"]/g,"").trim();let e=(r=n.substring(o+1)).indexOf(":");e>0?(r=(r=r.substring(0,e)).substring(0,r.lastIndexOf(",")),n=n.substring(o+1+r.length+1)):n="",s&&t.push(s)}return""})).split(/\s+/);for(let e=0;e<o.length;e++)o[e].trim()&&t.push(o[e].trim());return t}(i.object.value),e.addChild(i),n[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h15p-astedit-process-attribtue-@ref",function(e,t){e.walk("Tag",(e,s)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let n=[];if(r.nodes.forEach(e=>{/^@ref$/i.test(e.object.name)&&n.push(e)}),!n.length)return;if(n.legnth>1)throw new o("duplicate attribute of @ref",{file:t.input.file,text:t.input.text,start:n[1].object.loc.start.pos,end:n[1].object.loc.end.pos});if(/^(if|for)$/.test(s.value))throw new o(`unsupport attribute @ref on tag <${s.value}>`,{file:t.input.file,text:t.input.text,start:n[0].object.loc.start.pos,end:n[0].object.loc.end.pos});let i=n[0].clone();i.type="@ref",i.object.type="@ref",e.addChild(i),n[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h25p-astedit-process-attribtue-@if",function(e,t){e.walk("Tag",(e,s)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let n=[];if(r.nodes.forEach(e=>{/^@if$/i.test(e.object.name)&&n.push(e)}),!n.length)return;if(n.legnth>1)throw new o("duplicate attribute of @if",{file:t.input.file,text:t.input.text,start:n[1].object.loc.start.pos,end:n[1].object.loc.end.pos});let i=n[0].clone();i.type="@if",i.object.type="@if",e.addChild(i),n[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h35p-astedit-process-attribtue-@show",function(e,t){e.walk("Tag",(e,s)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let n=[];if(r.nodes.forEach(e=>{/^@show$/i.test(e.object.name)&&n.push(e)}),!n.length)return;if(n.legnth>1)throw new o("duplicate attribute of @show",{file:t.input.file,text:t.input.text,start:n[1].object.loc.start.pos,end:n[1].object.loc.end.pos});if(/^(if|for)$/.test(s.value))throw new o(`unsupport attribute @show on tag <${s.value}>`,{file:t.input.file,text:t.input.text,start:n[0].object.loc.start.pos,end:n[0].object.loc.end.pos});let i=n[0].clone();i.type="@show",i.object.type="@show",e.addChild(i),n[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h45p-astedit-process-attribtue-@for",function(e,t){e.walk("Tag",(e,s)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let n=[];if(r.nodes.forEach(e=>{/^@for$/i.test(e.object.name)&&n.push(e)}),!n.length)return;if(n.legnth>1)throw new o("duplicate attribute of @for",{file:t.input.file,text:t.input.text,start:n[1].object.loc.start.pos,end:n[1].object.loc.end.pos});let i=n[0].clone();i.type="@for",i.object.type="@for",e.addChild(i),n[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h55p-astedit-process-attribtue-@csslib",function(e,t){e.walk("Tag",(e,s)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let n=[];if(r.nodes.forEach(e=>{/^@csslib$/i.test(e.object.name)&&n.push(e)}),!n.length)return;if(n.legnth>1)throw new o("duplicate attribute of @csslib",{file:t.input.file,text:t.input.text,start:n[1].object.loc.start.pos,end:n[1].object.loc.end.pos});if(/^(if|for)$/.test(s.value))throw new o(`unsupport attribute @csslib on tag <${s.value}>`,{file:t.input.file,text:t.input.text,start:n[0].object.loc.start.pos,end:n[0].object.loc.end.pos});let i=n[0].clone();i.type="@csslib",i.object.type="@csslib",e.addChild(i),n[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h65p-astedit-process-attribtue-@taglib",function(e,t){e.walk("Tag",(e,s)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let n=[];if(r.nodes.forEach(e=>{/^@taglib$/i.test(e.object.name)&&n.push(e)}),!n.length)return;if(n.legnth>1)throw new o("duplicate attribute of @taglib",{file:t.input.file,text:t.input.text,start:n[1].object.loc.start.pos,end:n[1].object.loc.end.pos});if(/^(if|for)$/.test(s.value))throw new o(`unsupport @taglib on tag <${s.value}>`,{file:t.input.file,text:t.input.text,start:n[0].object.loc.start.pos,end:n[0].object.loc.end.pos});let i=n[0].clone();i.type="@taglib",i.object.type="@taglib",e.addChild(i),n[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/hash"),o=require("@gotoeasy/file"),s=require("@gotoeasy/err"),r=require("@gotoeasy/postobject"),n=require("fs");e.on("编译插件",r.plugin("j15p-astedit-process-tag-img",function(r,i){r.walk("Tag",(r,a)=>{if(!/^img$/i.test(a.value))return;let l,u;i.result.hasImg=!0;for(let e,t=0;e=r.nodes[t++];)if("Attributes"===e.type){l=e;break}if(!l||!l.nodes||!l.nodes.length)return;for(let e,t=0;e=l.nodes[t++];)if(/^src$/i.test(e.object.name)){u=e;break}if(!u)return;let c=function(s,r){let i;if(o.exists(r))i=r;else if(i=o.resolve(s,r),!o.exists(i))return!1;let a=t({file:i})+o.extname(i),l=e.at("缓存").path+"/resources",u=l+"/"+a;return o.exists(u)||(!o.existsDir(l)&&o.mkdir(l),n.copyFileSync(i,u)),a}(i.input.file,u.object.value);if(!c)throw new s("image file not found",{file:i.input.file,text:i.input.text,start:u.object.loc.start.pos,end:u.object.loc.end.pos});u.object.value="%imagepath%"+c},{readonly:!0})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("k15p-astedit-transform-attribtue-@ref",function(t,s){t.walk("@ref",(t,r)=>{let n,i=t.parent;if(e.at("是否表达式",r.value))throw new o("@ref unsupport the expression",{file:s.input.file,text:s.input.text,start:r.loc.start.pos,end:r.loc.end.pos});for(let e,t=0;e=i.nodes[t++];)if("Attributes"===e.type){n=e;break}let a=t.clone();a.type="Attribute",a.object.type="Attribute",a.object.name="ref";let l=t.clone();l.type="Attribute",l.object.type="Attribute",l.object.name="$context",l.object.value="{$this}",l.object.isExpression=!0,n||(n=this.createNode({type:"Attributes"}),i.addChild(n)),n.addChild(a),n.addChild(l),t.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",t.plugin("k25p-astedit-transform-attribtue-@if",function(t,o){const s=e.at("视图编译选项");t.walk("@if",(e,t)=>{let o=e.parent;/^if$/i.test(o.object.value)&&(o.ok=!0);let r=s.TypeCodeBlock,n="if ("+t.value.replace(/^\s*\{=?/,"").replace(/\}\s*$/,"")+") {",i=this.createNode({type:r,value:n});o.before(i),n="}",i=this.createNode({type:r,value:n}),o.after(i),e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",t.plugin("k35p-astedit-transform-attribtue-@show",function(t,o){const s=e.at("视图编译选项");t.walk("@show",(e,t)=>{let o,r=e.parent;for(let e,t=0;e=r.nodes[t++];)if("Style"===e.type){o=e;break}let n=s.ExpressionStart+"("+t.value.replace(/^\{/,"").replace(/\}$/,"")+') ? "display:block;" : "display:none;"'+s.ExpressionEnd;o?o.object.value.endsWith(";")?o.object.value+=n:o.object.value+=";"+n:(o=this.createNode({type:"Style",value:n}),r.addChild(o)),o.object.isExpression=!0,e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");function s(e,t,s="invalid format of @for"){return new o(s,{file:e.input.file,text:e.input.text,start:t.loc.start.pos,end:t.loc.end.pos})}e.on("编译插件",t.plugin("k45p-astedit-transform-attribtue-@for",function(t,o){const r=e.at("视图编译选项");t.walk("@for",(e,t)=>{let n=e.parent;/^for$/i.test(n.object.value)&&(n.ok=!0);let i=r.TypeCodeBlock,a=function(e,t){if(!t.value)throw s(e,t);let o,r,n,i,a,l;if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s+from\s+(\w+)\s+max\s+(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r=l[2],n=l[3],i=l[4],a=l[5],/^\d+/.test(o))throw s(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(r))throw s(e,t,`invalid index name: [${r}]`);if(/^\d+/.test(a))throw s(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=${n},ARY_=(${a}),MAX_=Math.min(${i},ARY_.length),${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=${n},MAX_=Math.min(${i},${a}.length),${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s+max\s+(\w+)\s+from\s+(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r=l[2],n=l[4],i=l[3],a=l[5],/^\d+/.test(o))throw s(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(r))throw s(e,t,`invalid index name: [${r}]`);if(/^\d+/.test(a))throw s(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=${n},ARY_=(${a}),MAX_=Math.min(${i},ARY_.length),${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=${n},MAX_=Math.min(${i},${a}.length),${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s+from\s+(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r=l[2],n=l[3],a=l[4],/^\d+/.test(o))throw s(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(r))throw s(e,t,`invalid index name: [${r}]`);if(/^\d+/.test(a))throw s(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=${n},ARY_=(${a}),MAX_=ARY_.length,${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=${n},MAX_=${a}.length,${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s+max\s+(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r=l[2],i=l[3],a=l[4],/^\d+/.test(o))throw s(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(r))throw s(e,t,`invalid index name: [${r}]`);if(/^\d+/.test(a))throw s(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=0,ARY_=(${a}),MAX_=Math.min(${i},ARY_.length),${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=0,MAX_=Math.min(${i},${a}.length),${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r=l[2],a=l[3],/^\d+/.test(o))throw s(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(r))throw s(e,t,`invalid index name: [${r}]`);if(/^\d+/.test(a))throw s(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=0,ARY_=(${a}),MAX_=ARY_.length,${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=0,MAX_=${a}.length,${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r="J_",a=l[2],/^\d+/.test(o))throw s(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(r))throw s(e,t,`invalid index name: [${r}]`);if(/^\d+/.test(a))throw s(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=0,ARY_=(${a}),MAX_=ARY_.length,${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=0,MAX_=${a}.length,${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}if(l=t.value.match(/^\s*\{*\s*(\w+)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r="J_",a=l[2],/^\d+/.test(o))throw s(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(a))throw s(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=0,ARY_=(${a}),MAX_=ARY_.length,${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=0,MAX_=${a}.length,${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}throw s(e,t)}(o,t),l=t.loc,u=this.createNode({type:i,value:a,loc:l});n.before(u),a="}",u=this.createNode({type:i,value:a,loc:l}),n.after(u),e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("k55p-astedit-transform-tag-name-by-@taglib",function(t,s){t.walk("@taglib",(t,r)=>{let n=t.parent;if(n.object.standard)throw new o("unsupport @taglib on standard tag",{file:s.input.file,text:s.input.text,start:r.loc.start.pos,end:r.loc.end.pos});let i=e.at("标签项目源文件",n.object.value);if(i)throw new o(`unsupport @taglib on existed component: ${n.object.value}(${i})`,{file:s.input.file,text:s.input.text,start:r.loc.start.pos,end:r.loc.end.pos});let a,l,u,c=r.value;if(u=c.match(/^\s*.+?\s*=\s*(.+?)\s*:\s*(.+?)\s*$/))a=u[1],l=u[2];else if(u=c.match(/^\s*.+?\s*=\s*(.+?)\s*$/))a=u[1],l=n.object.value;else{if(c.indexOf("=")>=0)throw new o("invalid attribute value of @taglib",{file:s.input.file,text:s.input.text,start:r.loc.start.pos,end:r.loc.end.pos});if(u=c.match(/^\s*(.+?)\s*:\s*(.+?)\s*$/))a=u[1],l=u[2];else{if(!(u=c.match(/^\s*(.+?)\s*$/)))throw new o("invalid attribute value of @taglib",{file:s.input.file,text:s.input.text,start:r.loc.start.pos,end:r.loc.end.pos});a=u[1],l=n.object.value}}if(!e.at("自动安装",a))throw new o("package install failed: "+a,{file:s.input.file,text:s.input.text,start:r.loc.start.pos,end:r.loc.end.pos});let p=e.at("模块组件信息",a),f=e.at("标签库引用",`${a}:${l}`,p.config);if(!f)throw new o("component not found: "+r.value,{file:s.input.file,text:s.input.text,start:r.loc.start.pos,end:r.loc.end.pos});let g=e.at("标签全名",f);n.object.value=g,t.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("k65p-astedit-transform-tag-name-by-[taglib]",function(t,s){let r=Object.assign({},s.result.oTaglib);t.walk("Tag",(t,n)=>{if(n.standard)return;let i=r[n.value];if(!i)return;let a,l,u=i.split(":");if(u.length>1?(a=u[0].trim(),l=u[1].trim()):(a=i.trim(),l=n.value),!e.at("自动安装",a))throw new o("package install failed: "+a,{file:s.input.file,text:s.input.text,start:n.loc.start.pos,end:n.loc.end.pos});let c=e.at("模块组件信息",a),p=e.at("标签库引用",`${a}:${l}`,c.config);if(!p)throw new o("component not found: "+n.value,{file:s.input.file,text:s.input.text,start:n.loc.start.pos,end:n.loc.end.pos});let f=e.at("标签全名",p);n.value=f})},{readonly:!0}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("k75p-astedit-transform-tag-if-for",function(e,t){e.walk("Tag",(e,s)=>{if(/^(if|for)$/i.test(s.value)){if(!e.ok)throw new o(`missing attribute @${s.value} of tag <${s.value}>`,{file:t.input.file,text:t.input.text,start:s.loc.start.pos});e.nodes.forEach(t=>{"Attributes"!==t.type&&e.before(t.clone())}),e.remove()}})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err"),s=require("@gotoeasy/hash");e.on("编译插件",t.plugin("k85p-astedit-transform-tag-slot",function(t,r){let n=[],i=e.at("视图编译选项");t.walk("Tag",(t,s)=>{if(!/^slot$/i.test(s.value))return;let i,a=r.result.slots=r.result.slots||[];if(t.nodes)for(let e,o=0;e=t.nodes[o++];)if("Attributes"===e.type){i=e;break}if(!i||!i.nodes||!i.nodes.length){if(a.length)throw new o("missing attribute 'name' of tag <slot>",{file:r.input.file,text:r.input.text,start:s.loc.start.pos,end:s.loc.end.pos});return a.push(""),n.push(t),void(t.slotName="")}let l=[];if(i.nodes&&i.nodes.forEach(e=>{/^name$/i.test(e.object.name)&&l.push(e)}),0===l.length){if(a.length)throw new o("missing attribute 'name' of tag <slot>",{file:r.input.file,text:r.input.text,start:s.loc.start.pos,end:s.loc.end.pos});return a.push(""),n.push(t),void(t.slotName="")}if(l.length>1)throw new o("duplicate attribute of name",{file:r.input.file,text:r.input.text,start:l[1].object.loc.start.pos,end:l[1].object.loc.end.pos});if(e.at("是否表达式",l[0].object.value))throw new o("slot name unsupport the expression",{file:r.input.file,text:r.input.text,start:l[0].object.loc.start.pos,end:l[0].object.loc.end.pos});let u=l[0].object.value+"";if(a.includes(u))throw new o("duplicate slot name: "+u,{file:r.input.file,text:r.input.text,start:l[0].object.loc.start.pos,end:l[0].object.loc.end.pos});a.push(u),!u&&n.push(t),t.slotName=u});let a=r.result.slots=r.result.slots||[];if(a.length>1&&n.length)throw new o("missing slot name on tag <slot>",{file:r.input.file,text:r.input.text,start:n[0].object.loc.start.pos,end:n[0].object.loc.end.pos});if(r.result.slots){let e=r.doc.api.statekeys=r.doc.api.statekeys||[];!e.includes("$SLOT")&&e.push("$SLOT")}if(a.length){t.walk("Tag",(e,t)=>{if(!/^slot$/i.test(t.value))return;let o=i.TypeCodeBlock,r=`_Ary.push( ...slotVnodes_${s(e.slotName)} );`;e.object.loc,e.replaceWith(this.createNode({type:o,value:r}))});let e=[],o=1===a.length&&""===a[0],r=[];o&&r.push(" _hasDefinedSlotTemplate "),a.forEach(e=>{r.push(` slotVnodes_${s(e)} = [] `)}),e.push("let "+r.join(",")+";"),e.push(" ($state.$SLOT || []).forEach(vn => { "),e.push("     if (vn.a) { "),o&&e.push("     vn.a.slot !== undefined && (_hasDefinedSlotTemplate = 1); "),a.forEach(t=>{e.push(`     vn.a.slot === '${t}' && (slotVnodes_${s(t)} = vn.c || []); `)}),e.push("     } "),e.push(" }); "),o&&e.push(` !_hasDefinedSlotTemplate && !slotVnodes_${s("")}.length && (slotVnodes_${s("")} = $state.$SLOT || []); `),t.walk("View",(t,o)=>{let s=i.TypeCodeBlock,r=e.join("\n");return t.addChild(this.createNode({type:s,value:r}),0),!1})}}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("m15p-csslibify-check-@csslib",function(t,s){let r=s.result.oCsslib,n=new Set;t.walk("@csslib",(t,i)=>{if(e.at("是否表达式",i.value))throw new o("@csslib unsupport the expression",{file:s.input.file,text:s.input.text,start:i.loc.start.pos,end:i.loc.end.pos});let a=i.value.split("="),l=a.length>1?a[0].trim():"*";if(!l)throw new o("use * as empty csslib name. etc. * = "+a[1],{file:s.input.file,text:s.input.text,start:i.loc.start.pos,end:i.loc.end.pos});if(r[l])throw new o("duplicate csslib name: "+l,{file:s.input.file,text:s.input.text,start:i.loc.start.pos,end:i.loc.end.pos});if(n.has(l))throw new o("duplicate csslib name: "+l,{file:s.input.file,text:s.input.text,start:i.loc.start.pos,end:i.loc.end.pos});n.add(l)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("m17p-csslibify-gen-css-@csslib",function(t,s){let r,n,i,a=s.style,l=a.csslibset=a.csslibset||new Set,u=Object.assign({},s.result.oCsslib),c=s.result.oCsslibPkgs,p=e.on("哈希样式类名")[0],f={rename:(e,t)=>p(s.input.file,e?t+"@"+e:t)},g=s.result.atcsslibtagcss=s.result.atcsslibtagcss||[];t.walk("Class",(t,a)=>{let p;for(let e,o=0;e=t.parent.nodes[o++];)if("@csslib"===e.type){p=e;break}if(p){let o=e.at("样式库",p.object.value);u[o.name]=o,c[o.name]=o.pkg,t.parent.object.standard&&g.push(o.get(t.parent.object.value))}let d=u["*"];for(let e,t,c,p=0;e=a.classes[p++];)if(t="."+(r=e.split("@"))[0],c=r.length>1?r[1]:""){if(!(n=u[c]))throw new o("csslib not found: "+c,{file:s.input.file,text:s.input.text,start:a.loc.start.pos,end:a.loc.end.pos});if(!(i=n.get(t,f)))throw new o("css class not found: "+t,{file:s.input.file,text:s.input.text,start:a.loc.start.pos,end:a.loc.end.pos});l.add(i)}else d&&l.add(d.get(t,f))})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("n15p-astedit-remove-blank-text",function(t,o){const s=e.at("视图编译选项");t.walk(s.TypeText,(e,t)=>{if(!/^\s*$/.test(t.value)||"pre"===e.parent.object.name)return;let o=e.before(),r=e.after();o&&r&&"Tag"!==o.type&&"Tag"!==r.type&&o.type!==s.TypeHtmlComment&&r.type!==s.TypeHtmlComment&&o.type!==s.TypeCodeBlock&&r.type!==s.TypeCodeBlock||e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("n25p-astedit-remove-html-comment",function(t,o){const s=e.at("视图编译选项");t.walk(s.TypeHtmlComment,(e,t)=>{e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("n35p-astedit-join-text-node",function(t,o){const s=e.at("视图编译选项");var r;t.walk(/^(Text|Expression)$/,(e,t)=>{let o=[e],n=e.after();for(;n&&(n.type===s.TypeText||n.type===s.TypeExpression);)o.push(n),n=n.after();if(o.length<2)return;let i=[];o.forEach(e=>{e.type===s.TypeText?i.push('"'+function(e,t='"'){if(null==e)return e;let o=e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n");return'"'==t?o=o.replace(/"/g,'\\"'):"'"==t&&(o=o.replace(/'/g,"\\'")),o}(e.object.value)+'"'):((r=(r=e.object.value).trim()).startsWith("{")&&r.endsWith("}")&&(r=r.substring(1,r.length-1).trim()),!r||/^\/\/.*$/.test(r)&&r.indexOf("\n")<0||r.startsWith("/*")&&r.endsWith("*/")&&r.indexOf("*/")===r.length-2||i.push(e.object.value.replace(/^\s*\{/,"(").replace(/\}\s*$/,")")))});let a=s.ExpressionStart+i.join(" + ")+s.ExpressionEnd,l={start:o[0].object.loc.start,end:o[o.length-1].object.loc.end},u=this.createNode({type:s.TypeExpression,value:a,loc:l});e.before(u),o.forEach(e=>e.remove())})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("n45p-astedit-remove-jscode-blank-comment",function(t,o){const s=e.at("视图编译选项");var r;t.walk(s.TypeCodeBlock,(e,t)=>{(!(r=(r=t.value).trim())||/^\/\/.*$/.test(r)&&r.indexOf("\n")<0||r.startsWith("/*")&&r.endsWith("*/")&&r.indexOf("*/")===r.length-2)&&e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus");e.on("编译模板JS",function(e){return function(){if(!e){let t=new class{constructor(e="",t){let o=function(e,t,r){let n,i=t.indexOf("<%");i<0?e.push(s(e,t,r)):0==i?t.indexOf("<%=")==i?(i=(t=t.substring(3)).indexOf("%>"),n=t.substring(0,i),e.push(e.pop()+"+"+n),o(e,t.substring(i+2),!1)):(i=(t=t.substring(2)).indexOf("%>"),n=t.substring(0,i),r?e.push(n):e.push(e.pop()+";")&&e.push(n),o(e,t.substring(i+2),!0)):(n=t.substring(0,i),e.push(s(e,n,r)),o(e,t.substring(i),!1))},s=function(e,t,o){let s=t.replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\'/g,"\\'");return o?"s+='"+s+"'":e.pop()+"+'"+s+"'"},r=[];r.push("let s=''"),o(r,e,!0),r.push("return s"),this.toString=t?new Function(t,r.join("\n")):new Function(r.join("\n"))}}("\n\n// ------------------------------------------------------------------------------------------------------\n// 组件 <%= $data['COMPONENT_NAME'] %>\n// 注:应通过rpose.newComponentProxy方法创建组件代理对象后使用，而不是直接调用方法或用new创建\n// ------------------------------------------------------------------------------------------------------\n<% if ( $data['singleton'] ){ %>\n    // 这是个单例组件\n    <%= $data['COMPONENT_NAME'] %>.Singleton = true;\n<% } %>\n\n// 属性接口定义\n<%= $data['COMPONENT_NAME'] %>.prototype.$OPTION_KEYS = <%= JSON.stringify($data['optionkeys']) %>;  // 可通过标签配置的属性，未定义则不支持外部配置\n<%= $data['COMPONENT_NAME'] %>.prototype.$STATE_KEYS = <%= JSON.stringify($data['statekeys']) %>;    // 可更新的state属性，未定义则不支持外部更新state\n\n// 组件函数\nfunction <%= $data['COMPONENT_NAME'] %>(options={}) {\n\n    <% if ( $data['optionkeys'] != null ){ %>\n    // 组件默认选项值\n    this.$options = <%= $data['options'] %>;\n    rpose.extend(this.$options, options, this.$OPTION_KEYS);    // 按属性接口克隆配置选项\n    <% }else{ %>\n    // 组件默认选项值\n    this.$options = <%= $data['options'] %>;\n    <% } %>\n\n    <% if ( $data['statekeys'] != null ){ %>\n    // 组件默认数据状态值\n    this.$state = <%= $data['state'] %>;\n    rpose.extend(this.$state, options, this.$STATE_KEYS);       // 按属性接口克隆数据状态\n    <% }else{ %>\n    // 组件默认数据状态值\n    this.$state = <%= $data['state'] %>;\n    <% } %>\n\n    <% if ( $data['actions'] ){ %>\n    // 事件处理器\n    <%= $data['actions'] %>\n    <% } %>\n\n    <% if ( $data['methods'] ){ %>\n    // 自定义方法\n    <%= $data['methods'] %>;\n    <% } %>\n\n    <% if ( $data['updater'] ){ %>\n    // 组件更新函数\n    this.$updater = <%= $data['updater'] %>;\n    <% } %>\n}\n\n/**\n * 节点模板函数\n */\n<%= $data['COMPONENT_NAME'] %>.prototype.nodeTemplate = <%= $data['vnodeTemplate'] %>\n\n".replace(/\\/g,"\\\\"),"$data");e=t.toString}return e}}())})(),require("@gotoeasy/bus").on("表达式代码转换",function(e){let t=e.trim();return t.startsWith("{")&&t.endsWith("}")&&(t=t.substring(1,t.length-1)),`(${t})`}),(()=>{const e=require("@gotoeasy/bus");e.on("astgen-node-text",function(t,o){const s=e.at("视图编译选项");return t.type===s.TypeText?function(e,t){let o=[],s='"'+function(e,t='"'){if(null==e)return e;let o=e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n");return'"'==t?o=o.replace(/"/g,'\\"'):"'"==t&&(o=o.replace(/'/g,"\\'")),o}(e.object.value)+'"';return o.push("{ "),o.push(`  s: ${s} `),o.push(` ,k: ${t.keyCounter++} `),o.push("}"),o.join("\n")}(t,o):t.type===s.TypeExpression?function(e,t){let o=[],s=e.object.value.replace(/^\s*\{/,"(").replace(/\}\s*$/,")");return o.push("{ "),o.push(`  s: ${s} `),o.push(` ,k: ${t.keyCounter++} `),o.push("}"),o.join("\n")}(t,o):""})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("p15p-reference-components",function(t,s){let r=s.result,n=new Set;t.walk("Tag",(t,r)=>{if(!r.standard&&(n.add(r.value),!e.at("标签源文件",r.value)))throw new o("file not found of tag: "+r.value,{file:s.input.file,text:s.input.text,start:r.loc.start.pos})},{readonly:!0}),r.references=[...n]}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",t.plugin("p17p-components-reference-standard-tags",function(e,t){let o=t.result,s=new Set;e.walk("Tag",(e,t)=>{t.standard&&s.add(t.value)},{readonly:!0}),o.standardtags=[...s]}))})(),(()=>{const e=require("@gotoeasy/bus"),t=/^(onclick|onchange|onabort|onafterprint|onbeforeprint|onbeforeunload|onblur|oncanplay|oncanplaythrough|oncontextmenu|oncopy|oncut|ondblclick|ondrag|ondragend|ondragenter|ondragleave|ondragover|ondragstart|ondrop|ondurationchange|onemptied|onended|onerror|onfocus|onfocusin|onfocusout|onformchange|onforminput|onhashchange|oninput|oninvalid|onkeydown|onkeypress|onkeyup|onload|onloadeddata|onloadedmetadata|onloadstart|onmousedown|onmouseenter|onmouseleave|onmousemove|onmouseout|onmouseover|onmouseup|onmousewheel|onoffline|ononline|onpagehide|onpageshow|onpaste|onpause|onplay|onplaying|onprogress|onratechange|onreadystatechange|onreset|onresize|onscroll|onsearch|onseeked|onseeking|onselect|onshow|onstalled|onsubmit|onsuspend|ontimeupdate|ontoggle|onunload|onunload|onvolumechange|onwaiting|onwheel)$/i;function o(e,t='"'){if(null==e)return e;let o=e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n");return'"'==t?o=o.replace(/"/g,'\\"'):"'"==t&&(o=o.replace(/'/g,"\\'")),o}e.on("astgen-node-attributes",function(s,r){if(!s.nodes)return"";let n;for(let e,t=0;e=s.nodes[t++];)if("Attributes"===e.type){n=e;break}if(!n||!n.nodes||!n.nodes.length)return"";let i,a,l="",u=[];return u.push("{ "),n.nodes.forEach(n=>{if(i='"'+o(n.object.name)+'"',n.object.isExpression)a=e.at("表达式代码转换",n.object.value);else if("string"==typeof n.object.value)if(!s.object.standard&&t.test(n.object.name)&&!n.object.isExpression&&r.script.$actionkeys){let e=n.object.value.trim(),t=e.startsWith("$actions.")?e.substring(9):e;a=r.script.$actionkeys.includes(t)?`$actions['${t}']`:'"'+o(n.object.value)+'"'}else a='"'+o(n.object.value)+'"';else a=n.object.value;u.push(` ${l} ${i}: ${a} `),!l&&(l=",")}),u.push(" } "),u.join("\n")})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/err");e.on("astgen-node-events",function(o,s){if(!o.nodes)return"";let r;for(let e,t=0;e=o.nodes[t++];)if("Events"===e.type){r=e;break}if(!r||!r.nodes||!r.nodes.length)return"";let n,i,a="",l=[];return l.push("{ "),r.nodes.forEach(o=>{if(n=o.object.name.substring(2),i=o.object.value,o.object.isExpression)i=e.at("表达式代码转换",i);else{let e=(i=i.trim()).startsWith("$actions.")?i.substring(9):i;if(!s.script.$actionkeys||!s.script.$actionkeys.includes(e))throw new t("action not found: "+e,{file:s.input.file,text:s.input.text,start:o.object.loc.start.pos,end:o.object.loc.end.pos});i="$actions."+i}l.push(` ${a} ${n}: ${i} `),!a&&(a=",")}),l.push(" } "),l.join("\n")})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/err");function t(e,t='"'){if(null==e)return e;let o=e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n");return'"'==t?o=o.replace(/"/g,'\\"'):"'"==t&&(o=o.replace(/'/g,"\\'")),o}e.on("astgen-node-style",function(e,o){if(!e.nodes)return"";let s;for(let t,o=0;t=e.nodes[o++];)if("Style"===t.type){s=t;break}if(!s||!s.object.value)return"";if(!s.object.isExpression)return'"'+t(s.object.value)+'"';let r=[];return function e(o,s){if(/^\{\s*\{[\s\S]*?\}\s*\}$/.test(s))return void o.push(s.replace(/^\{/,"").replace(/\}$/,""));let r=s.indexOf("{");if(r<0)return void o.push('"'+t(s)+'"');let n=s.indexOf("}",r);if(n<0)return void o.push('"'+t(s)+'"');r>0&&o.push('"'+t(s.substring(0,r))+'"'),o.push("("+s.substring(r+1,n)+")");let i=s.substring(n+1);i&&e(o,i)}(r,s.object.value),"("+r.join(" + ")+")"})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/err");function t(e,t){let o=e.trim().split("@");return o.length>1?o[0]+"@"+t[o[1]]:o[0]}e.on("astgen-node-class",function(o,s){if(!o.nodes)return"";let r;for(let e,t=0;e=o.nodes[t++];)if("Class"===e.type){r=e;break}return r&&r.object.value?function(o,s){let r=s.result.oCsslibPkgs,n={},i=(o=o.replace(/\{.*?\}/g,function(o){let i,a,l,u=o.substring(1,o.length-1);for(;u.indexOf(":")>0;){i=u.indexOf(":"),a=u.substring(0,i).replace(/['"]/g,"");let o=(l=u.substring(i+1)).indexOf(":");o>0?(l=(l=l.substring(0,o)).substring(0,l.lastIndexOf(",")),u=u.substring(i+1+l.length+1)):u="",n[e.at("哈希样式类名",s.input.file,t(a,r))]="@("+l+")@"}return""})).split(/\s/);for(let o=0;o<i.length;o++)i[o].trim()&&(n[e.at("哈希样式类名",s.input.file,t(i[o],r))]=1);return JSON.stringify(n).replace(/('@|@'|"@|@")/g,"")}(r.object.value,s):""})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/err");e.on("astgen-node-{prop}",function(e,t){if(!e.nodes)return"";let o;for(let t,s=0;t=e.nodes[s++];)if("ObjectExpressionAttributes"===t.type){o=t;break}if(!o||!o.nodes||!o.nodes.length)return"";let s,r=[];return o.nodes.forEach(e=>{s=e.object.name.replace(/^\s*\{=?/,"(").replace(/\}\s*$/,")"),r.push(s)}),r.join(",")})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/hash");function t(t,o){if("Tag"!==t.type)return"";let s=t.object,r="View"===t.parent.type,n=!t.object.standard,i=e.at("astgen-node-tag-nodes",t.nodes,o),a=e.at("astgen-node-attributes",t,o),l=e.at("astgen-node-events",t,o),u=t.object.svg,c=e.at("astgen-node-style",t,o);c&&(a=a?a.replace(/\}\s*$/,`,style: ${c}}`):`{style: ${c}}`);let p=e.at("astgen-node-class",t,o);p&&(a=a?a.replace(/\}\s*$/,`,class: ${p}}`):`{class: ${p}}`);let f=e.at("astgen-node-{prop}",t,o);f&&(a=`rpose.assign( ${a}, ${f})`);let g=[];return g.push("{ "),g.push(`  t: '${s.value}' `),r&&g.push(" ,r: 1 "),n&&g.push(" ,m: 1 "),u&&g.push(" ,g: 1 "),g.push(` ,k: ${o.keyCounter++} `),i&&g.push(` ,c: ${i} `),a&&g.push(` ,a: ${a} `),l&&g.push(` ,e: ${l} `),g.push("}"),g.join("\n")}e.on("astgen-node-tag",t)})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/err"),o="_Ary";function s(s=[],r){return s.length?function(e){for(let t,o=0;t=e[o++];)if("JsCode"===t.type)return!0;return!1}(s)?function(s=[],r){let n,i=[];i.push(` ((${o}) => { `);for(let a,l=0;a=s[l++];)if("JsCode"===a.type)i.push(a.object.value);else if(n=e.at("astgen-node-tag",a,r))i.push(` ${o}.push( ${n} ); `);else if(n=e.at("astgen-node-text",a,r))i.push(` ${o}.push( ${n} ); `);else if("Attributes"===a.type||"Events"===a.type||"ObjectExpressionAttributes"===a.type);else if("Class"!==a.type&&"Style"!==a.type)throw new t("unhandle node type: "+a.type);return i.push(` return ${o}; `),i.push(" })([]) "),i.join("\n")}(s,r):function(t=[],o){let s,r=[];return t.forEach(t=>{(s=e.at("astgen-node-tag",t,o))&&r.push(s),(s=e.at("astgen-node-text",t,o))&&r.push(s)}),"["+r.join(",\n")+"]"}(s,r):""}e.on("astgen-node-tag-nodes",s)})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/file"),s=require("@gotoeasy/csjs");require("@gotoeasy/err");e.on("编译插件",t.plugin("s15p-component-ast-jsify-writer",function(e,t){t.writer=new class{constructor(){this.ary=[]}push(e){void 0!==e&&this.ary.push(e)}write(e){void 0!==e&&this.ary.push(e)}out(e){o.write(e,this.toString())}getArray(){return this.ary}toString(){let e=this.ary.join("\n");try{return s.formatJs(e)}catch(t){throw o.write(process.cwd()+"/build/error/format-error.js",e),t}}}}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=(require("@gotoeasy/file"),require("@gotoeasy/csjs"),require("@gotoeasy/err")),s="v_Array";e.on("编译插件",t.plugin("s25p-component-ast-jsify-root",function(t,r){let n=r.writer,i=r.script;t.walk("View",(t,a)=>!t.nodes||t.nodes.length<1?n.write("// 没有节点，无可生成"):(n.write("function nodeTemplate($state, $options, $actions, $this) {"),function(e){for(let t,o=0;t=e[o++];)if("JsCode"===t.type)return!0;return!1}(t.nodes)?n.write(`${function(t=[],r){let n,i=[];i.push(` let ${s} = []; `);for(let a,l=0;a=t[l++];)if("JsCode"===a.type)i.push(a.object.value);else if(n=e.at("astgen-node-tag",a,r))i.push(` ${s}.push( ${n} ); `);else{if(!(n=e.at("astgen-node-text",a,r)))throw new o("unhandle node type");i.push(` ${s}.push( ${n} ); `)}return i.push(` ${s}.length > 1 && console.warn("invlid tag count"); `),i.push(` return ${s}.length ? v_Array[0] : null; `),i.join("\n")}(t.nodes,r)}`):n.write(`${function(t=[],s){if(t.length>1){let e=s.input.text,r=s.input.file,n=t[1].object.loc.start.pos;throw"Tag"!==t[0].type&&(n=t[0].object.loc.start.pos),new o("invalid top tag",{text:e,file:r,start:n})}let r,n=t[0];if("Tag"!==n.type){let e=s.input.text,r=s.input.file,n=t[0].object.loc.start.pos;throw new o("missing top tag",{text:e,file:r,start:n})}if(r=e.at("astgen-node-tag",n,s))return`return ${r}`;if(r=e.at("astgen-node-text",n,s))return`return ${r}`;throw new o("unhandle node type")}(t.nodes,r)}`),n.write("}"),i.vnodeTemplate=n.toString(),!1))}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=(require("@gotoeasy/csjs"),require("@gotoeasy/file"),require("@gotoeasy/hash"),require("acorn")),s=require("acorn-walk"),r=require("astring"),n=require("css-selector-tokenizer");e.on("编译插件",t.plugin("s35p-component-script-selector-rename",function(t,i){let a=i.result.oCsslibPkgs,l=i.script,u=/(\.getElementsByClassName\s*\(|\.querySelector\s*\(|\.querySelectorAll\s*\(|\$\s*\(|addClass\(|removeClass\(|classList)/;function c(t,n){let i,a;try{i=o.parse(t,{ecmaVersion:10,sourceType:"module",locations:!1})}catch(e){throw new Err("syntax error",e)}return s.simple(i,{CallExpression(t){if(!t.arguments||"Literal"!==t.arguments[0].type)return;let o;if("Identifier"===t.callee.type){if("$$"!==(o=t.callee.name)&&"$"!==o)return;t.arguments[0].value=p(t.arguments[0].value,n)}else{if("MemberExpression"!==t.callee.type)return;if("getElementsByClassName"===(o=t.callee.property.name))t.arguments[0].value=e.at("哈希样式类名",n,f(t.arguments[0].value));else if("querySelector"===o||"querySelectorAll"===o)t.arguments[0].value=p(t.arguments[0].value,n);else if("addClass"===o||"removeClass"===o){let o=[];t.arguments[0].value.trim().split(/\s+/).forEach(t=>o.push(e.at("哈希样式类名",n,f(t)))),t.arguments[0].value=o.join(" ")}else{if("add"!==o&&"remove"!==o)return;if("MemberExpression"!==t.callee.object.type||"classList"!==t.callee.object.property.name)return;t.arguments[0].value=e.at("哈希样式类名",n,f(t.arguments[0].value))}}t.arguments[0].raw=`'${t.arguments[0].value}'`,a=!0}}),a?r.generate(i):t}function p(t,o){t=t.replace(/@/g,"鬱");let s=n.parse(t);return(s.nodes||[]).forEach(t=>{"selector"===t.type&&(t.nodes||[]).forEach(t=>{"class"===t.type&&(t.name=e.at("哈希样式类名",o,f(t.name)))})}),n.stringify(s).replace(/鬱/g,"@")}function f(e){let t=e.trim().split("鬱");if(t.length>1){let e=t[1];if(!a[e])throw new Error("csslib not found: "+t[0]+"@"+t[1]+"\nfile: "+i.input.file);return t[0]+"@"+e}return t[0]}l.actions&&u.test(l.actions)&&(l.actions=c(l.actions,i.input.file)),l.methods&&u.test(l.methods)&&(l.methods=c(l.methods,i.input.file))}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/csjs"),o=require("@gotoeasy/file"),s=require("@gotoeasy/postobject"),r=require("@gotoeasy/err"),n=require("acorn-globals"),i="$$,require,window,location,clearInterval,setInterval,assignOptions,rpose,$SLOT,Object,Map,Set,WeakMap,WeakSet,Date,Math,Array,String,Number,JSON,Error,Function,arguments,Boolean,Promise,Proxy,Reflect,RegExp,alert,console,window,document".split(",");e.on("编译插件",s.plugin("s45p-component-gen-js",function(s,a){let l=e.at("编译环境"),u=a.result,c=a.script,p=(a.writer,e.at("编译模板JS")),f={};if(f.COMPONENT_NAME=e.at("组件类名",a.input.file),f.options=a.doc.options||"{}",f.state=a.doc.state||"{}",a.doc.api&&(f.optionkeys=a.doc.api.optionkeys,f.statekeys=a.doc.api.statekeys),f.actions=c.actions,f.methods=c.methods,f.updater=c.updater,f.vnodeTemplate=c.vnodeTemplate,u.componentJs=p(f),u.componentJs=function(e,t){let o,s=t.doc.api.optionkeys||[],a=t.doc.api.statekeys||[];try{if(!(o=n(e)).length)return e}catch(o){throw r.cat("source syntax error","\n-----------------",e,"\n-----------------","file="+t.input.file,o)}let l=[];for(let e,n=0;n<o.length;n++){e=o[n];let u=s.includes(e.name),c=a.includes(e.name),p=i.includes(e.name);if(!u&&!c&&!p){let o="template variable undefined: "+e.name;throw o+="\n  file: "+t.input.file,new r(o)}if(u&&c){let o="template variable uncertainty: "+e.name;throw o+="\n  file: "+t.input.file,new r(o)}c?l.push(`let ${e.name} = $state.${e.name};`):u&&l.push(`let ${e.name} = $options.${e.name};`)}return e.replace(/(\n.+?prototype\.nodeTemplate\s*=\s*function\s+.+?\r?\n)/,"$1"+l.join("\n"))}(u.componentJs,a),!l.release){let s=l.path.build_temp+"/"+e.at("组件目标文件名",a.input.file)+".js";o.write(s,t.formatJs(u.componentJs))}}))})(),(()=>{require("@gotoeasy/err");const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/hash"),require("postcss")),o=require("css-selector-tokenizer");e.on("组件样式类名哈希化",function(s,r){return t([(t,r)=>{t.walkRules(t=>{let r=o.parse(t.selector);(r.nodes||[]).forEach(t=>{"selector"===t.type&&(t.nodes||[]).forEach(t=>{"class"===t.type&&(t.name=e.at("哈希样式类名",s,t.name))})}),t.selector=o.stringify(r)})}]).process(r,{from:"from.css"}).sync().root.toResult().css})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/file");require("@gotoeasy/csjs"),require("@gotoeasy/err");e.on("编译插件",t.plugin("s55p-component-gen-css",function(t,s){let r=s.style,n=[];r.csslibset&&n.push(...r.csslibset),r.less&&n.push(r.less),r.scss&&n.push(r.scss),r.css&&n.push(r.css),s.result.css=e.at("组件样式类名哈希化",s.input.file,n.join("\n"));let i=e.at("编译环境"),a=i.path.build_temp+"/"+e.at("组件目标文件名",s.input.file)+".css";i.release||(s.result.css?o.write(a,s.result.css):o.remove(a))}))})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/file"),require("@gotoeasy/postobject"));require("@gotoeasy/err");e.on("编译插件",t.plugin("w15p-component-complie-result-cache",function(t,o){e.at("组件编译缓存",o.input.file,o)}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("y15p-page-all-reference-components",function(t,o){if(!o.result.isPage)return!1;let s=new Set,r={};if(o.result.references.forEach(t=>{!function t(o,s,r){if(r[o])return;s.add(o),r[o]=!0;let n=e.at("标签源文件",o),i=e.at("组件编译缓存",n);i||(i=e.at("编译组件",n));let a=i.result.references;a.forEach(e=>{t(e,s,r)})}(t,s,r)}),s.has(o.result.tagpkg))throw new Err("circular reference: "+o.result.tagpkg);let n=[...s];n.sort(),n.push(o.result.tagpkg),o.result.allreferences=n}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("y17p-page-all-reference-standard-tags",function(t,o){if(!o.result.isPage)return!1;let s=new Set;s.add("html"),s.add("body"),o.result.standardtags.forEach(e=>s.add(e)),o.result.references.forEach(t=>{let o=e.at("标签源文件",t),r=e.at("组件编译缓存",o);!r&&(r=e.at("编译组件",o)),r.result.standardtags.forEach(e=>s.add(e))});let r=[...s];r.sort(),o.result.allstandardtags=r}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/csjs"),o=(require("@gotoeasy/hash"),require("postcss"));e.on("页面样式后处理",(s,r)=>{if(!s)return"";let n,i=e.at("编译环境"),a=e.at("缓存"),l=a.path+"/resources/from.css",u=e.at("页面目标CSS文件名",r),c=[],p=e.at("缓存资源目录数组"),f=e.at("页面图片相对路径",r),g={url:"copy",basePath:p,assetsPath:f,useHash:!1},d=JSON.stringify(["页面样式后处理",e.at("browserslist"),i.release,f,s]);if(!i.nocache){let e=a.get(d);if(e)return e.indexOf("url(")>0&&(c.push(require("postcss-url")(g)),o(c).process(s,{from:l,to:u}).sync().root.toResult()),e}c.push(require("postcss-discard-comments")({remove:e=>1})),c.push(require("postcss-normalize-whitespace")),c.push(require("postcss-discard-empty")),c.push(require("postcss-discard-duplicates")),c.push(require("autoprefixer")()),c.push(require("postcss-url")(g)),c.push(require("postcss-merge-rules")());let h=o(c).process(s,{from:l,to:u}).sync().root.toResult();return n=i.release?h.css:t.formatCss(h.css),a.set(d,n)})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/hash");e.on("编译插件",t.plugin("y25p-page-gen-css-link-components",function(t,s){if(!s.result.isPage)return!1;let r=e.at("编译环境"),n=[],i=s.result.oCsslib,a=e.at("缓存");for(let e in i){let t=o(JSON.stringify(["按需取标签样式",i[e].pkg,i[e].version,i[e]._imported,s.result.allstandardtags]));if(r.nocache){let o=i[e].get(...s.result.allstandardtags);n.push(o),a.set(t,o)}else{let o=a.get(t);if(o)n.push(o);else{let o=i[e].get(...s.result.allstandardtags);n.push(o),a.set(t,o)}}}let l=[];s.result.allreferences.forEach(t=>{let o=e.at("组件编译缓存",e.at("标签源文件",t));o||(o=e.at("编译组件",t)),o.result.atcsslibtagcss&&n.push(...o.result.atcsslibtagcss),o.result.css&&l.push(o.result.css)}),s.result.css=[...n,...l].join("\n"),s.result.pageCss=e.at("页面样式后处理",s.result.css,s.input.file)}))})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/file")),o=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",o.plugin("y35p-page-gen-html",function(o,s){if(!s.result.isPage)return!1;let r=e.at("编译环境"),n=r.path.src,i=s.input.file,a=t.name(i),l=s.doc.api.prerender,u=!s.result.pageCss;s.result.html=require(r.prerender)({srcPath:n,file:i,name:a,type:l,nocss:u})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/file"),o=require("resolve-pkg");e.on("RPOSE运行时代码",function(e){return function(){if(!e){let s=t.resolve(o("@rpose/runtime",{cwd:__dirname}),"runtime.js");e=t.read(s)}return e}}())})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/file"),o=require("@gotoeasy/postobject"),s=require("@gotoeasy/err"),r=require("fs");e.on("编译插件",o.plugin("y55p-page-gen-js-link-runtime-components",function(o,n){if(!n.result.isPage)return!1;let i=e.at("编译环境"),a=n.result.allreferences,l=e.at("RPOSE运行时代码"),u=function(o){try{let r={};for(let n,i,a,l=0;n=o[l++];){if(i="'"+n+"'",a=e.at("标签源文件",n),!t.exists(a))throw new s("component not found (tag = "+n+")");r[i]=e.at("组件类名",a)}return`rpose.registerComponents(${JSON.stringify(r).replace(/"/g,"")});`}catch(e){throw s.cat(MODULE+"gen register stmt failed",o,e)}}(a),c=function(t){try{let o=[];for(let s,r,n=0;s=t[n++];)(r=e.at("组件编译缓存",e.at("标签源文件",s)))||(r=e.at("编译组件",s)),o.push(r.result.componentJs);return o.join("\n")}catch(e){throw s.cat(MODULE+"get component src failed",t,e)}}(a);if(n.result.allstandardtags.includes("img")){let o=e.at("缓存").path+"/resources",s=e.at("页面图片相对路径",n.input.file);c=c.replace(/\%imagepath\%([0-9a-zA-Z]+\.[0-9a-zA-Z]+)/g,function(e,n){let a=o+"/"+n,l=i.path.build_dist+"/"+(i.path.build_dist_images?i.path.build_dist_images+"/":"")+n;return t.existsFile(a)&&!t.existsFile(l)&&(t.mkdir(l),r.copyFileSync(a,l)),s+n})}let p=`\n                ${l}\n\n                (function($$){\n                    // 组件注册\n                    ${u}\n\n                    ${c}\n\n                    // 组件挂载\n                    rpose.mount( rpose.newComponentProxy('${n.result.tagpkg}').render(), '${n.doc.mount}' );\n                })(rpose.$$);\n            `;n.result.pageJs=p}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/csjs"),o=require("@gotoeasy/file"),s=require("@gotoeasy/postobject");e.on("编译插件",s.plugin("y65p-page-gen-js-babel",function(s,r){if(!r.result.isPage)return!1;let n=e.at("编译环境"),i=e.at("缓存"),a=JSON.stringify(["page-gen-js-babel",e.at("browserslist"),r.result.pageJs]);if(!n.nocache){let e=i.get(a);if(e)return r.result.babelJs=e}try{r.result.babelJs=t.babel(r.result.pageJs),i.set(a,r.result.babelJs)}catch(e){throw o.write(n.path.build+"/error/babel.log",r.result.pageJs+"\n\n"+e.stack),e}}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/csjs"),o=require("@gotoeasy/file"),s=require("@gotoeasy/postobject");e.on("编译插件",s.plugin("y75p-page-gen-js-browserify-minformat",function(s,r){if(!r.result.isPage)return!1;let n=e.at("编译环境"),i=e.at("缓存"),a=JSON.stringify(["page-gen-js-browserify-minformat",e.at("browserslist"),n.release,r.result.babelJs]);if(!n.nocache){let e=i.get(a);if(e)return r.result.browserifyJs=Promise.resolve(e)}r.result.browserifyJs=new Promise((e,s)=>{(new Date).getTime(),t.browserify(r.result.babelJs,null).then(o=>{o=n.release?t.miniJs(o):t.formatJs(o),i.set(a,o),e(o)}).catch(e=>{o.write(n.path.build+"/error/browserify.log",r.result.babelJs+"\n\n"+e.stack),s(e)})})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/hash")),o=require("@gotoeasy/file"),s=require("@gotoeasy/postobject");require("@gotoeasy/err"),require("fs");e.on("编译插件",s.plugin("y85p-write-page",function(s,r){if(!r.result.isPage)return!1;let n,i=e.at("编译环境"),a=(e.at("browserslist"),(new Date).getTime());r.result.browserifyJs.then(s=>{let l=e.at("页面目标HTML文件名",r.input.file),u=e.at("页面目标CSS文件名",r.input.file),c=e.at("页面目标JS文件名",r.input.file),p=r.result.html,f=r.result.pageCss,g=s;r.result.js=g,f?o.write(u,f):o.remove(u),o.write(c,g),o.write(l,p),i.watch&&(r.result.hashcode=t(p+f+g)),n=(new Date).getTime()-a,console.info("[pack]",n+"ms -",l.substring(i.path.build_dist.length+1))}).catch(e=>{console.error("[pack]",e)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/file"),require("@gotoeasy/postobject"),require("@gotoeasy/err"),require("@gotoeasy/hash")),o=require("browserslist");e.on("browserslist",function(){let e=o();return t(e.join("\n"))})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/hash");e.on("哈希样式类名",function(o,s){let r=s;if(r.startsWith("_"))return r;const n=e.at("编译环境");if(s.indexOf("@")>0){let e=s.split("@");r=`${e[1]}---${e[0]}`}else if(r.indexOf("---")>0||r.indexOf("___")>0||r.startsWith("_"));else{let n=e.at("标签全名",o);r=`${s}___${t(n)}`}return n.release?"_"+t(r.toLowerCase()):r})})(),(()=>{const e=require("@gotoeasy/file"),t=require("@gotoeasy/bus"),o=require("@gotoeasy/npm"),s=(require("@gotoeasy/hash"),require("find-node-modules"));t.on("标签全名",t=>{let o=t.indexOf(":");if(o>0&&t.substring(o).indexOf(".")<0)return t;let s="";if((o=t.lastIndexOf("/node_modules/"))>0){let r=t.substring(o+14).split("/");s=r[0].startsWith("@")?r[0]+"/"+r[1]+":"+e.name(t):r[0]+":"+e.name(t)}else s=e.name(t);return s}),t.on("标签源文件",e=>{if(e.endsWith(".rpose"))return e;if(e.indexOf(":")>0){let o=e.split(":");o[0].indexOf("=")>0&&(o=o[0].split("="));let s=t.at("模块组件信息",o[0].trim()),r=s.files,n="/"+o[1]+".rpose";for(let e,t=0;e=r[t++];)if(e.endsWith(n))return e;return t.at("标签库引用",e,s.config)}{let o=t.at("标签项目源文件",e);if(o)return o;let s=t.at("编译环境");return t.at("标签库引用",e,s.path.root)}}),t.on("文件所在模块",e=>{let t="/",o=e.lastIndexOf("/node_modules/");if(o>0){let s=e.substring(o+14).split("/");t=s[0].startsWith("@")?s[0]+"/"+s[1]:s[0]}return t}),t.on("文件所在项目根目录",e=>{let o,s=e.lastIndexOf("/node_modules/");if(s>0){let t=[];t.push(e.substring(0,s+13));let r=e.substring(s+14).split("/");r[0].startsWith("@")?(t.push(r[0]),t.push(r[1])):t.push(r[0]),o=t.join("/")}else o=t.at("编译环境").path.root;return o}),t.on("文件所在项目配置文件",o=>{let s,r=o.lastIndexOf("/node_modules/");if(r>0){let e=[];e.push(o.substring(0,r+13));let t=o.substring(r+14).split("/");t[0].startsWith("@")?(e.push(t[0]),e.push(t[1])):e.push(t[0]),e.push("rpose.config.btf"),s=e.join("/")}else s=t.at("编译环境").path.root+"/rpose.config.btf";if(e.existsFile(s))return s}),t.on("模块组件信息",function(o=new Map){return function(r){if(r.indexOf(":")>0&&(r=r.substring(0,r.indexOf(":"))),r.lastIndexOf("@")>0&&(r=r.substring(0,r.lastIndexOf("@"))),r=r.toLowerCase(),!o.has(r)){let n=t.at("编译环境"),i=[...s({cwd:n.path.root,relative:!1}),...s({cwd:__dirname,relative:!1})];for(let t,s,n=0;t=i[n++];)if(s=e.resolve(t,r).replace(/\\/g,"/"),e.existsDir(s)){let t=JSON.parse(e.read(e.resolve(s,"package.json"))),r=t.version,n=t.name,i=n+"@"+r,a=e.files(s,"/src/**.rpose"),l=e.resolve(s,"rpose.config.btf");o.set(n,{path:s,pkg:i,name:n,version:r,files:a,config:l});break}}return o.get(r)||{files:[],config:""}}}()),t.on("组件类名",e=>{let o=t.at("标签全名",t.at("标签源文件",e));return o=("-"+(o=o.replace(/[@\/`]/g,"$").replace(/\./g,"_").replace(":","$-"))).split("-").map(e=>e.substring(0,1).toUpperCase()+e.substring(1)).join("")}),t.on("组件目标文件名",function(o){let s=t.at("编译环境");return o.startsWith(s.path.src_buildin)?"$buildin/"+e.name(o):t.at("标签全名",o).replace(":","/")}),t.on("页面目标JS文件名",function(e){let o=t.at("编译环境");return o.path.build_dist+e.substring(o.path.src.length,e.length-6)+".js"}),t.on("页面目标CSS文件名",function(e){let o=t.at("编译环境");return o.path.build_dist+e.substring(o.path.src.length,e.length-6)+".css"}),t.on("页面目标HTML文件名",function(e){let o=t.at("编译环境");return o.path.build_dist+e.substring(o.path.src.length,e.length-6)+".html"}),t.on("自动安装",function(e={}){return function(t){return t.indexOf(":")>0&&(t=t.substring(0,t.indexOf(":"))),t.lastIndexOf("@")>0&&(t=t.substring(0,t.lastIndexOf("@"))),e[t]||(o.isInstalled(t)?e[t]=!0:e[t]=o.install(t,{timeout:6e4})),e[t]}}()),t.on("页面图片相对路径",e=>{let o=t.at("编译环境"),s=e.substring(o.path.src.length).split("/");return("../".repeat(s.length-2)+o.path.build_dist_images||".")+"/"})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("z99p-log",function(e,t){}))})(),console.timeEnd("load");const bus=require("@gotoeasy/bus"),npm=require("@gotoeasy/npm"),Err=require("@gotoeasy/err"),File=require("@gotoeasy/file"),postobject=require("@gotoeasy/postobject");async function build(e){console.time("build");try{bus.at("编译环境",e);bus.at("clean"),await Promise.all(bus.at("全部编译"))}catch(e){console.error(Err.cat("build failed",e).toString())}console.timeEnd("build")}function clean(e){console.time("clean");try{bus.at("编译环境",e);bus.at("clean")}catch(e){console.error(Err.cat("clean failed",e).toString())}console.timeEnd("clean")}async function watch(e){await build(e),bus.at("文件监视")}module.exports={build,clean,watch};