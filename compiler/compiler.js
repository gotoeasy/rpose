console.time("load"),(()=>{const e=require("@gotoeasy/file"),t=require("@gotoeasy/btf"),o=require("@gotoeasy/bus"),n=(require("@gotoeasy/util"),require("@gotoeasy/err")),r=require("@gotoeasy/npm"),s=require("path");o.on("编译环境",function(o){return function(i){if(o)return o;let a=e.resolve(__dirname,"./package.json");!e.existsFile(a)&&(a=e.resolve(__dirname,"../package.json"));let l=JSON.parse(e.read(a)).version,u=e.path(a)+"/default.rpose.config.btf";return(o=function(o,i,a){let l=a.cwd||process.cwd();if(l=s.resolve(l).replace(/\\/g,"/"),!e.existsDir(l))throw new n("invalid path of cwd: "+a.cwd);let u=l;o=e.resolve(u,o),e.exists(o)||(o=i);let c={path:{}},p=new t(o),f=p.getMap("path");f.forEach((e,t)=>f.set(t,e.split("//")[0].trim()));let g={};return p.getMap("taglib").forEach((e,t)=>g[t]=e.split("//")[0].trim()),c.imports=g,c.path.cwd=l,c.path.root=u,c.path.src=u+"/src",c.path.build=function(e,t,o,n){return t.get(o)?e+"/"+t.get(o).split("/").filter(e=>!!e).join("/"):e+"/"+n.split("/").filter(e=>!!e).join("/")}(u,f,"build","build"),c.path.build_temp=c.path.build+"/temp",c.path.build_dist=c.path.build+"/dist",c.path.build_dist_images=f.get("build_dist_images")||"images",c.path.cache=f.get("cache")||".cache",c.path.cache=s.resolve(c.path.cache).replace(/\\/g,"/"),c.theme=null!=p.getText("theme")&&p.getText("theme").trim()?p.getText("theme").trim():"@gotoeasy/theme",c.prerender=null!=p.getText("prerender")&&p.getText("prerender").trim()?p.getText("prerender").trim():"@gotoeasy/pre-render",function(...t){let o=["@gotoeasy/theme","@gotoeasy/pre-render"],n=[...require("find-node-modules")({cwd:__dirname,relative:!1}),...require("find-node-modules")({cwd:process.cwd(),relative:!1})];for(let s,i=0;s=t[i++];){if(o.includes(s))continue;let t=!1;for(let o,r=0;o=n[r++];)e.isDirectoryExists(e.resolve(o,s))&&(t=!0);!t&&r.install(s)}}(c.theme,c.prerender),c}("rpose.config.btf",u,i)).clean=!!i.clean,o.release=!!i.release,o.debug=!!i.debug,o.nocache=!!i.nocache,o.build=!!i.build,o.watch=!!i.watch,o.compilerVersion=l,o.path.cache=e.resolve(o.path.cwd,o.path.cache).replace(/\\/g,"/"),o}}())})(),(()=>{const e=require("@gotoeasy/err"),t=require("@gotoeasy/file"),o=require("@gotoeasy/bus");o.on("clean",()=>{try{let n=o.at("编译环境");n.clean&&(t.remove(n.path.build),console.info("clean:",n.path.build)),t.mkdir(n.path.build_dist)}catch(t){throw e.cat(" clean failed",t)}})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/cache");!function(o={},n){e.on("组件编译缓存",function(e,t){return t?(o[e]=t,t):void 0===t?o[e]:void delete o[e]}),e.on("缓存",function(){if(!n){let o=e.at("编译环境");n=t({name:"rpose-compiler-"+o.compilerVersion,path:o.path.cache})}return n})}()})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/os"),require("@gotoeasy/hash")),o=require("@gotoeasy/file");function n(e){let t=o.name(e);if(!/[^a-zA-Z0-9_\-]/.test(t)&&/^[a-zA-Z]/.test(t))return t.toLowerCase()}function r(t,n){let r=e.at("页面目标HTML文件名",t),s=e.at("页面目标CSS文件名",t),i=e.at("页面目标JS文件名",t);o.existsFile(r)&&(o.write(r,function(e=""){return`<!doctype html><html lang="en"><head><meta charset="utf-8"></head><body>Page build failed or src file removed<p/>\n        <pre style="background:#333;color:#ddd;padding:10px;">${e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre>\n    </body>`}(n)),o.remove(s),o.remove(i))}!function(s,i={}){function a(e,n){let r=o.read(e);return{file:e,text:r,hashcode:t(r),tag:n}}function l(t){if(!t)return[];let o=[];for(let n in s){let r=e.at("组件编译缓存",n);if(r){(r.result.allreferences||[]).includes(t)&&o.push(n)}}return o}e.on("标签项目源文件",function(e){let t=i[e];if(t&&t.length)return t[0]}),e.on("源文件对象清单",function(){if(!s){s={};let t=e.at("编译环境");o.files(t.path.src,"**.rpose").forEach(e=>{let t=n(e);if(t){let o=i[t]=i[t]||[];o.push(e),1===o.length&&(s[e]=a(e,t))}else console.error("[src-file-manager]","ignore invalid source file ..........",e)});for(let e in i){let t=i[e];if(t.length>1){console.error("[src-file-manager]","duplicate tag name:",e),console.error(t);for(let e,o=1;e=t[o++];)console.error("  ignore ..........",e)}}}return s}),e.on("源文件添加",function(t){let o=n(t.file);if(!o)return console.error("[src-file-manager]","invalid source file name ..........",t.file);let r=i[o]=i[o]||[];return r.push(t.file),r.length>1?(console.error("[src-file-manager]","duplicate tag name:",o),console.error(r),void console.error("  ignore ..........",t.file)):(s[t.file]=a(t.file,o),e.at("全部编译"))}),e.on("源文件修改",function(t){let o=n(t.file),i=l(o),a=s[t.file];if(o&&a){if(a.hashcode!==t.hashcode)return s[a.file]=Object.assign({},t),i.forEach(t=>{e.at("组件编译缓存",t,!1),r(t,`rebuilding for component [${o}] changed`)}),e.at("组件编译缓存",a.file,!1),e.at("全部编译")}else delete s[t.file]}),e.on("源文件删除",function(t){let o=n(t),u=l(o),c=s[t],p=i[o];if(delete s[t],p){let n=p.indexOf(t);if(n>0)return p.splice(n,1);0===n&&(p.splice(n,1),p.length?(s[p[0]]=a(p[0],o),e.at("组件编译缓存",p[0],!1)):delete i[o])}if(o&&c)return u.forEach(t=>{e.at("组件编译缓存",t,!1),r(t,`rebuilding for component [${o}] removed`)}),e.at("组件编译缓存",c.file,!1),e.at("全部编译")})}()})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/os"),require("@gotoeasy/file")),o=require("@gotoeasy/err"),n=require("@gotoeasy/hash"),r=require("chokidar");async function s(t,n){console.time("build");let r=e.at(t,n);if(r)for(let e,t=0;e=r[t++];)try{await e}catch(e){console.error(o.cat("build failed",e).toString())}console.timeEnd("build")}function i(e){let o=t.name(e);return!(/[^a-zA-Z0-9_\-]/.test(o)||!/^[a-zA-Z]/.test(o))}e.on("文件监视",function(o={}){return function(){let a,l=e.at("编译环境");l.watch&&(e.at("热刷新服务器"),r.watch(l.path.src).on("add",async e=>{if(a&&(e=e.replace(/\\/g,"/"))&&/\.rpose$/i.test(e))if(i(e)){console.info("add ......",e);let r=t.read(e),i={file:e,text:r,hashcode:n(r)};o[e]=i,await s("源文件添加",i)}else console.info("ignored ...... add",e)}).on("change",async e=>{if(a&&(e=e.replace(/\\/g,"/"))&&/\.rpose$/i.test(e))if(i(e)){let r=t.read(e),i=n(r);if(!o[e]||o[e].hashcode!==i){console.info("change ......",e);let t={file:e,text:r,hashcode:i};o[e]=t,await s("源文件修改",t)}}else console.info("ignored ...... change",e)}).on("unlink",async e=>{a&&(e=e.replace(/\\/g,"/"))&&/\.rpose$/i.test(e)&&(i(e)?(console.info("del ......",e),delete o[e],await s("源文件删除",e)):console.info("ignored ...... del",e))}).on("ready",()=>{a=!0}))}}())})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/os"),require("@gotoeasy/file");e.on("全部编译",function(t){let o,n,r=e.at("源文件对象清单"),s=e.at("编译环境"),i=[];for(let t in r){o=(new Date).getTime();let a=e.at("编译组件",r[t]);a.result.browserifyJs&&i.push(a.result.browserifyJs),(n=(new Date).getTime()-o)>100&&console.info("[compile] "+n+"ms -",t.replace(s.path.src+"/",""))}return i})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/file"),o=require("@gotoeasy/hash"),n=require("@gotoeasy/postobject");e.on("编译组件",function(r){let s;if(r.file)s=r;else{let n,i,a;if(n=e.at("标签源文件",r),!t.existsFile(n))throw new Err(`file not found: ${n} (${r})`);s={file:n,text:i=t.read(n),hashcode:a=o(i)}}let i=e.at("编译环境"),a=e.at("组件编译缓存",s.file);if(a&&a.input.hashcode!==s.hashcode&&(a=e.at("组件编译缓存",s.file,!1)),!a){let t=e.on("编译插件");return n(t).process({...s},{log:i.debug})}return a})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/file"),o=require("@gotoeasy/hash"),n=require("fs"),r=require("url"),s=require("path"),i=require("http"),a=require("opn"),l="rebuilding...";e.on("热刷新服务器",function(u){return function(){let c=e.at("编译环境");c.watch&&function(c,p){i.createServer(function(i,a){let p=r.parse(i.url);if(/^\/query$/i.test(p.pathname))return void function(n,r,s){u=!0;let i=e.at("编译环境"),a=s.query.split("&")[0].split("=")[1],c=t.resolve(i.path.src,a.substring(0,a.length-5)+".rpose"),p="";if(t.existsFile(c)){let n=e.at("组件编译缓存",c);if(n&&(p=n.result.hashcode||""),!p){let n=e.at("页面目标HTML文件名",c),r=e.at("页面目标CSS文件名",c),s=e.at("页面目标JS文件名",c);if(t.existsFile(n)){let e=t.read(n);if(e.indexOf("<body>Page build failed or src file removed<p/>")>0)p=l;else{let n=t.existsFile(r)?t.read(r):"",i=t.existsFile(s)?t.read(s):"";p=o(e+n+i)}}}}r.writeHead(200),r.end(p)}(0,a,p);let f=s.join(c,p.pathname).replace(/\\/g,"/");t.existsDir(f)&&(f=t.resolve(f,"index.html")),/\.html$/i.test(f)?t.existsFile(f)?function(n,r,s,i){let a=e.at("编译环境"),u=t.resolve(a.path.src,i.substring(a.path.build_dist.length+1,i.length-5)+".rpose"),c=e.at("组件编译缓存",u),p=c?c.result.hashcode||"":null;if(!p){let n=e.at("页面目标HTML文件名",u),r=e.at("页面目标CSS文件名",u),s=e.at("页面目标JS文件名",u);if(t.existsFile(n)){let e=t.read(n),i=t.existsFile(r)?t.read(r):"",a=t.existsFile(s)?t.read(s):"";p=o(e+i+a)}}let f=`\n        <script>\n            var _times_ = 0;\n            function refresh() {\n                let url = '/query?page=${i.substring(a.path.build_dist.length+1)}&t=' + new Date().getTime();\n                ajaxAsync(url, function(rs){\n                    if ( rs !== '${p}' ) {\n                        if ( rs === '${l}' ) {\n                            _times_++;\n                            _times_ >= 5 ? location.reload() : setTimeout(refresh, 1000);\n                        }else{\n                            location.reload();\n                        }\n                    }else{\n                        _times_ = 0;\n                        setTimeout(refresh, 1000);\n                    }\n                }, function(err){\n                    _times_ = 0;\n                    setTimeout(refresh, 1000);\n                });\n            }\n\n            function ajaxAsync(url, fnCallback, fnError) {\n                var xhr = new XMLHttpRequest();\n                xhr.onreadystatechange = function (xxx, eee) {\n                    if (xhr.readyState === 4 && xhr.status === 200) {\n                        fnCallback(xhr.responseText);\n                    }\n                };\n                xhr.onerror = fnError;\n                xhr.open("GET", url, true);\n                xhr.send();\n            }\n\n            setTimeout(refresh, 3000);\n        <\/script>`,g=t.read(i).replace(/<head>/i,"<head>"+f);r.writeHead(200,{"Content-Type":"text/html;charset=UFT8"}),r.end(g)}(0,a,0,f):(a.writeHead(404),a.end("404 Not Found")):t.existsFile(f)?(/\.css$/i.test(f)?a.writeHead(200,{"Content-Type":"text/css;charset=UFT8"}):a.writeHead(200),n.createReadStream(f).pipe(a)):/favicon\.ico$/i.test(f)?(a.writeHead(200),a.end(null)):(a.writeHead(404),a.end("404 Not Found"))}).listen(p);let f="http://localhost:"+p;console.log("-------------------------------------------"),console.log(` server ready ...... ${f}`),console.log("-------------------------------------------"),setTimeout(()=>{!u&&a(f)},1e3)}(c.path.build_dist,3700)}}())})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("b00p-log",function(e,t){}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("b01p-init-context",function(e,t){t.input={},t.doc={},t.style={},t.script={},t.keyCounter=1,t.result={},e.walk((e,o)=>{t.input.file=o.file,t.input.text=o.text,t.input.hashcode=o.hashcode},{readonly:!0})}))})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/postobject");function t(e){return e.startsWith("[")&&e.indexOf("]")>0}function o(e){return e.startsWith("---------")}function n(e){return e.startsWith("=========")}function r(e){let t,o;for(let n=1;n<e.length;n++)if("\\"!==e.charAt(n-1)&&"]"===e.charAt(n))return o=(t=e.substring(1,n).toLowerCase()).length,{name:t=t.replace(/\\\]/g,"]"),len:o};return o=(t=e.substring(1,e.lastIndexOf("]")).toLowerCase()).length,{name:t=t.replace(/\\\]/g,"]"),len:o}}function s(e,t){let o=0;for(let n=0;n<t;n++)o+=e[n];return o}e.on("项目配置文件解析",function(e,i=!0){let a=e.indexOf("\r\n")>=0?"\r\n":"\n",l=e.split(a),u=l.map(e=>e.length+a.length),c=[];return function(e,i,a,l){let u,c,p,f,g=!1;for(let l=0;l<i.length;l++)if(t(u=i[l])){c={type:"ProjectBtfBlock"},p=r(u),f=u.substring(p.len+2);let t=l+1,o=1,n=s(a,t-1),i={line:t,column:o,pos:n};o=p.len+3,n+=o-1,end={line:t,column:o,pos:n},c.name={type:"ProjectBtfBlockName",value:p.name,loc:{start:i,end}},f&&(o=p.len+3,i={line:t,column:o,pos:n},o=u.length+1,n=s(a,t-1)+o-1,end={line:t,column:o,pos:n},c.comment={type:"ProjectBtfBlockComment",value:f,loc:{start:i,end}}),c.buf=[],e.push(c),g=!0}else if(o(u))g=!1;else{if(n(u))return;if(g){let t=e[e.length-1].buf;"\\"===u.charAt(0)&&(/^\\+\[.*\]/.test(u)||/^\\+\---------/.test(u)||/^\\+\=========/.test(u))?t.push(u.substring(1)):t.push(u)}}}(c,l,u),c.forEach(e=>{if(e.buf.length){let t="ProjectBtfBlockText",o=e.buf.join(a),n=e.name.loc.start.line+1,r=1,i=s(u,n-1),l={line:n,column:r,pos:i};n=e.name.loc.start.line+e.buf.length,r=e.buf[e.buf.length-1].length+1,i=s(u,n-1)+r,1===r&&e.buf.length>1&&(n--,r=e.buf[e.buf.length-2].length+1),end={line:n,column:r,pos:i},e.text={type:t,value:o,loc:{start:l,end}}}delete e.buf,!1===i&&(delete e.name.loc,void 0!==e.comment&&delete e.comment.loc,void 0!==e.text&&delete e.text.loc)}),{nodes:c}})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/err"),require("@gotoeasy/file")),o=require("csslibify");e.on("样式库",function(n={}){return function(r="",s=""){let i,a=r.split("=");if(a.length>1&&!s?(s=a[1],r=a[0].trim()):r.indexOf(":")>0&&(s=r,r=""),!s){let e=n[r]||o(r);return e.name=r,e}let l,u=[];(i=s.match(/^.*?=(.*?):(.*)$/))?(l=i[1].trim(),cssfilter=i[2],cssfilter.replace(/;/g,",").split(",").forEach(e=>{(e=e.trim())&&u.push(e)})):(i=s.match(/^.*?=(.*)$/))?(l=i[1].trim(),u.push("**.min.css")):(i=s.match(/^(.*?):(.*)$/))?(l=i[1].trim(),cssfilter=i[2],cssfilter.replace(/;/g,",").split(",").forEach(e=>{(e=e.trim())&&u.push(e)})):(l=s.trim(),u.push("**.min.css")),l.lastIndexOf("@")>1&&(l=l.substring(0,l.lastIndexOf("@")));let c=function(o){e.at("自动安装",o);let n=[...require("find-node-modules")({cwd:process.cwd(),relative:!1}),...require("find-node-modules")({cwd:__dirname,relative:!1})];for(let e,r,s=0;e=n[s++];)if(r=t.resolve(e,o),t.existsDir(r))return r;throw new Error("path not found of npm package: "+o)}(l),p=t.files(c,...u),f=n[r]||o(r);return p.forEach(e=>f.imp(e)),r&&(n[r]=f),f.name=r,f}}()),e.on("样式库引用",function(t,...o){return e.at("样式库",t).get(...o)})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/postobject"),require("@gotoeasy/err"));e.on("解析[csslib]",function(e,o,n){let r={},s=(null==e?"":e.trim()).split("\n");for(let e,i=0;i<s.length;i++){let a,l,u=(e=s[i]).indexOf("=");if(!(u<0)){if(a=e.substring(0,u).trim(),(u=(l=e.substring(u+1).trim()).lastIndexOf("//"))>=0&&(l=l.substring(0,u).trim()),!a)throw new t("use * as empty csslib name. etc. * = "+l,{file:o.input.file,text:o.input.text,line:n.start.line+i,column:1});if(r[a])throw new t("duplicate csslib name: "+a,{file:o.input.file,text:o.input.text,line:n.start.line+i,column:1});r[a]=l}}return r})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/err"),require("@gotoeasy/file")),o=require("@gotoeasy/btf");require("csslibify");e.on("标签库定义",function(n={},r={}){let s=[];return e.on("标签库引用",function(t,o){let r,s=e.at("文件所在模块",o),i=t.indexOf("="),a=t.indexOf(":");return r=i<0&&a<0?t.trim():a>0?t.substring(a+1).trim():t.substring(0,i).trim(),n[s+":"+r]}),function(i,a){let l=e.at("normalize-taglib",i);!function(o){if(!r[o]){let s=e.at("模块组件信息",o);for(let e,o=0;e=s.files[o++];)n[s.name+":"+t.name(e)]=e;r[o]=!0}}(l.pkg);let u,c,p,f=e.at("文件所在模块",a);if(u=f+":"+l.astag,c=l.pkg+":"+l.tag,n[c])return n[u]=n[c],s=[],n;s.push(`[${f}] ${l.taglib}`);try{p=require.resolve(l.pkg+"/package.json",{paths:[e.at("编译环境").path.root,__dirname]})}catch(e){s.unshift(e.message);let t=s.join("\n => ");throw s=[],new Error(t)}let g=t.path(p)+"/rpose.config.btf";if(!t.existsFile(g)){s.unshift(`tag [${l.tag}] not found in package [${l.pkg}]`);let e=s.join("\n => ");throw s=[],new Error(e)}let d,h=new o(g).getText("taglib");try{d=e.at("解析[taglib]",h,{input:{file:g}})}catch(e){s.push(`[${l.pkg}] ${l.pkg}:${l.tag}`),s.push(g),s.unshift(e.message);let t=s.join("\n => ");throw s=[],new Error(t)}let b=d[l.tag];if(!b){s.push(g),s.unshift(`tag [${l.tag}] not found in package [${l.pkg}]`);let e=s.join("\n => ");throw s=[],new Error(e)}return e.at("自动安装",b.pkg),e.at("标签库定义",b.taglib,g)}}())})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/postobject"),require("@gotoeasy/err");e.on("normalize-taglib",function(e,t=0){let o,n,r,s;if(s=e.match(/^\s*([\S]+)\s*=\s*([\S]+)\s*:\s*([\S]+)\s*$/))o=s[1],n=s[2],r=s[3];else if(s=e.match(/^\s*([\S]+)\s*=\s*([\S]+)\s*$/))o=s[1],n=s[2],r=s[1];else{if(!(s=e.match(/^\s*([\S]+)\s*:\s*([\S]+)\s*$/)))return null;o=s[2],n=s[1],r=s[2]}return{line:t,astag:o,pkg:n,tag:r,taglib:o+"="+n+":"+r}})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/postobject"),require("@gotoeasy/err"));e.on("解析[taglib]",function(o,n,r){let s={},i=(null==o?"":o.trim()).split("\n");for(let o,a,l=0;l<i.length;l++)if(o=i[l].split("//")[0].trim()){if(!(a=e.at("normalize-taglib",o,l))){if(r)throw new t("invalid taglib: "+a.taglib,{file:n.input.file,text:n.input.text,line:r.start.line+l,column:1});throw new t(`invalid taglib: ${o}`)}if(/^(if|for)$/i.test(a.astag)){if(r)throw new t("can not use buildin tag name: "+a.astag,{file:n.input.file,text:n.input.text,line:r.start.line+l,column:1});throw new t("can not use buildin tag name: "+a.astag)}if(s[a.astag]){if(r)throw new t("duplicate tag name: "+a.astag,{file:n.input.file,text:n.input.text,line:r.start.line+l,column:1});throw new t("duplicate tag name: "+a.astag)}s[a.astag]=a}return s})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/file"),n=require("@gotoeasy/err");e.on("编译插件",t.plugin("b95p-init-project-config",function(t,o){o.project=e.at("项目配置处理",o.input.file)})),e.on("项目配置处理",function(n={}){return function(r){let s=r.endsWith("/rpose.config.btf")?r:e.at("文件所在项目配置文件",r);if(n[s])return n[s];if(!o.existsFile(s))return{};let i=e.on("项目配置处理插件"),a=t(i).process({file:s});return n[s]=a.result,n[s]}}()),e.on("项目配置处理插件",t.plugin("process-project-config-101",function(t,n){n.input={},n.result={},t.walk((t,r)=>{n.input.file=r.file,n.input.text=o.read(r.file);let s=e.at("项目配置文件解析",n.input.text),i=this.createNode(s);t.replaceWith(...i.nodes)}),t.walk((e,t)=>{if(!t.text||!t.text.value||!t.text.value.trim())return e.remove();let o=t.name.value,n=t.text.value,r=t.text.loc,s=this.createNode({type:o,value:n,loc:r});e.replaceWith(s)})})),e.on("项目配置处理插件",t.plugin("process-project-config-102",function(t,o){let n;if(e.on("哈希样式类名")[0],t.walk("csslib",(t,r)=>{n=e.at("解析[csslib]",r.value,o,r.loc),t.remove()}),!n)return;let r=o.result.oCsslib={};for(let t in n)r[t]=e.at("样式库",t,n[t])})),e.on("项目配置处理插件",function(o){return t.plugin("process-project-config-103",function(t,n){if(!o){let t="@rpose/buildin";if(!e.at("自动安装",t))throw new Error("package install failed: "+t);e.at("标签库定义","@rpose/buildin:```",""),e.at("标签库定义","@rpose/buildin:router",""),e.at("标签库定义","@rpose/buildin:router-link",""),o=!0}})}()),e.on("项目配置处理插件",function(o){return t.plugin("process-project-config-105",function(t,r){let s,i;if(t.walk("taglib",(t,o)=>{s=e.at("解析[taglib]",o.value,r,o.loc),i=o.loc.start.line,t.remove()}),r.result.oTaglib=s||{},!s)return;let a=new Map;for(let e in s)a.set(s[e].pkg,s[e]);a.forEach((t,o)=>{if(!e.at("自动安装",o))throw new n("package install failed: "+o,{file:r.input.file,text:r.input.text,line:i+t.line,column:1})});for(let t in s)try{e.at("标签库定义",s[t].taglib,r.input.file)}catch(e){throw new n.cat(e,{file:r.input.file,text:r.input.text,line:i+s[t].line,column:1})}if(!o){if(pkg="@rpose/buildin",!e.at("自动安装",pkg))throw new Error("package install failed: "+pkg);e.at("标签库定义","@rpose/buildin:```",""),e.at("标签库定义","@rpose/buildin:router",""),e.at("标签库定义","@rpose/buildin:router-link",""),o=!0}})}())})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/postobject");function t(e){return e.startsWith("[")&&e.indexOf("]")>0}function o(e){return e.startsWith("---------")}function n(e){return e.startsWith("=========")}function r(e){let t,o;for(let n=1;n<e.length;n++)if("\\"!==e.charAt(n-1)&&"]"===e.charAt(n))return o=(t=e.substring(1,n).toLowerCase()).length,{name:t=t.replace(/\\\]/g,"]"),len:o};return o=(t=e.substring(1,e.lastIndexOf("]")).toLowerCase()).length,{name:t=t.replace(/\\\]/g,"]"),len:o}}function s(e,t){let o=0;for(let n=0;n<t;n++)o+=e[n];return o}e.on("RPOSE源文件解析",function(e,i=!0){let a=e.indexOf("\r\n")>=0?"\r\n":"\n",l=e.split(a),u=l.map(e=>e.length+a.length),c=[];return function(e,i,a,l){let u,c,p,f,g=!1;for(let l=0;l<i.length;l++)if(t(u=i[l])){c={type:"RposeBlock"},p=r(u),f=u.substring(p.len+2);let t=l+1,o=1,n=s(a,t-1),i={line:t,column:o,pos:n};o=p.len+3,n+=o-1,end={line:t,column:o,pos:n},c.name={type:"RposeBlockName",value:p.name,loc:{start:i,end}},f&&(o=p.len+3,i={line:t,column:o,pos:n},o=u.length+1,n=s(a,t-1)+o-1,end={line:t,column:o,pos:n},c.comment={type:"RposeBlockComment",value:f,loc:{start:i,end}}),c.buf=[],e.push(c),g=!0}else if(o(u))g=!1;else{if(n(u))return;if(g){let t=e[e.length-1].buf;"\\"===u.charAt(0)&&(/^\\+\[.*\]/.test(u)||/^\\+\---------/.test(u)||/^\\+\=========/.test(u))?t.push(u.substring(1)):t.push(u)}}}(c,l,u),c.forEach(e=>{if(e.buf.length){let t="RposeBlockText",o=e.buf.join(a),n=e.name.loc.start.line+1,r=1,i=s(u,n-1),l={line:n,column:r,pos:i};n=e.name.loc.start.line+e.buf.length,r=e.buf[e.buf.length-1].length+1,i=s(u,n-1)+r,1===r&&e.buf.length>1&&(n--,r=e.buf[e.buf.length-2].length+1),end={line:n,column:r,pos:i},e.text={type:t,value:o,loc:{start:l,end}}}delete e.buf,!1===i&&(delete e.name.loc,void 0!==e.comment&&delete e.comment.loc,void 0!==e.text&&delete e.text.loc)}),{nodes:c}})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("c15p-parse-rpose-src-to-blocks",function(t,o){let n=o.result;t.walk((t,o)=>{n.tagpkg=e.at("标签全名",o.file);let r=e.at("RPOSE源文件解析",o.text),s=this.createNode(r);return t.replaceWith(...s.nodes),!1})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("c25p-blocks-to-context-doc",function(e,t){let o=t.doc;e.walk("RposeBlock",(e,t)=>{/^(api|options|state|mount)$/.test(t.name.value)&&(o[t.name.value]=t.text?t.text.value:"",e.remove())})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("c35p-normalize-context-doc",function(e,t){let o=t.doc;o.api=function(e){let t={};return(null==e?"":e.trim()).split("\n").forEach(e=>{let o,n,r=e.indexOf("=");r<0&&(r=e.indexOf(":")),r<0||(o=e.substring(0,r).trim(),(r=(n=e.substring(r+1).trim()).lastIndexOf("//"))>=0&&(n=n.substring(0,r).trim()),/^option[\-]?keys$/i.test(o)?(o="optionkeys",n=n.split(/[,;]/).map(e=>e.trim())):/^state[\-]?keys$/i.test(o)?(o="statekeys",n=n.split(/[,;]/).map(e=>e.trim())):/^pre[\-]?render$/i.test(o)&&(o="prerender"),t[o]=n)}),t}(o.api),o.mount&&(o.mount=o.mount.trim())}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("c45p-is-page",function(e,t){t.result.isPage=t.doc.mount&&!/\/components\//i.test(t.input.file)&&!/\/node_modules\//i.test(t.input.file)}))})(),(()=>{const e=require("@gotoeasy/err"),t=require("@gotoeasy/bus"),o=require("@gotoeasy/btf"),n=require("@gotoeasy/file");function r(t){let o=[...require("find-node-modules")({cwd:__dirname,relative:!1}),...require("find-node-modules")({relative:!1})];for(let e,r,s=0;e=o[s++];)if(r=e.replace(/\\/g,"/")+"/"+t+"/theme.btf",n.exists(r))return r;throw new e("theme file not found: "+t+"/theme.btf")}t.on("样式风格",function(i){return function(){let a=t.at("编译环境");try{let l;if(!i){if(a.theme){l=function t(n){if(s.has(n)){let t=[...s].push(n);throw e.cat(t,new e("theme circular extend"))}s.add(n);btf=new o(n);let i=(btf.getText("extend")||"").trim();let a;let l=btf.getMap("theme");i&&(a=t(r(i)),l.forEach((e,t)=>a.set(t,e)),l=a);return l}(function(){let o,s=t.at("编译环境");if(s.theme.endsWith(".btf")){if(n.exists(o))return o;if(o=n.resolve(s.path.root,s.theme),n.exists(o))return o;throw new e("theme file not found: "+o)}return r(s.theme)}())}else l=new Map;i={less:function(e){let t=[];return e.forEach((e,o)=>t.push("@"+o+" : "+e+";")),t.join("\n")+"\n"}(l),scss:function(e){let t=[];return e.forEach((e,o)=>t.push("$"+o+" : "+e+";")),t.join("\n")+"\n"}(l),css:function(e){if(!e.size)return"";let t=[];return t.push(":root{"),e.forEach((e,o)=>t.push("--"+o+" : "+e+";")),t.push("}"),t.join("\n")+"\n"}(l)}}return i}catch(t){throw e.cat("init theme failed: "+a.theme,t)}}}());const s=new Set})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/csjs");e.on("编译插件",t.plugin("d15p-compile-component-scss",function(t,n){let r=n.style;t.walk("RposeBlock",(t,n)=>{if(/^scss$/.test(n.name.value)){let s=n.text?n.text.value:"";if(s){let t=e.at("样式风格");r.scss=function(t){let n=e.at("编译环境"),r=e.at("缓存"),s=JSON.stringify(["scssToCss",t]);if(!n.nocache){let e=r.get(s);if(e)return e}let i=o.scssToCss(t);return r.set(s,i)}(t.scss+s)}return t.remove(),!1}})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/csjs");e.on("编译插件",t.plugin("d25p-compile-component-less",function(t,n){let r=n.style;t.walk("RposeBlock",(t,n)=>{if(/^less$/.test(n.name.value)){let s=n.text?n.text.value:"";if(s){let t=e.at("样式风格");r.less=function(t){let n=e.at("编译环境"),r=e.at("缓存"),s=JSON.stringify(["lessToCss",t]);if(!n.nocache){let e=r.get(s);if(e)return e}let i=o.lessToCss(t);return r.set(s,i)}(t.less+s)}return t.remove(),!1}})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/hash"),o=require("postcss");module.exports=e.on("样式统一化整理",(n,r,s,i)=>{let a=r+"/from.css",l=s+"/to.css",u={url:"copy",from:a,to:l,basePath:r,assetsPath:i,useHash:!0,hashOptions:{method:e=>t({contents:e})}},c=e.at("编译环境"),p=e.at("缓存"),f=JSON.stringify(["样式统一化整理",n,r,s,i]),g=[];if(!c.nocache){let e=p.get(f);if(e)return e.indexOf("url(")>0&&(g.push(require("postcss-url")(u)),o(g).process(e,{from:a,to:l}).sync().root.toResult()),e}g.push(require("postcss-import-sync")({from:a})),g.push(require("postcss-unprefix")()),g.push(require("postcss-url")(u)),g.push(require("postcss-nested")()),g.push(require("postcss-css-variables")()),g.push(require("postcss-discard-comments")({remove:e=>1})),g.push(require("postcss-minify-selectors")),g.push(require("postcss-minify-params")),g.push(require("postcss-normalize-string")),g.push(require("postcss-normalize-display-values")),g.push(require("postcss-normalize-positions")),g.push(require("postcss-normalize-repeat-style")),g.push(require("postcss-minify-font-values")),g.push(require("postcss-minify-gradients")),g.push(require("postcss-color-hex-alpha")),g.push(require("postcss-merge-longhand"));let d=o(g).process(n,{from:a,to:l}).sync().root.toResult();return p.set(f,d.css)})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/file");e.on("编译插件",t.plugin("d35p-normalize-component-css",function(t,n){let r=n.style;if(t.walk("RposeBlock",(t,o)=>{if(/^css$/.test(o.name.value)){let n=o.text?o.text.value:"";if(n){let t=e.at("样式风格");r.css=t.css+n}return t.remove(),!1}}),!r.css)return;e.at("编译环境");let s=e.at("缓存"),i=o.path(n.input.file),a=s.path+"/resources";r.css=e.at("样式统一化整理",r.css,i,a,".")}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err"),n=require("acorn"),r=require("astring");e.on("编译插件",t.plugin("d45p-normalize-component-actions",function(t,s){let i=s.script;t.walk("RposeBlock",(t,s)=>{if(!/^actions$/.test(s.name.value))return;let a=s.text?s.text.value.trim():"";if(a){let t=function(t,s){let i,a=e.at("编译环境"),l=e.at("缓存"),u=JSON.stringify(["generateActions",t]);if(!a.nocache){let e=l.get(u);if(e)return e}return i=t.startsWith("{")?function(e,t){let s,i=`this.$actions     = ${e}`;try{s=n.parse(i,{ecmaVersion:10,sourceType:"module",locations:!0})}catch(e){throw new o("syntax error in [actions]",e)}let a=[],l=s.body[0].expression.right.properties;l&&l.forEach(e=>{if("ArrowFunctionExpression"==e.value.type)a.push(e.key.name);else if("FunctionExpression"==e.value.type){let t=e.value;t.type="ArrowFunctionExpression",a.push(e.key.name)}});let u={src:"",names:a};return a.length&&(a.sort(),u.src=r.generate(s)),u}(t):function(e,t){let s;try{s=n.parse(e,{ecmaVersion:10,sourceType:"module",locations:!0})}catch(e){throw new o("syntax error in [actions]",e)}let i=new Map;s.body.forEach(e=>{let t;"FunctionDeclaration"==e.type?(e.type="ArrowFunctionExpression",i.set(e.id.name,r.generate(e))):"VariableDeclaration"==e.type?"FunctionDeclaration"!=(t=e.declarations[0].init).type&&"ArrowFunctionExpression"!=t.type||(t.type="ArrowFunctionExpression",i.set(e.declarations[0].id.name,r.generate(t))):"ExpressionStatement"==e.type&&("FunctionDeclaration"!=(t=e.expression.right).type&&"ArrowFunctionExpression"!=t.type||(t.type="ArrowFunctionExpression",i.set(e.expression.left.name,r.generate(t))))});let a=[...i.keys()],l={src:"",names:a};if(a.length){let e=[];e.push("this.$actions = {"),a.forEach(t=>{e.push('"'+t+'": '+i.get(t)+",")}),e.push("}"),l.src=e.join("\n")}return l}(t),l.set(u,i)}(a,s.text.loc);i.actions=t.src,i.$actionkeys=t.names}return t.remove(),!1})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("acorn"),n=require("astring");e.on("编译插件",t.plugin("d55p-normalize-component-methods",function(t,r){let s=r.script;t.walk("RposeBlock",(t,r)=>{if(!/^methods$/.test(r.name.value))return;let i=r.text?r.text.value.trim():"";if(i){let t=function(t,r){let s=e.at("编译环境"),i=e.at("缓存"),a=JSON.stringify(["generateMethods",t]);if(!s.nocache){let e=i.get(a);if(e)return e}let l,u=`oFn               = ${t}`;try{l=o.parse(u,{ecmaVersion:10,sourceType:"module",locations:!0})}catch(e){throw new Err("syntax error in [methods]",e)}let c=new Map,p=l.body[0].expression.right.properties;p&&p.forEach(e=>{if("ArrowFunctionExpression"==e.value.type)c.set(e.key.name,"this."+e.key.name+"="+n.generate(e.value));else if("FunctionExpression"==e.value.type){let t=e.value;t.type="ArrowFunctionExpression",c.set(e.key.name,"this."+e.key.name+"="+n.generate(t))}});let f=[...c.keys()];f.sort();let g={src:"",names:f};return f.forEach(e=>g.src+=c.get(e)+"\n"),i.set(a,g)}(i,r.text.loc);s.methods=t.src}return t.remove(),!1})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=(require("@gotoeasy/csjs"),require("@gotoeasy/file"),require("@gotoeasy/hash"),require("acorn")),n=require("acorn-walk"),r=require("astring"),s=require("css-selector-tokenizer");function i(t,i){let a,l;try{a=o.parse(t,{ecmaVersion:10,sourceType:"module",locations:!1})}catch(e){throw new Err("syntax error",e)}return n.simple(a,{CallExpression(t){if(!t.arguments||"Literal"!==t.arguments[0].type)return;let o=t.callee.name||t.callee.property.name;/^(getElementsByClassName|querySelector|querySelectorAll|\$\$)$/.test(o)&&(t.arguments[0].value="getElementsByClassName"===o?e.at("哈希样式类名",i,t.arguments[0].value):function(t,o){let n=s.parse(t);return(n.nodes||[]).forEach(t=>{"selector"===t.type&&(t.nodes||[]).forEach(t=>{"class"===t.type&&(t.name=e.at("哈希样式类名",o,t.name))})}),s.stringify(n)}(t.arguments[0].value,i),t.arguments[0].raw=`'${t.arguments[0].value}'`,l=!0)}}),l?r.generate(a):t}e.on("编译插件",t.plugin("d65p-transform-component-script-selector",function(e,t){let o=t.script,n=/(\.getElementsByClassName\s*\(|\.querySelector\s*\(|\.querySelectorAll\s*\(|\$\$\s*\()/;o.actions&&n.test(o.actions)&&(o.actions=i(o.actions,t.input.file)),o.methods&&n.test(o.methods)&&(o.methods=i(o.methods,t.input.file))}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("d75p-init-component-[csslib]",function(t,n){let r=e.at("项目配置处理",n.input.file),s=n.result.oCsslib=Object.assign({},r.oCsslib||{});t.walk("RposeBlock",(t,r)=>{if("csslib"!==r.name.value)return;if(!r.text||!r.text.value||!r.text.value.trim())return;let i=e.at("解析[csslib]",r.text.value,n,r.text.loc);for(let t in i){if(s[t])throw new o("duplicate csslib name: "+t,{file:n.input.file,text:n.input.text,line:r.text.loc.start.line,column:1});s[t]=e.at("样式库",t,i[t])}return t.remove(),!1})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("d85p-init-component-[taglib]",function(t,n){let r=e.at("项目配置处理",n.input.file),s=n.result.oTaglib=Object.assign({},r.oTaglib||{});t.walk("RposeBlock",(t,r)=>{if("taglib"!==r.name.value)return;if(!r.text||!r.text.value||!r.text.value.trim())return;let i=e.at("解析[taglib]",r.text.value,n,r.text.loc);for(let e in i)if(s[e])throw new o("duplicate taglib name: "+e,{file:n.input.file,text:n.input.text,line:r.text.loc.start.line+s[e].line,column:1});let a=new Map;for(let e in i)a.set(i[e].pkg,i[e]);a.forEach((t,s)=>{if(!e.at("自动安装",s))throw new o("package install failed: "+s,{file:n.input.file,text:n.input.text,line:r.text.loc.start.line+t.line,column:1})});for(let t in i)try{e.at("标签库定义",i[t].taglib,n.input.file)}catch(e){throw new o.cat(e,{file:n.input.file,text:n.input.text,line:r.text.loc.start.line+i[t].line,column:1})}return t.remove(),!1})}))})(),(()=>{const e=require("@gotoeasy/bus");module.exports=e.on("视图编译选项",function(e={},t){return e.CodeBlockStart="{%",e.CodeBlockEnd="%}",e.ExpressionStart="{",e.ExpressionEnd="}",e.TypeHtmlComment="HtmlComment",e.TypeCodeBlock="JsCode",e.TypeExpression="Expression",e.TypeTagOpen="TagOpen",e.TypeTagClose="TagClose",e.TypeTagSelfClose="TagSelfClose",e.TypeAttributeName="AttributeName",e.TypeAttributeValue="AttributeValue",e.TypeEqual="=",e.TypeText="Text",function(o){return!t&&o&&(t=!0,e.CodeBlockStart=o.CodeBlockStart||e.CodeBlockStart,e.CodeBlockEnd=o.CodeBlockEnd||e.CodeBlockEnd,e.ExpressionStart=o.ExpressionStart||e.ExpressionStart,e.ExpressionEnd=o.ExpressionEnd||e.ExpressionEnd,e.TypeHtmlComment=o.TypeHtmlComment||e.TypeHtmlComment,e.TypeCodeBlock=o.TypeCodeBlock||e.TypeCodeBlock,e.TypeExpression=o.TypeExpression||e.TypeExpression,e.TypeTagOpen=o.TypeTagOpen||e.TypeTagOpen,e.TypeTagClose=o.TypeTagClose||e.TypeTagClose,e.TypeTagSelfClose=o.TypeTagSelfClose||e.TypeTagSelfClose,e.TypeAttributeName=o.TypeAttributeName||e.TypeAttributeName,e.TypeAttributeValue=o.TypeAttributeValue||e.TypeAttributeValue,e.TypeEqual=o.TypeEqual||e.TypeEqual,e.TypeText=o.TypeText||e.TypeText),e}}())})(),(()=>{const e=require("@gotoeasy/bus");e.on("是否表达式",function(){e.at("视图编译选项");return function(e){if(!e)return!1;let t=e.replace(/\\\{/g,"").replace(/\\\}/g,"");return/\{.*\}/.test(t)}}())})(),(()=>{const e=require("@gotoeasy/bus"),t="\0",o="￿";module.exports=e.on("字符阅读器",function(e){return new class{constructor(e){this.ary=e.split(""),this.maxLength=this.ary.length,this.pos=0}skip(e){return e>0&&(this.pos=this.pos+e,this.pos>this.maxLength&&(this.pos=this.maxLength)),this.pos}skipBlank(){let e="";for(;/\s/.test(this.getCurrentChar())&&!this.eof();)e+=this.readChar();return e}getPos(){return this.pos}eof(){return this.pos>=this.maxLength}readChar(){let e=this.getCurrentChar();return this.pos<this.maxLength&&(this.pos+=1),e}getPrevChar(){return 0==this.pos?t:this.ary[this.pos-1]}getCurrentChar(){return this.pos>=this.maxLength?o:this.ary[this.pos]}getNextChar(e=1){let t=e<1?1:e;return this.pos+t>=this.maxLength?o:this.ary[this.pos+t]}getChar(e=0){return e<0?t:e>=this.maxLength?o:this.ary[e]}getPrevString(e){return this.getString(this.pos-e,this.pos)}getString(e,t){let o=e<0?0:e>=this.maxLength?this.maxLength-1:e,n=t<0?0:t>this.maxLength?this.maxLength:t,r="";for(let e=o;e<n;e++)r+=this.ary[e];return r}getNextString(e){return this.getString(this.pos,this.pos+e)}}(e)})})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/file"),require("@gotoeasy/err")),o="br,hr,input,img,meta,link,area,base,col,command,embed,keygen,param,srouce,trace,wbr".split(",");function n(e){return null==e?null:e.replace(/\\{/g,"\0").replace(/\\}/g,"￾￿")}function r(e){return null==e?null:e.replace(/\u0000\u0001/g,"{").replace(/\ufffe\uffff/g,"}")}function s(s,i,a,l){let u=n(i),c=e.at("视图编译选项"),p=e.at("字符阅读器",u),f=[];function g(){let e=p.getPos();if("<"!==p.getCurrentChar()||p.eof()||"\x3c!--"===p.getNextString(4)||"<![CDATA["===p.getNextString(9)||u.indexOf(c.CodeBlockStart,e)==e||u.indexOf(c.ExpressionStart,e)==e)return 0;let n,i,g="";if("</"===p.getNextString(2)){if(u.indexOf(">",e+3)<0)return 0;for((i={}).start=p.getPos(),p.skip(2);">"!==p.getCurrentChar()&&!p.eof();)g+=p.readChar();return p.skip(1),i.end=p.getPos(),n={type:c.TypeTagClose,value:g.trim(),pos:i},f.push(n),1}if("<"===p.getCurrentChar()&&u.indexOf(">",e+2)<0)return 0;if(!/[a-z]/i.test(p.getNextChar()))return 0;for((i={}).start=p.getPos(),p.skip(1);/[^\s\/>]/.test(p.getCurrentChar());)g+=p.readChar();let h={type:"",value:r(g).trim(),pos:i};for(f.push(h);d(););if(p.skipBlank(),"/>"===p.getNextString(2))return h.type=c.TypeTagSelfClose,p.skip(2),i.end=p.getPos(),1;if(">"===p.getCurrentChar())return o.includes(g.toLowerCase())?h.type=c.TypeTagSelfClose:h.type=c.TypeTagOpen,p.skip(1),i.end=p.getPos(),1;throw new t('tag missing ">"',"file="+a,{text:s,start:i.start+l})}function d(){if(p.eof())return 0;p.skipBlank();let e={};e.start=p.getPos();let o="",n="";if("{"===p.getCurrentChar()){let e=[];for(o+=p.readChar();!p.eof();){if("{"===p.getCurrentChar()&&"\\"!==p.getPrevChar()&&e.push("{"),"}"===p.getCurrentChar()&&"\\"!==p.getPrevChar()){if(!e.length){o+=p.readChar();break}e.pop()}o+=p.readChar()}if(!o)return 0}else{for(;/[^\s=\/>]/.test(p.getCurrentChar());)o+=p.readChar();if(!o)return 0}e.end=p.getPos();let i={type:c.TypeAttributeName,value:r(o),pos:e};if(f.push(i),p.skipBlank(),(e={}).start=p.getPos(),"="===p.getCurrentChar()){e.end=p.getPos()+1,i={type:c.TypeEqual,value:"=",pos:e},f.push(i);let o=p.getPos()+l+1;if(p.skip(1),p.skipBlank(),(e={}).start=p.getPos(),'"'===p.getCurrentChar()){p.skip(1);let u=p.getPos();for(;!p.eof()&&'"'!==p.getCurrentChar();){let e=p.readChar();"\r"!==e&&"\n"!==e&&(n+=e)}if(p.eof()||'"'!==p.getCurrentChar())throw new t('invalid attribute value format (missing ")',"file="+a,{text:s,start:o,end:u+l});p.skip(1),e.end=p.getPos(),i={type:c.TypeAttributeValue,value:r(n),pos:e},f.push(i)}else if("'"===p.getCurrentChar()){p.skip(1);let u=p.getPos();for(;!p.eof()&&"'"!==p.getCurrentChar();){let e=p.readChar();"\r"!=e&&"\n"!=e&&(n+=e)}if(p.eof()||"'"!==p.getCurrentChar())throw new t("invalid attribute value format (missing ')","file="+a,{text:s,start:o,end:u+l});p.skip(1),e.end=p.getPos(),i={type:c.TypeAttributeValue,value:r(n),pos:e},f.push(i)}else if("{"===p.getCurrentChar()){let u=[],g=p.getPos()+1;for(;!p.eof();){if("{"===p.getCurrentChar())u.push("{");else if("}"===p.getCurrentChar()){if(!u.length)break;if(1===u.length){n+=p.readChar();break}u.pop()}n+=p.readChar()}if(p.eof())throw new t("invalid attribute value format (missing })","file="+a,{text:s,start:o,end:g+l});e.end=p.getPos(),i={type:c.TypeAttributeValue,value:r(n),pos:e},f.push(i)}else{for(;/[^\s\/>]/.test(p.getCurrentChar());)n+=p.readChar();if(!n)throw new t("missing attribute value","file="+a,{text:s,start:o,end:o+1});if(!/^(\d+|\d+\.?\d+)$/.test(n))throw new t("invalid attribute value","file="+a,{text:s,start:o,end:p.getPos()+l});e.end=p.getPos(),i={type:c.TypeAttributeValue,value:n-0,pos:e},f.push(i)}}return 1}function h(){let e,t=p.getPos(),o=u.indexOf("\x3c!--",t),n=u.indexOf("--\x3e",t+4);if(o===t&&n>t){let s={};return s.start=o,s.end=n+3,e={type:c.TypeHtmlComment,value:r(u.substring(t+4,n)),pos:s},p.skip(n+3-t),f.push(e),1}return 0}function b(){let e,t=p.getPos(),o=u.indexOf("<![CDATA[",t),s=u.indexOf("]]>",t+9);if(o===t&&s>t){let i={};i.start=o,i.end=s+3;let a=n(u.substring(t+9,s));if(p.skip(s+3-t),/\{.*?}/.test(a)){let t,n,s,i,l=o+9;for(;(t=a.indexOf("{"))>=0&&(n=a.indexOf("}",t))>0;)t>0&&(l=(i={start:l,end:l+(s=r(a.substring(0,t))).length}).end,e={type:c.TypeText,value:s,pos:i},f.push(e)),l=(i={start:l,end:l+(s=r(a.substring(t,n+1))).length}).end,e={type:c.TypeExpression,value:s,pos:i},f.push(e),a=a.substring(n+1);a&&(l=(i={start:l,end:l+(s=r(a)).length}).end,e={type:c.TypeText,value:s,pos:i},f.push(e))}else e={type:c.TypeText,value:a,pos:i},f.push(e);return 1}return 0}function y(){let e,t,o=p.getPos();if(0!==o&&"\n"!==p.getPrevChar()||u.indexOf("```",o)!==o||!(u.indexOf("\n```",o+3)>0))return 0;let n,r=u.substring(o),s=/(^```[\s\S]*?\r?\n)([\s\S]*?)\r?\n```[\s\S]*?\r?(\n|$)/.exec(r),i=s[0].length;e=o,t=o+i,n={type:c.TypeTagSelfClose,value:"```",pos:{start:e,end:t}},f.push(n);let a,l=s[1].match(/\b\w*\b/),g=l?l[0].toLowerCase():"";g&&(t=(e=o+l.index)+g.length,n={type:c.TypeAttributeName,value:"lang",pos:{start:e,end:t}},f.push(n),n={type:c.TypeEqual,value:"=",pos:{start:e,end:t}},f.push(n),n={type:c.TypeAttributeValue,value:g,pos:{start:e,end:t}},f.push(n)),(l=s[1].match(/\b\d+(\%|px)/i))?a=l[0]:(l=s[1].match(/\b\d+/i))&&(a=l[0]),a&&(t=(e=o+l.index)+a.length,n={type:c.TypeAttributeName,value:"height",pos:{start:e,end:t}},f.push(n),n={type:c.TypeEqual,value:"=",pos:{start:e,end:t}},f.push(n),a=/^\d+$/.test(a)?a+"px":a,n={type:c.TypeAttributeValue,value:a,pos:{start:e,end:t}},f.push(n));let d=(l=s[1].match(/\bref\s?=\s?"(.*?)"/i))&&l[0]?l[0]:"";d&&(n={type:c.TypeAttributeName,value:"ref",pos:{start:e,end:t}},f.push(n),n={type:c.TypeEqual,value:"=",pos:{start:e,end:t}},f.push(n),n={type:c.TypeAttributeValue,value:d,pos:{start:e,end:t}},f.push(n));let h=s[2].replace(/\u0000\u0001/g,"\\{").replace(/\ufffe\uffff/g,"\\}");return h=h.replace(/\n\\+```/g,e=>"\n"+e.substring(2)),/^\\+```/.test(h)&&(h=h.substring(1)),h=h.replace(/\{/g,"\\{").replace(/\}/g,"\\}"),t=(e=o+s[1].length)+s[2].length,n={type:c.TypeAttributeName,value:"$CODE",pos:{start:e,end:t}},f.push(n),n={type:c.TypeEqual,value:"=",pos:{start:e,end:t}},f.push(n),n={type:c.TypeAttributeValue,value:h,pos:{start:e,end:t}},f.push(n),p.skip(i),1}function m(){let e,t=p.getPos(),o=u.indexOf(c.CodeBlockStart,t),n=u.indexOf(c.CodeBlockEnd,t+c.CodeBlockStart.length);if(o===t&&n>0){let s={};return s.start=o,s.end=n+c.CodeBlockEnd.length,e={type:c.TypeCodeBlock,value:r(u.substring(t+c.CodeBlockStart.length,n)),pos:s},p.skip(n+c.CodeBlockEnd.length-t),f.push(e),1}return 0}function x(){if(p.eof())return 0;let e={};e.start=p.getPos();let t,o,n="";for(;!p.eof()&&(n+=p.readChar(),o=p.getPos(),"<"!==p.getCurrentChar()&&"```"!==p.getNextString(3)&&u.indexOf(c.CodeBlockStart,o)!==o&&u.indexOf(c.ExpressionStart,o)!==o););return n?(e.end=p.getPos(),t={type:c.TypeText,value:r(n),pos:e},f.push(t),1):0}function w(){if(p.eof())return 0;let e,t={};return t.start=p.getPos(),(e=function(){let e=p.getPos(),t=u.indexOf(c.ExpressionStart,e),o=u.indexOf(c.ExpressionEnd,e+c.ExpressionStart.length);if(t===e&&o>0){let t={type:c.TypeExpression,value:r(u.substring(e,o+c.ExpressionEnd.length))};return p.skip(o+c.ExpressionEnd.length-e),t}return null}())?(t.end=p.getPos(),e.pos=t,f.push(e),1):0}this.parse=function(){for(;g()||h()||b()||m()||w()||y()||x(););return f.forEach(e=>{e.loc=function(e,t,o,n){let r,s,i={},a={};return r=e.substring(0,t+n).split("\n"),i.line=r.length,s=r.pop(),i.column=s.length+1,i.pos=n+t,r=e.substring(0,o+n).split("\n"),a.line=r.length,s=r.pop(),a.column=s.length,a.pos=n+o,s.length||(a.line--,a.column=r.pop().length+1),{start:i,end:a}}(s,e.pos.start,e.pos.end,l),delete e.pos}),f}}e.on("视图TOKEN解析器",function(e,t,o,n){return new s(e,t,o,n)})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("e15p-parse-view-tokens-to-ast",function(t,o){t.walk("RposeBlock",(t,n)=>{if(!/^view$/.test(n.name.value))return;let r=n.text?n.text.value:"";if(!r)return t.remove();let s=e.at("视图TOKEN解析器",o.input.text,r,o.input.file,n.text.loc.start.pos),i={type:"View",src:r,loc:n.text.loc,nodes:s.parse()},a=this.createNode(i);t.replaceWith(a)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("f15p-astedit-normalize-group-attribute",function(t,n){const r=e.at("视图编译选项");t.walk(r.TypeAttributeName,(t,s)=>{let i=t.after();if(i&&i.type===r.TypeEqual){let a=i.after();if(!a||!a.type===r.TypeAttributeValue)throw new o("missing attribute value");if(e.at("是否表达式",s.value))throw new o("unsupport expression on attribute name",{file:n.input.file,text:n.input.text,start:s.loc.start.pos,end:s.loc.end.pos});if(/^\s*\{\s*\}\s*$/.test(a.object.value))throw new o("invalid empty expression",{file:n.input.file,text:n.input.text,start:a.object.loc.start.pos,end:a.object.loc.end.pos});let l={type:"Attribute",name:s.value,value:a.object.value,isExpression:e.at("是否表达式",a.object.value),loc:{start:s.loc.start,end:a.object.loc.end}},u=this.createNode(l);t.replaceWith(u),i.remove(),a.remove()}else{let o={type:"Attribute",name:s.value,value:!0,isExpression:!1,loc:s.loc};e.at("是否表达式",s.value)&&(o.isExpression=!0,o.isObjectExpression=!0,delete o.value);let n=this.createNode(o);t.replaceWith(n)}}),t.walk("Attribute",(e,t)=>{if(!e.parent)return;let o=[e],n=e.after();for(;n&&"Attribute"===n.type;)o.push(n),n=n.after();let r=this.createNode({type:"Attributes"});e.before(r),o.forEach(e=>{r.addChild(e.clone()),e.remove()})})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("f25p-astedit-normolize-tag-of-self-close",function(t,o){const n=e.at("视图编译选项");t.walk(n.TypeTagSelfClose,(e,t)=>{let o=t.value,n=t.loc,r=this.createNode({type:"Tag",value:o,loc:n}),s=e.after();s&&"Attributes"===s.type&&(r.addChild(s.clone()),s.remove()),e.replaceWith(r)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("f35p-astedit-normolize-tag-of-open-close",function(t,n){const r=e.at("视图编译选项");let s=(e,t)=>{let i=t.after();for(;i&&i.type!==r.TypeTagClose;){if(i.type===r.TypeTagOpen){let t="Tag",o=i.object.value,n=i.object.loc,r=this.createNode({type:t,value:o,loc:n});s(r,i),e.addChild(r)}else e.addChild(i.clone());i.remove(),i=t.after()}if(!i)throw new o("missing close tag","file="+n.input.file,{text:n.input.text,start:e.object.loc.start.pos});if(i.type===r.TypeTagClose){if(t.object.value!==i.object.value)throw new o(`unmatch close tag: ${t.object.value}/${i.object.value}`,"file="+n.input.file,{text:n.input.text,start:e.object.loc.start.pos,end:i.object.loc.end.pos});return e.object.loc.end=i.object.loc.end,i.remove(),e}throw new Error("todo unhandle type")};t.walk(r.TypeTagOpen,(e,t)=>{if(!e.parent)return;let o=t.value,n=t.loc,r=this.createNode({type:"Tag",value:o,loc:n});s(r,e),e.replaceWith(r)})}))})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/postobject");function t(e){return e.startsWith("[")&&e.indexOf("]")>0}function o(e){return e.startsWith("---------")}function n(e){return e.startsWith("=========")}function r(e){let t,o;for(let n=1;n<e.length;n++)if("\\"!==e.charAt(n-1)&&"]"===e.charAt(n))return{name:t=e.substring(1,n).toLowerCase(),len:o=t.length};return{name:t=e.substring(1,e.lastIndexOf("]")).toLowerCase(),len:o=t.length}}e.on("BTF内容解析",function(e){let s=e.indexOf("\r\n")>=0?"\r\n":"\n",i=[];return function(e,s){let i,a,l,u=!1;for(let c=0;c<s.length;c++)if(t(i=s[c]))a=r(i),l=i.substring(a.len+2),e.push({type:"BlockName",name:a.name,comment:l}),u=!0;else if(o(i))e.push({type:"Comment",value:i}),u=!1;else if(n(i))e.push({type:"Comment",value:i}),u=!1;else if(u){"BlockText"!==e[e.length-1].type&&e.push({type:"BlockText",name:e[e.length-1].name,value:[]});let t=e[e.length-1];t.value.push(i)}else e.push({type:"Comment",value:i})}(i,e.split(s)),i.forEach(e=>{"BlockText"===e.type&&(e.value=e.value.join(s))}),i})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("refractor"),o=require("rehype");function n(e){e.languages.inilike={constant:/^[ \t]*[^\s=:]+?(?=[ \t]*[=:])/m,"attr-value":{pattern:/(=|:).*/,inside:{punctuation:/^(=|:)/}}}}n.displayName="inilike",n.aliases=[],t.register(n),e.on("语法高亮转换",function(n="@rpose/buildin:```",r){return function(o="",a="clike"){if(r||((r={}).token=e.at("哈希样式类名",n,"token"),r.comment=e.at("哈希样式类名",n,"comment"),r.selector=e.at("哈希样式类名",n,"selector")),/^(btf|rpose)$/i.test(a)){return"<ol><li>"+function(o){let n=[];return e.at("BTF内容解析",o).forEach(e=>{if("BlockName"===e.type)n.push(function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/(.*)/g,`<span class="${r.token} ${r.selector}">$1</span>`)}("["+e.name+"]")+s(e.comment));else if("BlockText"===e.type){let o=e.name;t.registered(o)||(o=/^(actions|methods|options|state)$/i.test(o)?"js":/^view$/i.test(o)?"markup":"inilike"),n.push(i(e.value,o))}else{if("Comment"!==e.type)throw new Error("unknow type");n.push(s(e.value))}}),n.join("\n")}(o).split(/\r?\n/).join("</li><li>")+"</li></ol>"}return!t.registered(a)&&(a="clike"),"<ol><li>"+i(o,a).split(/\r?\n/).join("</li><li>")+"</li></ol>"};function s(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/(\S+.*)/g,`<span class="${r.token} ${r.comment}">$1</span>`)}function i(s,i){let a=t.highlight(s,i);return function t(o){o&&o.forEach(o=>{if(o.properties&&o.properties.className){let t=[];o.properties.className.forEach(o=>{!r[o]&&(r[o]=e.at("哈希样式类名",n,o)),t.push(r[o])}),o.properties.className=t}t(o.children)})}(a),o().stringify({type:"root",children:a}).toString()}}())})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",t.plugin("f45p-astedit-transform-tag-```",function(t,o){t.walk("Tag",(t,o)=>{if("```"!==o.value)return;let n,r,s;for(let e,o=0;e=t.nodes[o++];)if("Attributes"===e.type){n=e;break}for(let e,t=0;e=n.nodes[t++];)"$CODE"===e.object.name?(r=e,e.object.value=e.object.value.replace(/\\\{/g,"{").replace(/\\\}/g,"}")):"lang"===e.object.name&&(s=e.object.value);r.object.value=e.at("语法高亮转换",r.object.value,s);let i=this.createNode({type:"Attribute"});i.object.name="@taglib",i.object.value="@rpose/buildin:```";let a=Object.assign({},o.loc);a.end.line=a.start.line,a.end.column=3,a.end.pos=a.start.pos+3,i.object.loc=a,n.addChild(i)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("f55p-astedit-normolize-flag-is-svg-tag",function(e,t){e.walk("Tag",(e,t)=>{/^svg$/i.test(t.value)&&(t.svg=!0,e.walk("Tag",(e,t)=>{t.svg=!0},{readonly:!0}))},{readonly:!0})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=/^(html|link|meta|style|title|address|article|aside|footer|header|h1|h2|h3|h4|h5|h6|hgroup|main|nav|section|blockquote|dd|dir|div|dl|dt|figcaption|figure|hr|li|ol|p|pre|ul|a|abbr|b|bdi|bdo|br|cite|code|data|dfn|em|i|kbd|mark|q|rb|rp|rt|rtc|ruby|s|samp|small|span|strong|sub|sup|time|tt|u|var|wbr|area|audio|img|map|track|video|applet|embed|iframe|noembed|object|param|picture|source|canvas|noscript|script|del|ins|caption|col|colgroup|table|tbody|td|tfoot|th|thead|tr|button|datalist|fieldset|form|input|label|legend|meter|optgroup|option|output|progress|select|textarea|details|dialog|menu|menuitem|summary|content|element|shadow|slot|template|acronym|basefont|bgsound|big|blink|center|command|font|frame|frameset|image|isindex|keygen|listing|marquee|multicol|nextid|nobr|noframes|plaintext|spacer|strike|xmp|head|base|body|math|svg)$/i;e.on("编译插件",t.plugin("f65p-astedit-normolize-flag-is-standard-tag",function(e,t){e.walk("Tag",(e,t)=>{t.standard=!!t.svg||o.test(t.value)},{readonly:!0})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("g15p-astedit-group-attribtue-{prop}",function(e,t){e.walk("Tag",(e,t)=>{if(!e.nodes||!e.nodes.length)return;let o;for(let t,n=0;t=e.nodes[n++];)if("Attributes"===t.type){o=t;break}if(!o||!o.nodes||!o.nodes.length)return;let n=[];if(o.nodes.forEach(e=>{e.object.isObjectExpression&&n.push(e)}),!n.length)return;let r=this.createNode({type:"ObjectExpressionAttributes"});n.forEach(e=>{let t=e.clone();t.type="ObjectExpressionAttribute",t.object.type="ObjectExpressionAttribute",r.addChild(t),e.remove()}),e.addChild(r)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=/^(onclick|onchange|onabort|onafterprint|onbeforeprint|onbeforeunload|onblur|oncanplay|oncanplaythrough|oncontextmenu|oncopy|oncut|ondblclick|ondrag|ondragend|ondragenter|ondragleave|ondragover|ondragstart|ondrop|ondurationchange|onemptied|onended|onerror|onfocus|onfocusin|onfocusout|onformchange|onforminput|onhashchange|oninput|oninvalid|onkeydown|onkeypress|onkeyup|onload|onloadeddata|onloadedmetadata|onloadstart|onmousedown|onmouseenter|onmouseleave|onmousemove|onmouseout|onmouseover|onmouseup|onmousewheel|onoffline|ononline|onpagehide|onpageshow|onpaste|onpause|onplay|onplaying|onprogress|onratechange|onreadystatechange|onreset|onresize|onscroll|onsearch|onseeked|onseeking|onselect|onshow|onstalled|onsubmit|onsuspend|ontimeupdate|ontoggle|onunload|onunload|onvolumechange|onwaiting|onwheel)$/i;e.on("编译插件",t.plugin("g25p-astedit-group-attribtue-events",function(e,t){e.walk("Tag",(e,t)=>{if(!e.object.standard)return;if(!e.nodes||!e.nodes.length)return;let n;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){n=t;break}if(!n||!n.nodes||!n.nodes.length)return;let r=[];if(n.nodes.forEach(e=>{o.test(e.object.name)&&r.push(e)}),!r.length)return;let s=this.createNode({type:"Events"});r.forEach(e=>{let t=e.clone();t.type="Event",t.object.type="Event",s.addChild(t),e.remove()}),e.addChild(s)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("g35p-astedit-process-attribtue-style",function(e,t){e.walk("Tag",(e,n)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let s=[];if(r.nodes.forEach(e=>{/^style$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of style",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});let i=s[0].clone();i.type="Style",i.object.type="Style",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("g45p-astedit-process-attribtue-class",function(e,t){e.walk("Tag",(e,n)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let s=[];if(r.nodes.forEach(e=>{/^class$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of class",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});let i=s[0].clone();i.type="Class",i.object.type="Class",i.object.classes=function(e){let t=[],o=(e=e.replace(/\{.*?\}/g,function(e){let o,n,r,s=e.substring(1,e.length-1);for(;s.indexOf(":")>0;){o=s.indexOf(":"),n=s.substring(0,o).replace(/['"]/g,"").trim();let e=(r=s.substring(o+1)).indexOf(":");e>0?(r=(r=r.substring(0,e)).substring(0,r.lastIndexOf(",")),s=s.substring(o+1+r.length+1)):s="",n&&t.push(n)}return""})).split(/\s+/);for(let e=0;e<o.length;e++)o[e].trim()&&t.push(o[e].trim());return t}(i.object.value),e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h15p-astedit-process-attribtue-@ref",function(e,t){e.walk("Tag",(e,n)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let s=[];if(r.nodes.forEach(e=>{/^@ref$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of @ref",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});if(/^(if|for)$/.test(n.value))throw new o(`unsupport attribute @ref on tag <${n.value}>`,{file:t.input.file,text:t.input.text,start:s[0].object.loc.start.pos,end:s[0].object.loc.end.pos});let i=s[0].clone();i.type="@ref",i.object.type="@ref",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h25p-astedit-process-attribtue-@if",function(e,t){e.walk("Tag",(e,n)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let s=[];if(r.nodes.forEach(e=>{/^@if$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of @if",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});let i=s[0].clone();i.type="@if",i.object.type="@if",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h35p-astedit-process-attribtue-@show",function(e,t){e.walk("Tag",(e,n)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let s=[];if(r.nodes.forEach(e=>{/^@show$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of @show",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});if(/^(if|for)$/.test(n.value))throw new o(`unsupport attribute @show on tag <${n.value}>`,{file:t.input.file,text:t.input.text,start:s[0].object.loc.start.pos,end:s[0].object.loc.end.pos});let i=s[0].clone();i.type="@show",i.object.type="@show",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h45p-astedit-process-attribtue-@for",function(e,t){e.walk("Tag",(e,n)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let s=[];if(r.nodes.forEach(e=>{/^@for$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of @for",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});let i=s[0].clone();i.type="@for",i.object.type="@for",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h55p-astedit-process-attribtue-@csslib",function(e,t){e.walk("Tag",(e,n)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let s=[];if(r.nodes.forEach(e=>{/^@csslib$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of @csslib",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});if(/^(if|for)$/.test(n.value))throw new o(`unsupport attribute @csslib on tag <${n.value}>`,{file:t.input.file,text:t.input.text,start:s[0].object.loc.start.pos,end:s[0].object.loc.end.pos});let i=s[0].clone();i.type="@csslib",i.object.type="@csslib",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("h65p-astedit-process-attribtue-@taglib",function(e,t){e.walk("Tag",(e,n)=>{if(!e.nodes||!e.nodes.length)return;let r;for(let t,o=0;t=e.nodes[o++];)if("Attributes"===t.type){r=t;break}if(!r||!r.nodes||!r.nodes.length)return;let s=[];if(r.nodes.forEach(e=>{/^@taglib$/i.test(e.object.name)&&s.push(e)}),!s.length)return;if(s.legnth>1)throw new o("duplicate attribute of @taglib",{file:t.input.file,text:t.input.text,start:s[1].object.loc.start.pos,end:s[1].object.loc.end.pos});if(/^(if|for)$/.test(n.value))throw new o(`unsupport @taglib on tag <${n.value}>`,{file:t.input.file,text:t.input.text,start:s[0].object.loc.start.pos,end:s[0].object.loc.end.pos});let i=s[0].clone();i.type="@taglib",i.object.type="@taglib",e.addChild(i),s[0].remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/hash"),o=require("@gotoeasy/file"),n=require("@gotoeasy/err"),r=require("@gotoeasy/postobject"),s=require("fs");e.on("编译插件",r.plugin("j15p-astedit-process-tag-img",function(r,i){r.walk("Tag",(r,a)=>{if(!/^img$/i.test(a.value))return;let l,u;i.result.hasImg=!0;for(let e,t=0;e=r.nodes[t++];)if("Attributes"===e.type){l=e;break}if(!l||!l.nodes||!l.nodes.length)return;for(let e,t=0;e=l.nodes[t++];)if(/^src$/i.test(e.object.name)){u=e;break}if(!u)return;let c=function(n,r){let i;if(o.exists(r))i=r;else if(i=o.resolve(n,r),!o.exists(i))return!1;let a=t({file:i})+o.extname(i),l=e.at("缓存").path+"/resources",u=l+"/"+a;return o.exists(u)||(!o.existsDir(l)&&o.mkdir(l),s.createReadStream(i).pipe(s.createWriteStream(u))),a}(i.input.file,u.object.value);if(!c)throw new n("image file not found",{file:i.input.file,text:i.input.text,start:u.object.loc.start.pos,end:u.object.loc.end.pos});u.object.value="%imagepath%"+c},{readonly:!0})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("k15p-astedit-transform-attribtue-@ref",function(t,n){t.walk("@ref",(t,r)=>{let s,i=t.parent;if(e.at("是否表达式",r.value))throw new o("@ref unsupport the expression",{file:n.input.file,text:n.input.text,start:r.loc.start.pos,end:r.loc.end.pos});for(let e,t=0;e=i.nodes[t++];)if("Attributes"===e.type){s=e;break}let a=t.clone();a.type="Attribute",a.object.type="Attribute",a.object.name="ref";let l=t.clone();l.type="Attribute",l.object.type="Attribute",l.object.name="$context",l.object.value="{$this}",l.object.isExpression=!0,s||(s=this.createNode({type:"Attributes"}),i.addChild(s)),s.addChild(a),s.addChild(l),t.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",t.plugin("k25p-astedit-transform-attribtue-@if",function(t,o){const n=e.at("视图编译选项");t.walk("@if",(e,t)=>{let o=e.parent;/^if$/i.test(o.object.value)&&(o.ok=!0);let r=n.TypeCodeBlock,s="if ("+t.value.replace(/^\s*\{=?/,"").replace(/\}\s*$/,"")+") {",i=this.createNode({type:r,value:s});o.before(i),s="}",i=this.createNode({type:r,value:s}),o.after(i),e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",t.plugin("k35p-astedit-transform-attribtue-@show",function(t,o){const n=e.at("视图编译选项");t.walk("@show",(e,t)=>{let o,r=e.parent;for(let e,t=0;e=r.nodes[t++];)if("Style"===e.type){o=e;break}let s=n.ExpressionStart+"("+t.value.replace(/^\{/,"").replace(/\}$/,"")+') ? "display:block;" : "display:none;"'+n.ExpressionEnd;o?o.object.value.endsWith(";")?o.object.value+=s:o.object.value+=";"+s:(o=this.createNode({type:"Style",value:s}),r.addChild(o)),o.object.isExpression=!0,e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");function n(e,t,n="invalid format of @for"){return new o(n,{file:e.input.file,text:e.input.text,start:t.loc.start.pos,end:t.loc.end.pos})}e.on("编译插件",t.plugin("k45p-astedit-transform-attribtue-@for",function(t,o){const r=e.at("视图编译选项");t.walk("@for",(e,t)=>{let s=e.parent;/^for$/i.test(s.object.value)&&(s.ok=!0);let i=r.TypeCodeBlock,a=function(e,t){if(!t.value)throw n(e,t);let o,r,s,i,a,l;if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s+from\s+(\w+)\s+max\s+(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r=l[2],s=l[3],i=l[4],a=l[5],/^\d+/.test(o))throw n(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(r))throw n(e,t,`invalid index name: [${r}]`);if(/^\d+/.test(a))throw n(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=${s},ARY_=(${a}),MAX_=Math.min(${i},ARY_.length),${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=${s},MAX_=Math.min(${i},${a}.length),${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s+max\s+(\w+)\s+from\s+(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r=l[2],s=l[4],i=l[3],a=l[5],/^\d+/.test(o))throw n(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(r))throw n(e,t,`invalid index name: [${r}]`);if(/^\d+/.test(a))throw n(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=${s},ARY_=(${a}),MAX_=Math.min(${i},ARY_.length),${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=${s},MAX_=Math.min(${i},${a}.length),${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s+from\s+(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r=l[2],s=l[3],a=l[4],/^\d+/.test(o))throw n(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(r))throw n(e,t,`invalid index name: [${r}]`);if(/^\d+/.test(a))throw n(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=${s},ARY_=(${a}),MAX_=ARY_.length,${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=${s},MAX_=${a}.length,${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s+max\s+(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r=l[2],i=l[3],a=l[4],/^\d+/.test(o))throw n(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(r))throw n(e,t,`invalid index name: [${r}]`);if(/^\d+/.test(a))throw n(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=0,ARY_=(${a}),MAX_=Math.min(${i},ARY_.length),${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=0,MAX_=Math.min(${i},${a}.length),${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*,\s*(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r=l[2],a=l[3],/^\d+/.test(o))throw n(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(r))throw n(e,t,`invalid index name: [${r}]`);if(/^\d+/.test(a))throw n(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=0,ARY_=(${a}),MAX_=ARY_.length,${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=0,MAX_=${a}.length,${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}if(l=t.value.match(/^\s*\{*\s*\(\s*(\w+)\s*\)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r="J_",a=l[2],/^\d+/.test(o))throw n(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(r))throw n(e,t,`invalid index name: [${r}]`);if(/^\d+/.test(a))throw n(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=0,ARY_=(${a}),MAX_=ARY_.length,${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=0,MAX_=${a}.length,${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}if(l=t.value.match(/^\s*\{*\s*(\w+)\s+in\s+(\S+?)\s*\}*\s*$/)){if(o=l[1],r="J_",a=l[2],/^\d+/.test(o))throw n(e,t,`invalid value name: [${o}]`);if(/^\d+/.test(a))throw n(e,t,`invalid array name: [${a}]`);return/[^a-zA-Z\d_]/.test(a)?` for ( let ${r}=0,ARY_=(${a}),MAX_=ARY_.length,${o}; ${r}<MAX_; ${r}++) {\n                        ${o} = ARY_[${r}]; `:` for ( let ${r}=0,MAX_=${a}.length,${o}; ${r}<MAX_; ${r}++) {\n                    ${o} = ${a}[${r}]; `}throw n(e,t)}(o,t),l=t.loc,u=this.createNode({type:i,value:a,loc:l});s.before(u),a="}",u=this.createNode({type:i,value:a,loc:l}),s.after(u),e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("k55p-astedit-transform-tag-name-by-@taglib",function(t,n){t.walk("@taglib",(t,r)=>{let s=t.parent;if(s.object.standard)throw new o("unsupport @taglib on standard tag",{file:n.input.file,text:n.input.text,start:r.loc.start.pos,end:r.loc.end.pos});let i=e.at("标签项目源文件",s.object.value);if(i)throw new o(`unsupport @taglib on existed component: ${s.object.value}(${i})`,{file:n.input.file,text:n.input.text,start:r.loc.start.pos,end:r.loc.end.pos});let a,l,u,c=r.value;if(u=c.match(/^\s*.+?\s*=\s*(.+?)\s*:\s*(.+?)\s*$/))a=u[1],l=u[2];else if(u=c.match(/^\s*.+?\s*=\s*(.+?)\s*$/))a=u[1],l=s.object.value;else{if(c.indexOf("=")>=0)throw new o("invalid attribute value of @taglib",{file:n.input.file,text:n.input.text,start:r.loc.start.pos,end:r.loc.end.pos});if(u=c.match(/^\s*(.+?)\s*:\s*(.+?)\s*$/))a=u[1],l=u[2];else{if(!(u=c.match(/^\s*(.+?)\s*$/)))throw new o("invalid attribute value of @taglib",{file:n.input.file,text:n.input.text,start:r.loc.start.pos,end:r.loc.end.pos});a=u[1],l=s.object.value}}if(!e.at("自动安装",a))throw new o("package install failed: "+a,{file:n.input.file,text:n.input.text,start:r.loc.start.pos,end:r.loc.end.pos});let p=e.at("模块组件信息",a),f=e.at("标签库引用",`${a}:${l}`,p.config);if(!f)throw new o("component not found: "+r.value,{file:n.input.file,text:n.input.text,start:r.loc.start.pos,end:r.loc.end.pos});let g=e.at("标签全名",f);s.object.value=g,t.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("k65p-astedit-transform-tag-name-by-[taglib]",function(t,n){let r=Object.assign({},n.result.oTaglib);t.walk("Tag",(t,s)=>{if(s.standard)return;let i=r[s.value];if(!i)return;let a,l,u=i.split(":");if(u.length>1?(a=u[0].trim(),l=u[1].trim()):(a=i.trim(),l=s.value),!e.at("自动安装",a))throw new o("package install failed: "+a,{file:n.input.file,text:n.input.text,start:s.loc.start.pos,end:s.loc.end.pos});let c=e.at("模块组件信息",a),p=e.at("标签库引用",`${a}:${l}`,c.config);if(!p)throw new o("component not found: "+s.value,{file:n.input.file,text:n.input.text,start:s.loc.start.pos,end:s.loc.end.pos});let f=e.at("标签全名",p);s.value=f})},{readonly:!0}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("k75p-astedit-transform-tag-if-for",function(e,t){e.walk("Tag",(e,n)=>{if(/^(if|for)$/i.test(n.value)){if(!e.ok)throw new o(`missing attribute @${n.value} of tag <${n.value}>`,{file:t.input.file,text:t.input.text,start:n.loc.start.pos});e.nodes.forEach(t=>{"Attributes"!==t.type&&e.before(t.clone())}),e.remove()}})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err"),n=require("@gotoeasy/hash");e.on("编译插件",t.plugin("k85p-astedit-transform-tag-slot",function(t,r){let s=[],i=e.at("视图编译选项");t.walk("Tag",(t,n)=>{if(!/^slot$/i.test(n.value))return;let i,a=r.result.slots=r.result.slots||[];if(t.nodes)for(let e,o=0;e=t.nodes[o++];)if("Attributes"===e.type){i=e;break}if(!i||!i.nodes||!i.nodes.length){if(a.length)throw new o("missing attribute 'name' of tag <slot>",{file:r.input.file,text:r.input.text,start:n.loc.start.pos,end:n.loc.end.pos});return a.push(""),s.push(t),void(t.slotName="")}let l=[];if(i.nodes&&i.nodes.forEach(e=>{/^name$/i.test(e.object.name)&&l.push(e)}),0===l.length){if(a.length)throw new o("missing attribute 'name' of tag <slot>",{file:r.input.file,text:r.input.text,start:n.loc.start.pos,end:n.loc.end.pos});return a.push(""),s.push(t),void(t.slotName="")}if(l.length>1)throw new o("duplicate attribute of name",{file:r.input.file,text:r.input.text,start:l[1].object.loc.start.pos,end:l[1].object.loc.end.pos});if(e.at("是否表达式",l[0].object.value))throw new o("slot name unsupport the expression",{file:r.input.file,text:r.input.text,start:l[0].object.loc.start.pos,end:l[0].object.loc.end.pos});let u=l[0].object.value+"";if(a.includes(u))throw new o("duplicate slot name: "+u,{file:r.input.file,text:r.input.text,start:l[0].object.loc.start.pos,end:l[0].object.loc.end.pos});a.push(u),!u&&s.push(t),t.slotName=u});let a=r.result.slots=r.result.slots||[];if(a.length>1&&s.length)throw new o("missing slot name on tag <slot>",{file:r.input.file,text:r.input.text,start:s[0].object.loc.start.pos,end:s[0].object.loc.end.pos});if(r.result.slots){let e=r.doc.api.statekeys=r.doc.api.statekeys||[];!e.includes("$SLOT")&&e.push("$SLOT")}if(a.length){t.walk("Tag",(e,t)=>{if(!/^slot$/i.test(t.value))return;let o=i.TypeCodeBlock,r=`_Ary.push( ...slotVnodes_${n(e.slotName)} );`;e.object.loc,e.replaceWith(this.createNode({type:o,value:r}))});let e=[],o=1===a.length&&""===a[0],r=[];o&&r.push(" _hasDefinedSlotTemplate "),a.forEach(e=>{r.push(` slotVnodes_${n(e)} = [] `)}),e.push("let "+r.join(",")+";"),e.push(" ($state.$SLOT || []).forEach(vn => { "),e.push("     if (vn.a) { "),o&&e.push("     vn.a.slot !== undefined && (_hasDefinedSlotTemplate = 1); "),a.forEach(t=>{e.push(`     vn.a.slot === '${t}' && (slotVnodes_${n(t)} = vn.c || []); `)}),e.push("     } "),e.push(" }); "),o&&e.push(` !_hasDefinedSlotTemplate && !slotVnodes_${n("")}.length && (slotVnodes_${n("")} = $state.$SLOT || []); `),t.walk("View",(t,o)=>{let n=i.TypeCodeBlock,r=e.join("\n");return t.addChild(this.createNode({type:n,value:r}),0),!1})}}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("m15p-csslibify-check-@csslib",function(t,n){let r=n.result.oCsslib,s=new Set;t.walk("@csslib",(t,i)=>{if(e.at("是否表达式",i.value))throw new o("@csslib unsupport the expression",{file:n.input.file,text:n.input.text,start:i.loc.start.pos,end:i.loc.end.pos});let a=i.value.split("="),l=a.length>1?a[0].trim():"*";if(!l)throw new o("use * as empty csslib name. etc. * = "+a[1],{file:n.input.file,text:n.input.text,start:i.loc.start.pos,end:i.loc.end.pos});if(r[l])throw new o("duplicate csslib name: "+l,{file:n.input.file,text:n.input.text,start:i.loc.start.pos,end:i.loc.end.pos});if(s.has(l))throw new o("duplicate csslib name: "+l,{file:n.input.file,text:n.input.text,start:i.loc.start.pos,end:i.loc.end.pos});s.add(l)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("m17p-csslibify-gen-css-@csslib",function(t,n){let r,s,i,a,l=n.style,u=l.csslibset=l.csslibset||new Set,c=Object.assign({},n.result.oCsslib),p=e.on("哈希样式类名")[0],f={rename:(e,t)=>p(n.input.file,"*"!==e?t+"@"+e:t)};t.walk("Class",(t,l)=>{let p;for(let e,o=0;e=t.parent.nodes[o++];)if("@csslib"===e.type){p=e;break}if(p){let t=l.value.split("="),o=t.length>1?t[0].trim():"*",n=e.at("样式库",o,p.object.value);c[o]=n}let g=c["*"];l.classes.forEach(e=>{if(r=e.split("@"),s="."+e,r.length<2)return g&&u.add(g.get(s,f));if(!(i=c[r[1]]))throw new o("csslib not found: "+r[1],{file:n.input.file,text:n.input.text,start:l.loc.start.pos,end:l.loc.end.pos});if(s="."+r[0],!(a=i.get(s,f)))throw new o("css class not found: "+e,{file:n.input.file,text:n.input.text,start:l.loc.start.pos,end:l.loc.end.pos});u.add(a)})})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("n15p-astedit-remove-blank-text",function(t,o){const n=e.at("视图编译选项");t.walk(n.TypeText,(e,t)=>{if(!/^\s*$/.test(t.value)||"pre"===e.parent.object.name)return;let o=e.before(),r=e.after();o&&r&&"Tag"!==o.type&&"Tag"!==r.type&&o.type!==n.TypeHtmlComment&&r.type!==n.TypeHtmlComment&&o.type!==n.TypeCodeBlock&&r.type!==n.TypeCodeBlock||e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("n25p-astedit-remove-html-comment",function(t,o){const n=e.at("视图编译选项");t.walk(n.TypeHtmlComment,(e,t)=>{e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("n35p-astedit-join-text-node",function(t,o){const n=e.at("视图编译选项");var r;t.walk(/^(Text|Expression)$/,(e,t)=>{let o=[e],s=e.after();for(;s&&(s.type===n.TypeText||s.type===n.TypeExpression);)o.push(s),s=s.after();if(o.length<2)return;let i=[];o.forEach(e=>{e.type===n.TypeText?i.push('"'+function(e,t='"'){if(null==e)return e;let o=e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n");return'"'==t?o=o.replace(/"/g,'\\"'):"'"==t&&(o=o.replace(/'/g,"\\'")),o}(e.object.value)+'"'):((r=(r=e.object.value).trim()).startsWith("{")&&r.endsWith("}")&&(r=r.substring(1,r.length-1).trim()),!r||/^\/\/.*$/.test(r)&&r.indexOf("\n")<0||r.startsWith("/*")&&r.endsWith("*/")&&r.indexOf("*/")===r.length-2||i.push(e.object.value.replace(/^\s*\{/,"(").replace(/\}\s*$/,")")))});let a=n.ExpressionStart+i.join(" + ")+n.ExpressionEnd,l={start:o[0].object.loc.start,end:o[o.length-1].object.loc.end},u=this.createNode({type:n.TypeExpression,value:a,loc:l});e.before(u),o.forEach(e=>e.remove())})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("n45p-astedit-remove-jscode-blank-comment",function(t,o){const n=e.at("视图编译选项");var r;t.walk(n.TypeCodeBlock,(e,t)=>{(!(r=(r=t.value).trim())||/^\/\/.*$/.test(r)&&r.indexOf("\n")<0||r.startsWith("/*")&&r.endsWith("*/")&&r.indexOf("*/")===r.length-2)&&e.remove()})}))})(),(()=>{const e=require("@gotoeasy/bus");e.on("编译模板JS",function(e){return function(){if(!e){let t=new class{constructor(e="",t){let o=function(e,t,r){let s,i=t.indexOf("<%");i<0?e.push(n(e,t,r)):0==i?t.indexOf("<%=")==i?(i=(t=t.substring(3)).indexOf("%>"),s=t.substring(0,i),e.push(e.pop()+"+"+s),o(e,t.substring(i+2),!1)):(i=(t=t.substring(2)).indexOf("%>"),s=t.substring(0,i),r?e.push(s):e.push(e.pop()+";")&&e.push(s),o(e,t.substring(i+2),!0)):(s=t.substring(0,i),e.push(n(e,s,r)),o(e,t.substring(i),!1))},n=function(e,t,o){let n=t.replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\'/g,"\\'");return o?"s+='"+n+"'":e.pop()+"+'"+n+"'"},r=[];r.push("let s=''"),o(r,e,!0),r.push("return s"),this.toString=t?new Function(t,r.join("\n")):new Function(r.join("\n"))}}("\n\n// ------------------------------------------------------------------------------------------------------\n// 组件 <%= $data['COMPONENT_NAME'] %>\n// 注:应通过rpose.newComponentProxy方法创建组件代理对象后使用，而不是直接调用方法或用new创建\n// ------------------------------------------------------------------------------------------------------\n<% if ( $data['singleton'] ){ %>\n    // 这是个单例组件\n    <%= $data['COMPONENT_NAME'] %>.Singleton = true;\n<% } %>\n\n// 属性接口定义\n<%= $data['COMPONENT_NAME'] %>.prototype.$OPTION_KEYS = <%= JSON.stringify($data['optionkeys']) %>;  // 可通过标签配置的属性，未定义则不支持外部配置\n<%= $data['COMPONENT_NAME'] %>.prototype.$STATE_KEYS = <%= JSON.stringify($data['statekeys']) %>;    // 可更新的state属性，未定义则不支持外部更新state\n\n// 组件函数\nfunction <%= $data['COMPONENT_NAME'] %>(options={}) {\n\n    <% if ( $data['optionkeys'] != null ){ %>\n    // 组件默认选项值\n    this.$options = <%= $data['options'] %>;\n    rpose.extend(this.$options, options, this.$OPTION_KEYS);    // 按属性接口克隆配置选项\n    <% }else{ %>\n    // 组件默认选项值\n    this.$options = <%= $data['options'] %>;\n    <% } %>\n\n    <% if ( $data['statekeys'] != null ){ %>\n    // 组件默认数据状态值\n    this.$state = <%= $data['state'] %>;\n    rpose.extend(this.$state, options, this.$STATE_KEYS);       // 按属性接口克隆数据状态\n    <% }else{ %>\n    // 组件默认数据状态值\n    this.$state = <%= $data['state'] %>;\n    <% } %>\n\n    <% if ( $data['actions'] ){ %>\n    // 事件处理器\n    <%= $data['actions'] %>\n    <% } %>\n\n    <% if ( $data['methods'] ){ %>\n    // 自定义方法\n    <%= $data['methods'] %>;\n    <% } %>\n\n    <% if ( $data['updater'] ){ %>\n    // 组件更新函数\n    this.$updater = <%= $data['updater'] %>;\n    <% } %>\n}\n\n/**\n * 节点模板函数\n */\n<%= $data['COMPONENT_NAME'] %>.prototype.nodeTemplate = <%= $data['vnodeTemplate'] %>\n\n".replace(/\\/g,"\\\\"),"$data");e=t.toString}return e}}())})(),require("@gotoeasy/bus").on("表达式代码转换",function(e){let t=e.trim();return t.startsWith("{")&&t.endsWith("}")&&(t=t.substring(1,t.length-1)),`(${t})`}),(()=>{const e=require("@gotoeasy/bus");e.on("astgen-node-text",function(t,o){const n=e.at("视图编译选项");return t.type===n.TypeText?function(e,t){let o=[],n='"'+function(e,t='"'){if(null==e)return e;let o=e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n");return'"'==t?o=o.replace(/"/g,'\\"'):"'"==t&&(o=o.replace(/'/g,"\\'")),o}(e.object.value)+'"';return o.push("{ "),o.push(`  s: ${n} `),o.push(` ,k: ${t.keyCounter++} `),o.push("}"),o.join("\n")}(t,o):t.type===n.TypeExpression?function(e,t){let o=[],n=e.object.value.replace(/^\s*\{/,"(").replace(/\}\s*$/,")");return o.push("{ "),o.push(`  s: ${n} `),o.push(` ,k: ${t.keyCounter++} `),o.push("}"),o.join("\n")}(t,o):""})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/err");e.on("编译插件",t.plugin("p15p-reference-components",function(t,n){let r=n.result,s=new Set;t.walk("Tag",(t,r)=>{if(!r.standard&&(s.add(r.value),!e.at("标签源文件",r.value)))throw new o("file not found of tag: "+r.value,{file:n.input.file,text:n.input.text,start:r.loc.start.pos})},{readonly:!0}),r.references=[...s]}))})(),(()=>{const e=require("@gotoeasy/bus"),t=/^(onclick|onchange|onabort|onafterprint|onbeforeprint|onbeforeunload|onblur|oncanplay|oncanplaythrough|oncontextmenu|oncopy|oncut|ondblclick|ondrag|ondragend|ondragenter|ondragleave|ondragover|ondragstart|ondrop|ondurationchange|onemptied|onended|onerror|onfocus|onfocusin|onfocusout|onformchange|onforminput|onhashchange|oninput|oninvalid|onkeydown|onkeypress|onkeyup|onload|onloadeddata|onloadedmetadata|onloadstart|onmousedown|onmouseenter|onmouseleave|onmousemove|onmouseout|onmouseover|onmouseup|onmousewheel|onoffline|ononline|onpagehide|onpageshow|onpaste|onpause|onplay|onplaying|onprogress|onratechange|onreadystatechange|onreset|onresize|onscroll|onsearch|onseeked|onseeking|onselect|onshow|onstalled|onsubmit|onsuspend|ontimeupdate|ontoggle|onunload|onunload|onvolumechange|onwaiting|onwheel)$/i;function o(e,t='"'){if(null==e)return e;let o=e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n");return'"'==t?o=o.replace(/"/g,'\\"'):"'"==t&&(o=o.replace(/'/g,"\\'")),o}e.on("astgen-node-attributes",function(n,r){if(!n.nodes)return"";let s;for(let e,t=0;e=n.nodes[t++];)if("Attributes"===e.type){s=e;break}if(!s||!s.nodes||!s.nodes.length)return"";let i,a,l="",u=[];return u.push("{ "),s.nodes.forEach(s=>{if(i='"'+o(s.object.name)+'"',s.object.isExpression)a=e.at("表达式代码转换",s.object.value);else if("string"==typeof s.object.value)if(!n.object.standard&&t.test(s.object.name)&&!s.object.isExpression&&r.script.$actionkeys){let e=s.object.value.trim(),t=e.startsWith("$actions.")?e.substring(9):e;a=r.script.$actionkeys.includes(t)?`$actions['${t}']`:'"'+o(s.object.value)+'"'}else a='"'+o(s.object.value)+'"';else a=s.object.value;u.push(` ${l} ${i}: ${a} `),!l&&(l=",")}),u.push(" } "),u.join("\n")})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/err");e.on("astgen-node-events",function(o,n){if(!o.nodes)return"";let r;for(let e,t=0;e=o.nodes[t++];)if("Events"===e.type){r=e;break}if(!r||!r.nodes||!r.nodes.length)return"";let s,i,a="",l=[];return l.push("{ "),r.nodes.forEach(o=>{if(s=o.object.name.substring(2),i=o.object.value,o.object.isExpression)i=e.at("表达式代码转换",i);else{let e=(i=i.trim()).startsWith("$actions.")?i.substring(9):i;if(!n.script.$actionkeys||!n.script.$actionkeys.includes(e))throw new t("action not found: "+e,{file:n.input.file,text:n.input.text,start:o.object.loc.start.pos,end:o.object.loc.end.pos});i="$actions."+i}l.push(` ${a} ${s}: ${i} `),!a&&(a=",")}),l.push(" } "),l.join("\n")})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/err");function t(e,t='"'){if(null==e)return e;let o=e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n");return'"'==t?o=o.replace(/"/g,'\\"'):"'"==t&&(o=o.replace(/'/g,"\\'")),o}e.on("astgen-node-style",function(e,o){if(!e.nodes)return"";let n;for(let t,o=0;t=e.nodes[o++];)if("Style"===t.type){n=t;break}if(!n||!n.object.value)return"";if(!n.object.isExpression)return'"'+t(n.object.value)+'"';let r=[];return function e(o,n){if(/^\{\s*\{[\s\S]*?\}\s*\}$/.test(n))return void o.push(n.replace(/^\{/,"").replace(/\}$/,""));let r=n.indexOf("{");if(r<0)return void o.push('"'+t(n)+'"');let s=n.indexOf("}",r);if(s<0)return void o.push('"'+t(n)+'"');r>0&&o.push('"'+t(n.substring(0,r))+'"'),o.push("("+n.substring(r+1,s)+")");let i=n.substring(s+1);i&&e(o,i)}(r,n.object.value),"("+r.join(" + ")+")"})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/err");e.on("astgen-node-class",function(t,o){if(!t.nodes)return"";let n;for(let e,o=0;e=t.nodes[o++];)if("Class"===e.type){n=e;break}return n&&n.object.value?function(t,o){let n={},r=(t=t.replace(/\{.*?\}/g,function(t){let r,s,i,a=t.substring(1,t.length-1);for(;a.indexOf(":")>0;){r=a.indexOf(":"),s=a.substring(0,r).replace(/['"]/g,"");let t=(i=a.substring(r+1)).indexOf(":");t>0?(i=(i=i.substring(0,t)).substring(0,i.lastIndexOf(",")),a=a.substring(r+1+i.length+1)):a="",n[e.at("哈希样式类名",o,s.trim())]="@("+i+")@"}return""})).split(/\s/);for(let t=0;t<r.length;t++)r[t].trim()&&(n[e.at("哈希样式类名",o,r[t].trim())]=1);return JSON.stringify(n).replace(/('@|@'|"@|@")/g,"")}(n.object.value,o.input.file):""})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/err");e.on("astgen-node-{prop}",function(e,t){if(!e.nodes)return"";let o;for(let t,n=0;t=e.nodes[n++];)if("ObjectExpressionAttributes"===t.type){o=t;break}if(!o||!o.nodes||!o.nodes.length)return"";let n,r=[];return o.nodes.forEach(e=>{n=e.object.name.replace(/^\s*\{=?/,"(").replace(/\}\s*$/,")"),r.push(n)}),r.join(",")})})(),(()=>{const e=require("@gotoeasy/bus");require("@gotoeasy/hash");function t(t,o){if("Tag"!==t.type)return"";let n=t.object,r="View"===t.parent.type,s=!t.object.standard,i=e.at("astgen-node-tag-nodes",t.nodes,o),a=e.at("astgen-node-attributes",t,o),l=e.at("astgen-node-events",t,o),u=t.object.svg,c=e.at("astgen-node-style",t,o);c&&(a=a?a.replace(/\}\s*$/,`,style: ${c}}`):`{style: ${c}}`);let p=e.at("astgen-node-class",t,o);p&&(a=a?a.replace(/\}\s*$/,`,class: ${p}}`):`{class: ${p}}`);let f=e.at("astgen-node-{prop}",t,o);f&&(a=`rpose.assign( ${a}, ${f})`);let g=[];return g.push("{ "),g.push(`  t: '${n.value}' `),r&&g.push(" ,r: 1 "),s&&g.push(" ,m: 1 "),u&&g.push(" ,g: 1 "),g.push(` ,k: ${o.keyCounter++} `),i&&g.push(` ,c: ${i} `),a&&g.push(` ,a: ${a} `),l&&g.push(` ,e: ${l} `),g.push("}"),g.join("\n")}e.on("astgen-node-tag",t)})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/err"),o="_Ary";function n(n=[],r){return n.length?function(e){for(let t,o=0;t=e[o++];)if("JsCode"===t.type)return!0;return!1}(n)?function(n=[],r){let s,i=[];i.push(` ((${o}) => { `);for(let a,l=0;a=n[l++];)if("JsCode"===a.type)i.push(a.object.value);else if(s=e.at("astgen-node-tag",a,r))i.push(` ${o}.push( ${s} ); `);else if(s=e.at("astgen-node-text",a,r))i.push(` ${o}.push( ${s} ); `);else if("Attributes"===a.type||"Events"===a.type||"ObjectExpressionAttributes"===a.type);else if("Class"!==a.type&&"Style"!==a.type)throw new t("unhandle node type: "+a.type);return i.push(` return ${o}; `),i.push(" })([]) "),i.join("\n")}(n,r):function(t=[],o){let n,r=[];return t.forEach(t=>{(n=e.at("astgen-node-tag",t,o))&&r.push(n),(n=e.at("astgen-node-text",t,o))&&r.push(n)}),"["+r.join(",\n")+"]"}(n,r):""}e.on("astgen-node-tag-nodes",n)})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/file"),n=require("@gotoeasy/csjs");require("@gotoeasy/err");e.on("编译插件",t.plugin("s15p-component-ast-jsify-writer",function(e,t){t.writer=new class{constructor(){this.ary=[]}push(e){void 0!==e&&this.ary.push(e)}write(e){void 0!==e&&this.ary.push(e)}out(e){o.write(e,this.toString())}getArray(){return this.ary}toString(){let e=this.ary.join("\n");try{return n.formatJs(e)}catch(t){throw o.write(process.cwd()+"/build/error/format-error.js",e),t}}}}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=(require("@gotoeasy/file"),require("@gotoeasy/csjs"),require("@gotoeasy/err")),n="v_Array";e.on("编译插件",t.plugin("s25p-component-ast-jsify-root",function(t,r){let s=r.writer,i=r.script;t.walk("View",(t,a)=>!t.nodes||t.nodes.length<1?s.write("// 没有节点，无可生成"):(s.write("function nodeTemplate($state, $options, $actions, $this) {"),function(e){for(let t,o=0;t=e[o++];)if("JsCode"===t.type)return!0;return!1}(t.nodes)?s.write(`${function(t=[],r){let s,i=[];i.push(` let ${n} = []; `);for(let a,l=0;a=t[l++];)if("JsCode"===a.type)i.push(a.object.value);else if(s=e.at("astgen-node-tag",a,r))i.push(` ${n}.push( ${s} ); `);else{if(!(s=e.at("astgen-node-text",a,r)))throw new o("unhandle node type");i.push(` ${n}.push( ${s} ); `)}return i.push(` ${n}.length > 1 && console.warn("invlid tag count"); `),i.push(` return ${n}.length ? v_Array[0] : null; `),i.join("\n")}(t.nodes,r)}`):s.write(`${function(t=[],n){if(t.length>1){let e=n.input.text,r=n.input.file,s=t[1].object.loc.start.pos;throw"Tag"!==t[0].type&&(s=t[0].object.loc.start.pos),new o("invalid top tag",{text:e,file:r,start:s})}let r,s=t[0];if("Tag"!==s.type){let e=n.input.text,r=n.input.file,s=t[0].object.loc.start.pos;throw new o("missing top tag",{text:e,file:r,start:s})}if(r=e.at("astgen-node-tag",s,n))return`return ${r}`;if(r=e.at("astgen-node-text",s,n))return`return ${r}`;throw new o("unhandle node type")}(t.nodes,r)}`),s.write("}"),i.vnodeTemplate=s.toString(),!1))}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/csjs"),o=require("@gotoeasy/file"),n=require("@gotoeasy/postobject"),r=require("@gotoeasy/err"),s=require("acorn-globals"),i="$$,require,window,location,clearInterval,setInterval,assignOptions,rpose,$SLOT,Object,Map,Set,WeakMap,WeakSet,Date,Math,Array,String,Number,JSON,Error,Function,arguments,Boolean,Promise,Proxy,Reflect,RegExp,alert,console,window,document".split(",");e.on("编译插件",n.plugin("s35p-component-gen-js",function(n,a){let l=e.at("编译环境"),u=a.result,c=a.script,p=(a.writer,e.at("编译模板JS")),f={};if(f.COMPONENT_NAME=e.at("组件类名",a.input.file),f.options=a.doc.options||"{}",f.state=a.doc.state||"{}",a.doc.api&&(f.optionkeys=a.doc.api.optionkeys,f.statekeys=a.doc.api.statekeys),f.actions=c.actions,f.methods=c.methods,f.updater=c.updater,f.vnodeTemplate=c.vnodeTemplate,u.componentJs=p(f),u.componentJs=function(e,t){let o,n=t.doc.api.optionkeys||[],a=t.doc.api.statekeys||[];try{if(!(o=s(e)).length)return e}catch(o){throw r.cat("source syntax error","\n-----------------",e,"\n-----------------","file="+t.input.file,o)}let l=[];for(let e,s=0;s<o.length;s++){e=o[s];let u=n.includes(e.name),c=a.includes(e.name),p=i.includes(e.name);if(!u&&!c&&!p){let o="template variable undefined: "+e.name;throw o+="\n  file: "+t.input.file,new r(o)}if(u&&c){let o="template variable uncertainty: "+e.name;throw o+="\n  file: "+t.input.file,new r(o)}c?l.push(`let ${e.name} = $state.${e.name};`):u&&l.push(`let ${e.name} = $options.${e.name};`)}return e.replace(/(\n.+?prototype\.nodeTemplate\s*=\s*function\s+.+?\r?\n)/,"$1"+l.join("\n"))}(u.componentJs,a),!l.release){let n=l.path.build_temp+"/"+e.at("组件目标文件名",a.input.file)+".js";o.write(n,t.formatJs(u.componentJs))}}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject"),o=require("@gotoeasy/file");require("@gotoeasy/csjs"),require("@gotoeasy/err");e.on("编译插件",t.plugin("s45p-component-gen-css",function(t,n){let r=n.style,s=[];r.csslibset&&s.push(...r.csslibset),r.less&&s.push(r.less),r.scss&&s.push(r.scss),r.css&&s.push(r.css),n.result.css=e.at("组件样式类名哈希化",n.input.file,s.join("\n"));let i=e.at("编译环境"),a=i.path.build_temp+"/"+e.at("组件目标文件名",n.input.file)+".css";i.release||(n.result.css?o.write(a,n.result.css):o.remove(a))}))})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/file"),require("@gotoeasy/postobject"));require("@gotoeasy/err");e.on("编译插件",t.plugin("w15p-component-complie-result-cache",function(t,o){e.at("组件编译缓存",o.input.file,o)}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("y15p-page-all-reference-components",function(t,o){if(!o.result.isPage)return!1;let n=new Set,r={};if(o.result.references.forEach(t=>{!function t(o,n,r){if(r[o])return;n.add(o),r[o]=!0;let s=e.at("标签源文件",o),i=e.at("组件编译缓存",s);i||(i=e.at("编译组件",s));let a=i.result.references;a.forEach(e=>{t(e,n,r)})}(t,n,r)}),n.has(o.result.tagpkg))throw new Err("circular reference: "+o.result.tagpkg);let s=[...n];s.sort(),s.push(o.result.tagpkg),o.result.allreferences=s}))})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/file")),o=require("@gotoeasy/postobject");require("@gotoeasy/err");e.on("编译插件",o.plugin("y25p-page-gen-html",function(o,n){if(!n.result.isPage)return!1;let r=e.at("编译环境"),s=r.path.src,i=n.input.file,a=t.name(i),l=n.doc.api.prerender;n.result.html=require(r.prerender)({srcPath:s,file:i,name:a,type:l})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/csjs"),o=require("postcss");e.on("页面样式后处理",(n,r)=>{let s,i=e.at("编译环境"),a=e.at("缓存"),l=a.path+"/from.css",u=e.at("页面目标CSS文件名",r),c=[],p=a.path+"/resources",f=e.at("页面图片相对路径",r),g={url:"copy",basePath:p,assetsPath:f,useHash:!1},d=JSON.stringify(["页面样式后处理",e.at("browserslist"),i.release,f,n]);if(!i.nocache){let e=a.get(d);if(e)return e.indexOf("url(")>0&&(c.push(require("postcss-url")(g)),o(c).process(e,{from:l,to:u}).sync().root.toResult()),e}c.push(require("postcss-discard-comments")({remove:e=>1})),c.push(require("postcss-normalize-whitespace")),c.push(require("postcss-discard-empty")),c.push(require("postcss-discard-duplicates")),c.push(require("autoprefixer")()),c.push(require("postcss-url")(g)),c.push(require("postcss-merge-rules")());let h=o(c).process(n,{from:l,to:u}).sync().root.toResult();return s=i.release?h.css:t.formatCss(h.css),a.set(d,s)})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("y35p-page-gen-css-link-components",function(t,o){if(!o.result.isPage)return!1;e.at("编译环境");let n=[];o.result.allreferences.forEach(t=>{let o=e.at("组件编译缓存",e.at("标签源文件",t));o||(o=e.at("编译组件",t)),o.result.css&&n.push(o.result.css)}),o.result.css=n.join("\n"),o.result.pageCss=e.at("页面样式后处理",o.result.css,o.input.file)}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/file"),o=require("resolve-pkg");e.on("RPOSE运行时代码",function(e){return function(){if(!e){let n=t.resolve(o("@rpose/runtime",{cwd:__dirname}),"runtime.js");e=t.read(n)}return e}}())})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/file"),o=require("@gotoeasy/postobject"),n=require("@gotoeasy/err"),r=require("fs");e.on("编译插件",o.plugin("y55p-page-gen-js-link-runtime-components",function(o,s){if(!s.result.isPage)return!1;let i=e.at("编译环境"),a=s.result.allreferences,l=e.at("RPOSE运行时代码"),u=function(o){try{let r={};for(let s,i,a,l=0;s=o[l++];){if(i="'"+s+"'",a=e.at("标签源文件",s),!t.exists(a))throw new n("component not found (tag = "+s+")");r[i]=e.at("组件类名",a)}return`rpose.registerComponents(${JSON.stringify(r).replace(/"/g,"")});`}catch(e){throw n.cat(MODULE+"gen register stmt failed",o,e)}}(a),c=function(t){try{let o=[];for(let n,r,s=0;n=t[s++];)(r=e.at("组件编译缓存",e.at("标签源文件",n)))||(r=e.at("编译组件",n)),o.push(r.result.componentJs);return o.join("\n")}catch(e){throw n.cat(MODULE+"get component src failed",t,e)}}(a),p=e.at("缓存").path+"/resources",f=e.at("页面图片相对路径",s.input.file),g=`\n                ${l}\n\n                (function($$){\n                    // 组件注册\n                    ${u}\n\n                    ${c=c.replace(/\%imagepath\%([0-9a-z]+\.[0-9a-zA-Z]+)/g,function(e,o){let n=p+"/"+o,s=i.path.build_dist+"/"+(i.path.build_dist_images?i.path.build_dist_images+"/":"")+o;return t.existsFile(n)&&!t.existsFile(s)&&(t.mkdir(s),r.copyFileSync(n,s)),f+o})}\n\n                    // 组件挂载\n                    rpose.mount( rpose.newComponentProxy('${s.result.tagpkg}').render(), '${s.doc.mount}' );\n                })(rpose.$$);\n            `;s.result.pageJs=g}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/csjs"),o=require("@gotoeasy/file"),n=require("@gotoeasy/postobject");e.on("编译插件",n.plugin("y65p-page-gen-js-babel",function(n,r){if(!r.result.isPage)return!1;let s=e.at("编译环境"),i=e.at("缓存"),a=JSON.stringify(["page-gen-js-babel",e.at("browserslist"),r.result.pageJs]);if(!s.nocache){let e=i.get(a);if(e)return r.result.babelJs=e}try{r.result.babelJs=t.babel(r.result.pageJs),i.set(a,r.result.babelJs)}catch(e){throw o.write(s.path.build+"/error/babel.log",r.result.pageJs+"\n\n"+e.stack),e}}))})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/csjs"),o=require("@gotoeasy/file"),n=require("@gotoeasy/postobject");e.on("编译插件",n.plugin("y75p-page-gen-js-browserify-minformat",function(n,r){if(!r.result.isPage)return!1;let s=e.at("编译环境"),i=e.at("缓存"),a=JSON.stringify(["page-gen-js-browserify-minformat",e.at("browserslist"),s.release,r.result.babelJs]);if(!s.nocache){let e=i.get(a);if(e)return r.result.browserifyJs=Promise.resolve(e)}r.result.browserifyJs=new Promise((e,n)=>{(new Date).getTime(),t.browserify(r.result.babelJs,null).then(o=>{o=s.release?t.miniJs(o):t.formatJs(o),i.set(a,o),e(o)}).catch(e=>{o.write(s.path.build+"/error/browserify.log",r.result.babelJs+"\n\n"+e.stack),n(e)})})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/hash")),o=require("@gotoeasy/file"),n=require("@gotoeasy/postobject");require("@gotoeasy/err"),require("fs");e.on("编译插件",n.plugin("y85p-write-page",function(n,r){if(!r.result.isPage)return!1;let s,i=e.at("编译环境"),a=(e.at("browserslist"),(new Date).getTime());r.result.browserifyJs.then(n=>{let l=e.at("页面目标HTML文件名",r.input.file),u=e.at("页面目标CSS文件名",r.input.file),c=e.at("页面目标JS文件名",r.input.file),p=r.result.html,f=r.result.pageCss,g=n;r.result.js=g,o.write(u,f),o.write(c,g),o.write(l,p),i.watch&&(r.result.hashcode=t(p+f+g)),s=(new Date).getTime()-a,console.info("[pack]",s+"ms -",l.substring(i.path.build_dist.length+1))}).catch(e=>{console.error("[pack]",e)})}))})(),(()=>{const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/csjs"),require("@gotoeasy/file"),require("@gotoeasy/postobject"),require("@gotoeasy/err"),require("@gotoeasy/hash")),o=require("browserslist");e.on("browserslist",function(){let e=o();return t(e.join("\n"))})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/hash");e.on("哈希样式类名",function(o,n){let r=n;if(r.startsWith("_"))return r;const s=e.at("编译环境");if(n.indexOf("@")>0){let e=n.split("@");r=`${e[1]}---${e[0]}`}else if(r.indexOf("---")>0||r.indexOf("___")>0||r.startsWith("_"));else{let s=e.at("标签全名",o);r=`${n}___${t(s)}`}return s.release?"_"+t(r.toLowerCase()):r})})(),(()=>{require("@gotoeasy/err");const e=require("@gotoeasy/bus"),t=(require("@gotoeasy/hash"),require("postcss")),o=require("css-selector-tokenizer");e.on("组件样式类名哈希化",function(n,r){return t([(t,r)=>{t.walkRules(t=>{let r=o.parse(t.selector);(r.nodes||[]).forEach(t=>{"selector"===t.type&&(t.nodes||[]).forEach(t=>{"class"===t.type&&(t.name=e.at("哈希样式类名",n,t.name))})}),t.selector=o.stringify(r)})}]).process(r,{from:"from.css"}).sync().root.toResult().css})})(),(()=>{const e=require("@gotoeasy/file"),t=require("@gotoeasy/bus"),o=require("@gotoeasy/npm"),n=(require("@gotoeasy/hash"),require("find-node-modules"));t.on("标签全名",t=>{let o=t.indexOf(":");if(o>0&&t.substring(o).indexOf(".")<0)return t;let n="";if((o=t.lastIndexOf("/node_modules/"))>0){let r=t.substring(o+14).split("/");n=r[0].startsWith("@")?r[0]+"/"+r[1]+":"+e.name(t):r[0]+":"+e.name(t)}else n=e.name(t);return n}),t.on("标签源文件",e=>{if(e.endsWith(".rpose"))return e;if(e.indexOf(":")>0){let o=e.split(":");o[0].indexOf("=")>0&&(o=o[0].split("="));let n=t.at("模块组件信息",o[0].trim()),r=n.files,s="/"+o[1]+".rpose";for(let e,t=0;e=r[t++];)if(e.endsWith(s))return e;return t.at("标签库引用",e,n.config)}{let o=t.at("标签项目源文件",e);if(o)return o;let n=t.at("编译环境");return t.at("标签库引用",e,n.path.root)}}),t.on("文件所在模块",e=>{let t="/",o=e.lastIndexOf("/node_modules/");if(o>0){let n=e.substring(o+14).split("/");t=n[0].startsWith("@")?n[0]+"/"+n[1]:n[0]}return t}),t.on("文件所在项目根目录",e=>{let o,n=e.lastIndexOf("/node_modules/");if(n>0){let t=[];t.push(e.substring(0,n+13));let r=e.substring(n+14).split("/");r[0].startsWith("@")?(t.push(r[0]),t.push(r[1])):t.push(r[0]),o=t.join("/")}else o=t.at("编译环境").path.root;return o}),t.on("文件所在项目配置文件",o=>{let n,r=o.lastIndexOf("/node_modules/");if(r>0){let e=[];e.push(o.substring(0,r+13));let t=o.substring(r+14).split("/");t[0].startsWith("@")?(e.push(t[0]),e.push(t[1])):e.push(t[0]),e.push("rpose.config.btf"),n=e.join("/")}else n=t.at("编译环境").path.root+"/rpose.config.btf";if(e.existsFile(n))return n}),t.on("模块组件信息",function(o=new Map){return function(r){if(r.indexOf(":")>0&&(r=r.substring(0,r.indexOf(":"))),r.lastIndexOf("@")>0&&(r=r.substring(0,r.lastIndexOf("@"))),r=r.toLowerCase(),!o.has(r)){let s=t.at("编译环境"),i=[...n({cwd:s.path.root,relative:!1}),...n({cwd:__dirname,relative:!1})];for(let t,n,s=0;t=i[s++];)if(n=e.resolve(t,r).replace(/\\/g,"/"),e.existsDir(n)){let t=JSON.parse(e.read(e.resolve(n,"package.json"))),r=t.version,s=t.name,i=s+"@"+r,a=e.files(n,"/src/**.rpose"),l=e.resolve(n,"rpose.config.btf");o.set(s,{path:n,pkg:i,name:s,version:r,files:a,config:l});break}}return o.get(r)||{files:[],config:""}}}()),t.on("组件类名",e=>{let o=t.at("标签全名",t.at("标签源文件",e));return o=("-"+(o=o.replace(/[@\/`]/g,"$").replace(/\./g,"_").replace(":","$-"))).split("-").map(e=>e.substring(0,1).toUpperCase()+e.substring(1)).join("")}),t.on("组件目标文件名",function(o){let n=t.at("编译环境");return o.startsWith(n.path.src_buildin)?"$buildin/"+e.name(o):t.at("标签全名",o).replace(":","/")}),t.on("页面目标JS文件名",function(e){let o=t.at("编译环境");return o.path.build_dist+e.substring(o.path.src.length,e.length-6)+".js"}),t.on("页面目标CSS文件名",function(e){let o=t.at("编译环境");return o.path.build_dist+e.substring(o.path.src.length,e.length-6)+".css"}),t.on("页面目标HTML文件名",function(e){let o=t.at("编译环境");return o.path.build_dist+e.substring(o.path.src.length,e.length-6)+".html"}),t.on("自动安装",function(e={}){return function(t){return t.indexOf(":")>0&&(t=t.substring(0,t.indexOf(":"))),t.lastIndexOf("@")>0&&(t=t.substring(0,t.lastIndexOf("@"))),e[t]||(o.isInstalled(t)?e[t]=!0:e[t]=o.install(t,{timeout:6e4})),e[t]}}()),t.on("页面图片相对路径",e=>{let o=t.at("编译环境"),n=e.substring(o.path.src.length).split("/");return("../".repeat(n.length-2)+o.path.build_dist_images||".")+"/"})})(),(()=>{const e=require("@gotoeasy/bus"),t=require("@gotoeasy/postobject");e.on("编译插件",t.plugin("z99p-log",function(e,t){}))})(),console.timeEnd("load");const bus=require("@gotoeasy/bus"),npm=require("@gotoeasy/npm"),Err=require("@gotoeasy/err"),File=require("@gotoeasy/file"),postobject=require("@gotoeasy/postobject");async function build(e){console.time("build");try{bus.at("编译环境",e);bus.at("clean"),await Promise.all(bus.at("全部编译"))}catch(e){console.error(Err.cat("build failed",e).toString())}console.timeEnd("build")}function clean(e){console.time("clean");try{bus.at("编译环境",e);bus.at("clean")}catch(e){console.error(Err.cat("clean failed",e).toString())}console.timeEnd("clean")}async function watch(e){await build(e),bus.at("文件监视")}module.exports={build,clean,watch};